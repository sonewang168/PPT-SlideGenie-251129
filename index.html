<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SlideGenie Pro | AI ç°¡å ±ç”¢ç”Ÿå™¨</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#030614">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root{--bg-primary:#030614;--bg-secondary:#0a1628;--bg-card:#0d1f3c;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;--cyan:#00f5ff;--purple:#a855f7;--pink:#ec4899;--green:#10b981;--orange:#f59e0b;--red:#ef4444;--border:rgba(0,245,255,0.15);--glow-cyan:0 0 20px rgba(0,245,255,0.4);--grad-cyan:linear-gradient(135deg,#00f5ff,#0891b2);--grad-purple:linear-gradient(135deg,#a855f7,#6366f1);--grad-green:linear-gradient(135deg,#10b981,#059669);--grad-orange:linear-gradient(135deg,#f59e0b,#ea580c);--grad-pink:linear-gradient(135deg,#ec4899,#be185d)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;min-height:100dvh;font-size:14px}
.bg-grid{position:fixed;inset:0;background-image:linear-gradient(rgba(0,245,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.03) 1px,transparent 1px);background-size:50px 50px;pointer-events:none}
.bg-glow{position:fixed;width:400px;height:400px;border-radius:50%;filter:blur(100px);opacity:0.1;pointer-events:none}.bg-glow-1{top:-150px;right:-150px;background:var(--cyan)}.bg-glow-2{bottom:-150px;left:-150px;background:var(--purple)}

.splash{position:fixed;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:all 0.8s}.splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.splash-logo{width:100px;height:100px;position:relative;margin-bottom:24px}
.splash-logo-inner{width:100%;height:100%;background:var(--bg-card);border:2px solid var(--cyan);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:48px;animation:logoSpin 2s ease-in-out;box-shadow:0 0 30px rgba(0,245,255,0.5)}
@keyframes logoSpin{0%{transform:rotateY(0) scale(0.3);opacity:0}50%{transform:rotateY(180deg) scale(1.1)}100%{transform:rotateY(360deg) scale(1)}}
.splash-ring{position:absolute;border:2px solid transparent;border-radius:50%;animation:ring linear infinite}.splash-ring:nth-child(1){width:130px;height:130px;top:-15px;left:-15px;border-top-color:var(--cyan);animation-duration:3s}.splash-ring:nth-child(2){width:150px;height:150px;top:-25px;left:-25px;border-top-color:var(--purple);animation-duration:4s;animation-direction:reverse}
@keyframes ring{to{transform:rotate(360deg)}}
.splash-text{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;background:var(--grad-cyan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fadeUp 0.6s ease forwards 0.8s}
.splash-sub{font-size:11px;color:var(--text-muted);margin-top:6px;opacity:0;animation:fadeUp 0.6s ease forwards 1.2s}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}from{opacity:0;transform:translateY(12px)}}
.splash-dots{display:flex;gap:8px;margin-top:32px;opacity:0;animation:fadeUp 0.6s ease forwards 1.6s}
.splash-dots span{width:8px;height:8px;background:var(--cyan);border-radius:50%;animation:pulse 1.2s ease-in-out infinite}.splash-dots span:nth-child(2){animation-delay:0.2s;background:var(--purple)}.splash-dots span:nth-child(3){animation-delay:0.4s;background:var(--pink)}
@keyframes pulse{0%,80%,100%{transform:scale(0.6)}40%{transform:scale(1.2)}}

.app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh;min-height:100dvh;opacity:0;transition:opacity 0.6s}.app.show{opacity:1}
.header{padding:10px 12px;background:rgba(10,22,40,0.9);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:8px}
.logo-icon{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--cyan);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:var(--glow-cyan)}
.logo-text{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;background:var(--grad-cyan);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-btns{display:flex;gap:6px}
.h-btn{width:36px;height:36px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--cyan);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}.h-btn:active{transform:scale(0.95)}

.main{flex:1;padding:12px;padding-bottom:130px;overflow-y:auto}
.sec{margin-bottom:14px}
.sec-title{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;display:flex;align-items:center;gap:6px;letter-spacing:1.5px;text-transform:uppercase}
.sec-title::before{content:'';width:2px;height:10px;background:var(--grad-cyan);border-radius:2px}
.card{background:rgba(13,31,60,0.5);backdrop-filter:blur(8px);border-radius:12px;padding:12px;border:1px solid var(--border)}
.inp{width:100%;padding:10px 12px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit;outline:none}.inp:focus{border-color:var(--cyan)}
.inp::placeholder{color:var(--text-muted)}
textarea.inp{min-height:60px;resize:none;line-height:1.4}
.inp-label{font-size:10px;color:var(--text-secondary);margin:10px 0 5px;display:block}

/* API Key å€å¡Š */
.api-sec{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:14px}
.api-label{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;letter-spacing:1px}
.api-row{display:flex;gap:6px}
.api-inp{flex:1;padding:10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:12px;font-family:monospace}
.api-btn{padding:10px 14px;background:var(--grad-cyan);border:none;border-radius:8px;color:#030614;font-size:10px;font-weight:700;font-family:'Orbitron',sans-serif;cursor:pointer;white-space:nowrap}
.api-btn:disabled{opacity:0.5}
.api-stat{margin-top:8px;padding:8px 10px;border-radius:8px;font-size:11px;display:none}
.api-stat.on{display:flex;align-items:center;gap:6px}
.api-stat.ok{background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
.api-stat.err{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
.api-stat.wait{background:rgba(0,245,255,0.1);color:var(--cyan);border:1px solid rgba(0,245,255,0.3)}
.api-hint{font-size:10px;color:var(--text-muted);margin-top:6px}.api-hint a{color:var(--cyan)}

.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:6px 10px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:16px;color:var(--text-secondary);font-size:11px;cursor:pointer}
.chip.on{border-color:var(--cyan);color:#fff;background:var(--grad-cyan);box-shadow:var(--glow-cyan)}

.slider-row{display:flex;align-items:center;gap:12px}
.slider{flex:1;-webkit-appearance:none;height:5px;background:rgba(0,245,255,0.1);border-radius:3px}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--grad-cyan);border-radius:50%;box-shadow:var(--glow-cyan)}
.slider-val{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:600;color:var(--cyan);min-width:40px;text-align:center}
.slider-info{font-size:10px;color:var(--text-muted);margin-top:6px;text-align:center}

.style-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.style-card{padding:8px 4px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:8px;text-align:center;cursor:pointer}
.style-card.on{border-color:var(--cyan);background:rgba(0,245,255,0.08);box-shadow:var(--glow-cyan)}
.style-icon{font-size:20px;margin-bottom:2px}
.style-name{font-size:9px}

.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.theme-card{aspect-ratio:16/10;border-radius:8px;cursor:pointer;border:2px solid transparent;position:relative;overflow:hidden}
.theme-card.on{border-color:var(--cyan);box-shadow:var(--glow-cyan)}
.theme-card::after{content:attr(data-name);position:absolute;bottom:0;left:0;right:0;padding:3px;background:rgba(0,0,0,0.6);font-size:8px;text-align:center;color:#fff}

.output-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.out-card{padding:12px 8px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;text-align:center;cursor:pointer}
.out-card.on{border-color:var(--cyan);box-shadow:var(--glow-cyan)}
.out-card[data-v="canva"].on{border-color:var(--purple);box-shadow:0 0 20px rgba(168,85,247,0.4)}
.out-card[data-v="html"].on{border-color:var(--green);box-shadow:0 0 20px rgba(16,185,129,0.4)}
.out-icon{font-size:24px;margin-bottom:4px}
.out-name{font-size:11px;font-weight:600}
.out-desc{font-size:9px;color:var(--text-muted);margin-top:2px}

.gen-sec{padding:12px;background:rgba(10,22,40,0.95);backdrop-filter:blur(16px);border-top:1px solid var(--border);position:fixed;bottom:0;left:0;right:0}
.gen-btn{width:100%;padding:14px;background:var(--grad-cyan);border:none;border-radius:10px;color:#030614;font-size:14px;font-weight:700;font-family:'Orbitron',sans-serif;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:var(--glow-cyan)}
.gen-btn:active{transform:scale(0.98)}
.gen-btn:disabled{opacity:0.5}
.gen-btn.canva{background:var(--grad-purple);box-shadow:0 0 20px rgba(168,85,247,0.4)}
.gen-btn.html{background:var(--grad-green);box-shadow:0 0 20px rgba(16,185,129,0.4)}
.spinner{width:18px;height:18px;border:2px solid rgba(3,6,20,0.3);border-top-color:#030614;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.prog{margin-top:10px;display:none}.prog.on{display:block}
.prog-bar{height:4px;background:rgba(0,245,255,0.1);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--grad-cyan);width:0%;transition:width 0.3s}
.prog-txt{font-size:11px;color:var(--cyan);margin-top:6px;text-align:center}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(3,6,20,0.92);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:flex-end;opacity:0;visibility:hidden;transition:all 0.3s}.modal-bg.on{opacity:1;visibility:visible}
.modal{width:100%;max-height:90vh;max-height:90dvh;background:var(--bg-secondary);border-radius:16px 16px 0 0;border:1px solid var(--border);border-bottom:none;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.35s}.modal-bg.on .modal{transform:translateY(0)}
.modal-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(13,31,60,0.4)}
.modal-title{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--cyan);letter-spacing:1px}
.modal-x{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-size:14px;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:14px}
.modal-foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;background:rgba(13,31,60,0.4);flex-wrap:wrap}
.m-btn{flex:1;padding:12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:5px;min-width:80px}
.m-btn-sec{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)}
.m-btn-pri{background:var(--grad-cyan);border:none;color:#030614}
.m-btn-orange{background:var(--grad-orange);border:none;color:#fff}
.m-btn-purple{background:var(--grad-purple);border:none;color:#fff}

/* è¨­å®š */
.set-sec{margin-bottom:20px}
.set-label{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;letter-spacing:1px}
.model-custom{margin-top:10px}
.model-custom-row{display:flex;gap:6px;margin-top:6px}
.model-custom-inp{flex:1;padding:8px 10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:11px;font-family:monospace}
.model-custom-btn{padding:8px 12px;background:var(--grad-purple);border:none;border-radius:6px;color:#fff;font-size:10px;font-weight:600;cursor:pointer}
.model-hint{font-size:9px;color:var(--text-muted);margin-top:6px}

/* é è¦½ */
.slides-list{display:flex;flex-direction:column;gap:10px}
.slide-card{background:rgba(13,31,60,0.5);border-radius:10px;border:1px solid var(--border);overflow:hidden}
.slide-head{padding:8px 12px;background:rgba(3,6,20,0.4);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.slide-num{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--cyan)}
.slide-type{font-size:9px;color:var(--text-muted);padding:2px 8px;background:rgba(0,245,255,0.1);border-radius:10px}
.slide-actions{display:flex;gap:4px}
.slide-action{width:26px;height:26px;background:var(--bg-card);border:1px solid var(--border);border-radius:5px;color:var(--text-secondary);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.slide-body{padding:12px}
.slide-title{font-size:14px;font-weight:600;margin-bottom:8px}
.slide-content{font-size:12px;color:var(--text-secondary);line-height:1.5}
.slide-content ul{margin:6px 0;padding-left:16px}
.slide-content li{margin-bottom:4px}
.slide-content li::marker{color:var(--cyan)}
.slide-notes{margin-top:10px;padding-top:10px;border-top:1px dashed var(--border);font-size:10px;color:var(--text-muted);font-style:italic}
.slide-img{margin-top:8px;padding:6px 10px;background:rgba(168,85,247,0.1);border-radius:6px;font-size:10px;color:var(--purple)}

/* å¤§ç¶± */
.outline-card{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.outline-title{font-size:13px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.outline-list{font-size:12px;color:var(--text-secondary);line-height:1.6}
.outline-item{padding:5px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.outline-item:last-child{border-bottom:none}
.outline-num{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);min-width:20px}

/* Canva */
.canva-modal .modal{background:var(--bg-primary)}
.copy-card{background:rgba(13,31,60,0.6);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.copy-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.copy-page{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--purple)}
.copy-progress{font-size:11px;color:var(--text-muted)}
.copy-type{display:inline-block;padding:3px 10px;background:rgba(168,85,247,0.2);color:var(--purple);border-radius:10px;font-size:10px;margin-bottom:10px}
.copy-title{font-size:15px;font-weight:600;margin-bottom:10px;line-height:1.3}
.copy-content{font-size:12px;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap}
.copy-notes{margin-top:10px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;color:var(--text-muted)}
.copy-img{margin-top:8px;padding:6px 10px;background:rgba(168,85,247,0.15);border-radius:6px;font-size:10px;color:var(--purple)}
.copy-btn{width:100%;padding:14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;border:none;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px}
.copy-btn:active{transform:scale(0.97)}
.copy-btn.copy{background:var(--grad-purple);color:#fff}
.copy-btn.copy.done{background:var(--grad-green)}
.copy-nav{display:flex;gap:8px}
.copy-nav .copy-btn{flex:1;padding:12px;margin:0}
.copy-btn.nav{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)}
.copy-dots{display:flex;justify-content:center;gap:5px;margin:12px 0;flex-wrap:wrap}
.copy-dot{width:7px;height:7px;border-radius:50%;background:rgba(168,85,247,0.3);cursor:pointer}
.copy-dot.on{background:var(--purple);box-shadow:0 0 6px var(--purple)}
.copy-dot.done{background:var(--green)}
.copy-actions{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.copy-all-btn{width:100%;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:12px;cursor:pointer;margin-bottom:8px}
.canva-link{display:block;width:100%;padding:12px;background:var(--grad-purple);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:600;text-align:center;text-decoration:none}

/* HTML æ’­æ”¾ */
.html-modal .modal-body{padding:0}
.slideshow-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden}
.slideshow{position:absolute;inset:0;overflow:hidden}
.ss-slide{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6%;opacity:0;pointer-events:none}
.ss-slide.on{opacity:1;pointer-events:auto}
.ss-title{font-size:clamp(20px,4.5vw,48px);font-weight:700;text-align:center;margin-bottom:3%}
.ss-subtitle{font-size:clamp(12px,2.2vw,24px);opacity:0.75;margin-bottom:3%;text-align:center}
.ss-content{width:100%;max-width:85%}
.ss-item{font-size:clamp(12px,2.2vw,22px);padding:10px 0;opacity:0;border-bottom:1px solid rgba(255,255,255,0.1)}
.ss-item:last-child{border-bottom:none}
.ss-num{position:absolute;bottom:2%;right:3%;font-size:clamp(9px,1.3vw,12px);opacity:0.4}
.ss-hint{position:absolute;bottom:2%;left:50%;transform:translateX(-50%);font-size:clamp(8px,1vw,10px);opacity:0.2}
.ss-anim-name{position:absolute;top:2%;right:3%;font-size:9px;opacity:0.3;font-family:'Orbitron',sans-serif}
.ss-controls{display:flex;justify-content:center;align-items:center;gap:8px;padding:12px;flex-wrap:wrap}
.ss-btn{padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;cursor:pointer}
.ss-btn.pri{background:var(--grad-green);border:none;color:#030614;font-weight:600}
.ss-counter{padding:8px 14px;font-family:'Orbitron',sans-serif;font-size:11px;color:var(--green)}
.ss-next-hint{text-align:center;padding:4px;font-size:10px;color:var(--text-muted)}
.slideshow:fullscreen,.slideshow:-webkit-full-screen{width:100vw!important;height:100vh!important}

/* ç·¨è¼¯ */
.edit-field{margin-bottom:14px}
.edit-label{font-size:10px;color:var(--text-secondary);margin-bottom:5px;display:block}
.edit-inp{width:100%;padding:10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px;font-family:inherit}
textarea.edit-inp{min-height:100px;resize:none;line-height:1.4}

/* æ­·å² */
.hist-list{display:flex;flex-direction:column;gap:8px}
.hist-item{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;justify-content:space-between;align-items:center}
.hist-info{flex:1}
.hist-title{font-size:13px;font-weight:500;margin-bottom:3px}
.hist-meta{font-size:10px;color:var(--text-muted)}
.hist-btns{display:flex;gap:6px}
.hist-btn{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px}
.empty{text-align:center;padding:30px;color:var(--text-muted)}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3}

.toast-box{position:fixed;top:60px;left:12px;right:12px;z-index:2000;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{padding:12px 14px;background:rgba(13,31,60,0.95);backdrop-filter:blur(8px);border-radius:10px;display:flex;align-items:center;gap:8px;font-size:12px;animation:toastIn 0.3s;pointer-events:auto;border:1px solid var(--border)}
.toast.ok{border-left:3px solid #22c55e}
.toast.err{border-left:3px solid #ef4444}
.toast.warn{border-left:3px solid #f59e0b}
@keyframes toastIn{from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1}}

@media(min-width:640px){
.main{max-width:520px;margin:0 auto}
.gen-sec{max-width:520px;left:50%;transform:translateX(-50%);border-radius:16px 16px 0 0}
.modal{max-width:560px;margin:0 auto;border-radius:16px;max-height:85vh;border:1px solid var(--border)}
.modal-bg{align-items:center;padding:16px}
.html-modal .modal{max-width:850px}
}
    </style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow bg-glow-1"></div>
<div class="bg-glow bg-glow-2"></div>

<div class="splash" id="splash">
    <div class="splash-logo">
        <div class="splash-ring"></div>
        <div class="splash-ring"></div>
        <div class="splash-logo-inner">ğŸ“Š</div>
    </div>
    <div class="splash-text">SLIDEGENIE PRO</div>
    <div class="splash-sub">âœ¨ AI ç°¡å ±ç”¢ç”Ÿå™¨ âœ¨</div>
    <div class="splash-dots"><span></span><span></span><span></span></div>
</div>

<div class="app" id="app">
    <header class="header">
        <div class="logo"><div class="logo-icon">ğŸ“Š</div><div class="logo-text">SLIDEGENIE</div></div>
        <div class="header-btns"><button class="h-btn" onclick="openHist()">ğŸ“‹</button><button class="h-btn" onclick="openSet()">âš™ï¸</button></div>
    </header>

    <main class="main">
        <!-- API Key -->
        <div class="api-sec">
            <div class="api-label">ğŸ”‘ GEMINI API KEY</div>
            <div class="api-row">
                <input type="password" class="api-inp" id="apiInp" placeholder="è²¼ä¸Š API Key...">
                <button class="api-btn" id="verifyBtn" onclick="verifyKey()">é©—è­‰</button>
                <button class="api-btn" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)" onclick="clearKey()">âœ•</button>
            </div>
            <div class="api-stat" id="apiStat"></div>
            <p class="api-hint">ğŸ‘‰ <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> å…è²»å–å¾— Â· ğŸ”’ ä¸å„²å­˜</p>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“ ä¸»é¡Œ</div>
            <div class="card">
                <input type="text" class="inp" id="topicInp" placeholder="ä¾‹å¦‚ï¼šç‰›é “é‹å‹•å®šå¾‹">
                <label class="inp-label">ğŸ’¬ è£œå……èªªæ˜</label>
                <textarea class="inp" id="detailInp" placeholder="é‡é»ã€éœ€æ±‚..."></textarea>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ‘¥ å°è±¡</div>
            <div class="chips" id="audChips">
                <div class="chip" data-v="elementary">ğŸ‘¶ åœ‹å°</div>
                <div class="chip on" data-v="junior">ğŸ’ åœ‹ä¸­</div>
                <div class="chip" data-v="senior">ğŸ“š é«˜ä¸­</div>
                <div class="chip" data-v="college">ğŸ“ å¤§å­¸</div>
                <div class="chip" data-v="general">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§çœ¾</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸŒ èªè¨€</div>
            <div class="chips" id="langChips">
                <div class="chip on" data-v="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</div>
                <div class="chip" data-v="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</div>
                <div class="chip" data-v="en">ğŸ‡ºğŸ‡¸ English</div>
                <div class="chip" data-v="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ¯ é›£åº¦</div>
            <div class="chips" id="diffChips">
                <div class="chip on" data-v="basic">ğŸŒ± åŸºç¤</div>
                <div class="chip" data-v="intermediate">ğŸŒ¿ é€²éš</div>
                <div class="chip" data-v="advanced">ğŸŒ³ å°ˆæ¥­</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“„ é æ•¸</div>
            <div class="card">
                <div class="slider-row">
                    <input type="range" class="slider" id="countSlider" min="5" max="100" value="10">
                    <div class="slider-val" id="countVal">10</div>
                </div>
                <div class="slider-info" id="timeEst">â±ï¸ ç´„ 10 åˆ†é˜</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ¨ é¢¨æ ¼</div>
            <div class="style-grid" id="styleGrid">
                <div class="style-card on" data-v="professional"><div class="style-icon">ğŸ’¼</div><div class="style-name">å°ˆæ¥­</div></div>
                <div class="style-card" data-v="creative"><div class="style-icon">ğŸ¨</div><div class="style-name">å‰µæ„</div></div>
                <div class="style-card" data-v="minimal"><div class="style-icon">âœ¨</div><div class="style-name">ç°¡ç´„</div></div>
                <div class="style-card" data-v="fun"><div class="style-icon">ğŸˆ</div><div class="style-name">æ´»æ½‘</div></div>
                <div class="style-card" data-v="tech"><div class="style-icon">ğŸš€</div><div class="style-name">ç§‘æŠ€</div></div>
                <div class="style-card" data-v="nature"><div class="style-icon">ğŸŒ¿</div><div class="style-name">è‡ªç„¶</div></div>
                <div class="style-card" data-v="elegant"><div class="style-icon">ğŸ‘‘</div><div class="style-name">å„ªé›…</div></div>
                <div class="style-card" data-v="neon"><div class="style-icon">ğŸ’œ</div><div class="style-name">éœ“è™¹</div></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸŒˆ ä¸»é¡Œè‰²</div>
            <div class="card">
                <div class="theme-grid" id="themeGrid"></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“¦ å…§å®¹</div>
            <div class="chips" id="incChips">
                <div class="chip on" data-v="examples">ğŸ’¡ å¯¦ä¾‹</div>
                <div class="chip on" data-v="diagrams">ğŸ“Š åœ–è¡¨</div>
                <div class="chip" data-v="quiz">â“ æ¸¬é©—</div>
                <div class="chip" data-v="notes">ğŸ“ å‚™è¨»</div>
                <div class="chip on" data-v="summary">ğŸ“Œ ç¸½çµ</div>
                <div class="chip on" data-v="images">ğŸ–¼ï¸ åœ–ç‰‡</div>
                <div class="chip on" data-v="emoji">ğŸ˜Š Emoji</div>
                <div class="chip" data-v="timeline">ğŸ“… æ™‚é–“è»¸</div>
                <div class="chip" data-v="compare">âš–ï¸ æ¯”è¼ƒè¡¨</div>
                <div class="chip" data-v="qna">â” Q&A</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“¤ è¼¸å‡º</div>
            <div class="output-grid" id="outGrid">
                <div class="out-card on" data-v="pptx"><div class="out-icon">ğŸ“Š</div><div class="out-name">PPTX</div><div class="out-desc">ä¸‹è¼‰</div></div>
                <div class="out-card" data-v="canva"><div class="out-icon">ğŸ¨</div><div class="out-name">Canva</div><div class="out-desc">è¤‡è£½</div></div>
                <div class="out-card" data-v="html"><div class="out-icon">ğŸŒ</div><div class="out-name">ç¶²é </div><div class="out-desc">å‹•ç•«</div></div>
            </div>
        </div>
    </main>

    <div class="gen-sec">
        <button class="gen-btn" id="genBtn" onclick="generate()"><span>âœ¨</span><span>ç”¢ç”Ÿç°¡å ±</span></button>
        <div class="prog" id="prog"><div class="prog-bar"><div class="prog-fill" id="progFill"></div></div><div class="prog-txt" id="progTxt">è™•ç†ä¸­...</div></div>
    </div>
</div>

<!-- è¨­å®š -->
<div class="modal-bg" id="setModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">âš™ï¸ è¨­å®š</div><button class="modal-x" onclick="closeSet()">âœ•</button></div>
        <div class="modal-body">
            <div class="set-sec">
                <div class="set-label">ğŸ¤– AI æ¨¡å‹</div>
                <div class="chips" id="modelChips">
                    <div class="chip on" data-v="gemini-2.0-flash">2.0 Flash</div>
                    <div class="chip" data-v="gemini-2.5-flash">2.5 Flash</div>
                    <div class="chip" data-v="gemini-2.5-flash-lite">2.5 Lite</div>
                </div>
                <div class="model-custom">
                    <div class="set-label" style="margin-top:12px">ğŸ”§ è‡ªè¨‚æ¨¡å‹</div>
                    <div class="model-custom-row">
                        <input type="text" class="model-custom-inp" id="customModelInp" placeholder="gemini-3.0-pro">
                        <button class="model-custom-btn" onclick="useCustomModel()">å¥—ç”¨</button>
                    </div>
                    <p class="model-hint">ğŸ’¡ API æ›´æ–°æ™‚å¯è¼¸å…¥æ–°æ¨¡å‹åç¨±</p>
                    <p class="model-hint" id="currentModelHint"></p>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">â„¹ï¸ é—œæ–¼</div>
                <div class="card">
                    <p style="font-size:12px;line-height:1.5;color:var(--text-secondary)">
                        <strong style="color:var(--cyan)">âœ¨ SlideGenie Pro</strong><br>
                        AI ç°¡å ±ç”¢ç”Ÿå™¨ Â· Gemini API
                    </p>
                    <p style="font-size:10px;margin-top:8px;color:var(--text-muted)">
                        v6.0 | Made with â¤ï¸
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-foot"><button class="m-btn m-btn-pri" onclick="closeSet()" style="flex:1">âœ“ é—œé–‰</button></div>
    </div>
</div>

<!-- æ­·å² -->
<div class="modal-bg" id="histModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“‹ æ­·å²</div><button class="modal-x" onclick="closeHist()">âœ•</button></div>
        <div class="modal-body"><div class="hist-list" id="histList"></div></div>
    </div>
</div>

<!-- å¤§ç¶± -->
<div class="modal-bg" id="outlineModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“‹ å¤§ç¶±é è¦½</div><button class="modal-x" onclick="closeOutline()">âœ•</button></div>
        <div class="modal-body"><div id="outlineContent"></div></div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeOutline()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-orange" onclick="regenOutline()">ğŸ”„ é‡ç”¢</button>
            <button class="m-btn m-btn-pri" onclick="confirmOutline()">âœ“ ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- é è¦½ -->
<div class="modal-bg" id="previewModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“Š é è¦½</div><button class="modal-x" onclick="closePreview()">âœ•</button></div>
        <div class="modal-body"><div class="slides-list" id="slidesList"></div></div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closePreview()">âœ•</button>
            <button class="m-btn m-btn-sec" onclick="exportMarkdown()">ğŸ“ MD</button>
            <button class="m-btn m-btn-purple" onclick="openCanvaFromPreview()">ğŸ¨</button>
            <button class="m-btn m-btn-pri" onclick="downloadPPTX()">ğŸ“¥ PPTX</button>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯ -->
<div class="modal-bg" id="editModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">âœï¸ ç·¨è¼¯</div><button class="modal-x" onclick="closeEdit()">âœ•</button></div>
        <div class="modal-body">
            <div class="edit-field">
                <label class="edit-label">ğŸ“Œ æ¨™é¡Œ</label>
                <input type="text" class="edit-inp" id="editTitle">
            </div>
            <div class="edit-field">
                <label class="edit-label">ğŸ“ å…§å®¹ï¼ˆæ¯è¡Œä¸€é»ï¼‰</label>
                <textarea class="edit-inp" id="editContent"></textarea>
            </div>
            <div class="edit-field">
                <label class="edit-label">ğŸ’¬ å‚™è¨»</label>
                <textarea class="edit-inp" id="editNotes" style="min-height:50px"></textarea>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeEdit()">âœ•</button>
            <button class="m-btn m-btn-orange" onclick="regenSlide()">ğŸ”„</button>
            <button class="m-btn m-btn-pri" onclick="saveEdit()">ğŸ’¾</button>
        </div>
    </div>
</div>

<!-- Canva -->
<div class="modal-bg canva-modal" id="canvaModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ¨ Canva è¤‡è£½</div><button class="modal-x" onclick="closeCanva()">âœ•</button></div>
        <div class="modal-body">
            <div class="copy-card">
                <div class="copy-header"><div class="copy-page" id="copyPage">ğŸ“„ ç¬¬ 1 é </div><div class="copy-progress" id="copyProg">1/10</div></div>
                <div class="copy-type" id="copyType">å°é¢</div>
                <div class="copy-title" id="copyTitle">æ¨™é¡Œ</div>
                <div class="copy-content" id="copyContent">å…§å®¹</div>
                <div class="copy-notes" id="copyNotes" style="display:none"></div>
                <div class="copy-img" id="copyImg" style="display:none"></div>
            </div>
            <div class="copy-hint" style="background:rgba(168,85,247,0.15);padding:10px;border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--purple);text-align:center">
                ğŸ’¡ åˆ†é–‹è¤‡è£½ï¼Œè²¼åˆ° Canva å¾Œåˆ†åˆ¥è¨­å®šå­—é«”å¤§å°
            </div>
            <div class="copy-btns-split" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                <button class="copy-btn copy" id="copyTitleBtn" onclick="copyTitle()">ğŸ“‹ æ¨™é¡Œ (56pt)</button>
                <button class="copy-btn copy" id="copyContentBtn" onclick="copyContent()">ğŸ“‹ å…§å®¹ (24pt)</button>
            </div>
            <button class="copy-btn copy" id="copyBtn" onclick="copySlide()" style="background:var(--grad-green)">ğŸ“‹ æ•´é è¤‡è£½</button>
            <div class="copy-nav">
                <button class="copy-btn nav" id="prevBtn" onclick="prevSlide()">â—€</button>
                <button class="copy-btn nav" id="nextBtn" onclick="nextSlide()">â–¶</button>
            </div>
            <div class="copy-dots" id="copyDots"></div>
            <div class="copy-actions">
                <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å…¨éƒ¨</button>
                <a class="canva-link" href="https://www.canva.com/templates/?query=presentation" target="_blank">ğŸ¨ é–‹å•Ÿ Canva</a>
            </div>
        </div>
    </div>
</div>

<!-- HTML -->
<div class="modal-bg html-modal" id="htmlModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸŒ å‹•ç•«æ’­æ”¾</div><button class="modal-x" onclick="closeHtml()">âœ•</button></div>
        <div class="modal-body">
            <div class="slideshow-wrap">
                <div class="slideshow" id="slideshow"></div>
            </div>
            <div class="ss-controls">
                <button class="ss-btn" onclick="ssPrev()">â—€</button>
                <div class="ss-counter" id="ssCounter">1/10</div>
                <button class="ss-btn" onclick="ssNext()">â–¶</button>
                <button class="ss-btn pri" onclick="ssNextItem()">â© ä¸‹ä¸€æ®µ</button>
            </div>
            <div class="ss-next-hint">ğŸ’¡ ç©ºç™½éµ = ä¸‹ä¸€æ®µå‹•ç•«</div>
            <div style="padding:10px;text-align:center">
                <button class="ss-btn pri" onclick="ssFullscreen()">ğŸ“º å…¨è¢å¹•</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-box" id="toastBox"></div>

<script>
const animations=[
    {name:'æ·¡å…¥',style:'opacity:0',show:'opacity:1;transition:all 0.6s ease'},
    {name:'å·¦æ»‘å…¥',style:'opacity:0;transform:translateX(-80px)',show:'opacity:1;transform:translateX(0);transition:all 0.5s ease-out'},
    {name:'å³æ»‘å…¥',style:'opacity:0;transform:translateX(80px)',show:'opacity:1;transform:translateX(0);transition:all 0.5s ease-out'},
    {name:'ä¸Šæ»‘å…¥',style:'opacity:0;transform:translateY(-50px)',show:'opacity:1;transform:translateY(0);transition:all 0.5s ease-out'},
    {name:'ä¸‹æ»‘å…¥',style:'opacity:0;transform:translateY(50px)',show:'opacity:1;transform:translateY(0);transition:all 0.5s ease-out'},
    {name:'æ”¾å¤§',style:'opacity:0;transform:scale(0.3)',show:'opacity:1;transform:scale(1);transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)'},
    {name:'ç¸®å°',style:'opacity:0;transform:scale(1.5)',show:'opacity:1;transform:scale(1);transition:all 0.5s ease-out'},
    {name:'æ—‹è½‰å…¥',style:'opacity:0;transform:rotate(-180deg) scale(0.5)',show:'opacity:1;transform:rotate(0) scale(1);transition:all 0.6s ease-out'},
    {name:'ç¿»è½‰X',style:'opacity:0;transform:rotateX(90deg)',show:'opacity:1;transform:rotateX(0);transition:all 0.5s ease-out'},
    {name:'ç¿»è½‰Y',style:'opacity:0;transform:rotateY(90deg)',show:'opacity:1;transform:rotateY(0);transition:all 0.5s ease-out'},
    {name:'å½ˆè·³',style:'opacity:0;transform:translateY(-40px)',show:'opacity:1;transform:translateY(0);transition:all 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)'},
    {name:'æ–æ™ƒå…¥',style:'opacity:0;transform:translateX(-30px) rotate(-5deg)',show:'opacity:1;transform:translateX(0) rotate(0);transition:all 0.5s ease-out'},
    {name:'èºæ—‹',style:'opacity:0;transform:rotate(360deg) scale(0)',show:'opacity:1;transform:rotate(0) scale(1);transition:all 0.7s ease-out'},
    {name:'å·¦ä¸‹è§’',style:'opacity:0;transform:translate(-40px,40px)',show:'opacity:1;transform:translate(0,0);transition:all 0.5s ease-out'},
    {name:'å³ä¸Šè§’',style:'opacity:0;transform:translate(40px,-40px)',show:'opacity:1;transform:translate(0,0);transition:all 0.5s ease-out'},
    {name:'æ¨¡ç³Šå…¥',style:'opacity:0;filter:blur(15px)',show:'opacity:1;filter:blur(0);transition:all 0.6s ease-out'},
    {name:'æ–œåˆ‡å…¥',style:'opacity:0;transform:skewX(20deg) translateX(-40px)',show:'opacity:1;transform:skewX(0) translateX(0);transition:all 0.5s ease-out'},
    {name:'3Dç¿»é ',style:'opacity:0;transform:perspective(500px) rotateY(-90deg)',show:'opacity:1;transform:perspective(500px) rotateY(0);transition:all 0.6s ease-out'},
    {name:'æ©¡çš®ç­‹',style:'opacity:0;transform:scaleX(0.3)',show:'opacity:1;transform:scaleX(1);transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)'},
    {name:'é–ƒç¾',style:'opacity:0;transform:scale(1.2)',show:'opacity:1;transform:scale(1);transition:all 0.3s ease-out'},
];

const themes=[
    {id:'ocean',name:'æµ·æ´‹è—',c1:'0c4a6e',c2:'0ea5e9',css:'linear-gradient(135deg,#0c4a6e,#0ea5e9)'},
    {id:'purple',name:'å¤¢å¹»ç´«',c1:'581c87',c2:'a855f7',css:'linear-gradient(135deg,#581c87,#a855f7)'},
    {id:'sunset',name:'å¤•é™½æ©˜',c1:'9a3412',c2:'f97316',css:'linear-gradient(135deg,#9a3412,#f97316)'},
    {id:'forest',name:'æ£®æ—ç¶ ',c1:'14532d',c2:'22c55e',css:'linear-gradient(135deg,#14532d,#22c55e)'},
    {id:'rose',name:'ç«ç‘°ç²‰',c1:'9d174d',c2:'ec4899',css:'linear-gradient(135deg,#9d174d,#ec4899)'},
    {id:'cyber',name:'è³½åšéœ“è™¹',c1:'0f172a',c2:'06b6d4',css:'linear-gradient(135deg,#0f172a,#06b6d4)'},
    {id:'gold',name:'å¥¢è¯é‡‘',c1:'451a03',c2:'f59e0b',css:'linear-gradient(135deg,#451a03,#f59e0b)'},
    {id:'mono',name:'æ¥µç°¡é»‘',c1:'18181b',c2:'52525b',css:'linear-gradient(135deg,#18181b,#52525b)'},
    {id:'sky',name:'å¤©ç©ºè—',c1:'0369a1',c2:'7dd3fc',css:'linear-gradient(180deg,#0369a1,#7dd3fc)'},
    {id:'fire',name:'çƒˆç„°ç´…',c1:'7f1d1d',c2:'ef4444',css:'linear-gradient(135deg,#7f1d1d,#ef4444)'},
    {id:'mint',name:'è–„è·ç¶ ',c1:'0f766e',c2:'2dd4bf',css:'linear-gradient(135deg,#0f766e,#2dd4bf)'},
    {id:'aurora',name:'æ¥µå…‰',c1:'4c1d95',c2:'06b6d4',css:'linear-gradient(135deg,#4c1d95,#0891b2,#06b6d4)'},
];

let model='gemini-2.0-flash',apiKeyVerified=false,hist=[],slides=null,topic='',outline=null;
let aud='junior',style='professional',themeId='ocean',output='pptx';
let lang='zh-TW',diff='basic';
let incs=['examples','diagrams','summary','images','emoji'];
let copyIdx=0,copied=[];
let ssIdx=0,ssItemIdx=-1,slideAnims=[];
let editIdx=-1;

document.addEventListener('DOMContentLoaded',()=>{
    loadH();renderThemes();updateModelHint();
    setupChips('#audChips',v=>aud=v);
    setupChips('#langChips',v=>lang=v);
    setupChips('#diffChips',v=>diff=v);
    setupChips('#incChips',null,true);
    setupChips('#modelChips',v=>{model=v;updateModelHint();});
    setupCards('#styleGrid',v=>style=v);
    setupCards('#outGrid',v=>{output=v;updateGenBtn();});
    const slider=document.getElementById('countSlider');
    slider.oninput=e=>{document.getElementById('countVal').textContent=e.target.value;updateTimeEst(+e.target.value);};
    setTimeout(()=>{document.getElementById('splash').classList.add('hidden');document.getElementById('app').classList.add('show');},2500);
});

function updateTimeEst(n){document.getElementById('timeEst').textContent=`â±ï¸ ç´„ ${n} åˆ†é˜`;}
function updateModelHint(){document.getElementById('currentModelHint').textContent=`ğŸ“ ç›®å‰ï¼š${model}`;}

// æ¸…é™¤ API Key
function clearKey(){
    document.getElementById('apiInp').value='';
    apiKeyVerified=false;
    document.getElementById('apiStat').className='api-stat';
    toast('ğŸ—‘ï¸ å·²æ¸…é™¤','ok');
}

// API Key é©—è­‰
async function verifyKey(){
    const k=document.getElementById('apiInp').value.trim();
    if(!k){showApiStat('err','âŒ è«‹è¼¸å…¥ API Key');return;}
    const btn=document.getElementById('verifyBtn');
    btn.disabled=true;btn.textContent='...';
    showApiStat('wait','â³ é©—è­‰ä¸­...');
    try{
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${k}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:'hi'}]}],generationConfig:{maxOutputTokens:5}})
        });
        if(r.ok){apiKeyVerified=true;showApiStat('ok','âœ… é©—è­‰æˆåŠŸï¼å¯ä»¥é–‹å§‹ä½¿ç”¨');toast('âœ… API Key æœ‰æ•ˆ','ok');}
        else{const e=await r.json();showApiStat('err','âŒ '+(e.error?.message||'é©—è­‰å¤±æ•—'));}
    }catch(e){showApiStat('err','âŒ é€£ç·šéŒ¯èª¤');}
    btn.disabled=false;btn.textContent='é©—è­‰';
}
function showApiStat(t,m){const e=document.getElementById('apiStat');e.className='api-stat on '+t;e.innerHTML=m;}

function useCustomModel(){
    const v=document.getElementById('customModelInp').value.trim();
    if(!v){toast('âŒ è«‹è¼¸å…¥æ¨¡å‹åç¨±','warn');return;}
    model=v;
    document.querySelectorAll('#modelChips .chip').forEach(c=>c.classList.remove('on'));
    updateModelHint();
    apiKeyVerified=false;
    showApiStat('warn','âš ï¸ è«‹é‡æ–°é©—è­‰ API Key');
    toast(`âœ… å·²å¥—ç”¨ï¼š${model}`,'ok');
}

function renderThemes(){
    document.getElementById('themeGrid').innerHTML=themes.map(t=>
        `<div class="theme-card ${t.id===themeId?'on':''}" data-id="${t.id}" data-name="${t.name}" style="background:${t.css}" onclick="selectTheme('${t.id}')"></div>`
    ).join('');
}
function selectTheme(id){themeId=id;document.querySelectorAll('.theme-card').forEach(c=>c.classList.toggle('on',c.dataset.id===id));}

function setupChips(sel,cb,multi){
    document.querySelectorAll(`${sel} .chip`).forEach(c=>{
        c.onclick=()=>{
            if(multi){c.classList.toggle('on');incs=[...document.querySelectorAll(`${sel} .chip.on`)].map(x=>x.dataset.v);}
            else{document.querySelectorAll(`${sel} .chip`).forEach(x=>x.classList.remove('on'));c.classList.add('on');if(cb)cb(c.dataset.v);}
        };
    });
}
function setupCards(sel,cb){
    document.querySelectorAll(`${sel} > div`).forEach(c=>{
        c.onclick=()=>{document.querySelectorAll(`${sel} > div`).forEach(x=>x.classList.remove('on'));c.classList.add('on');cb(c.dataset.v);};
    });
}
function updateGenBtn(){
    const b=document.getElementById('genBtn');
    b.className='gen-btn'+(output==='canva'?' canva':output==='html'?' html':'');
    b.innerHTML=`<span>${output==='canva'?'ğŸ¨':output==='html'?'ğŸŒ':'âœ¨'}</span><span>ç”¢ç”Ÿç°¡å ±</span>`;
}

function openSet(){document.getElementById('setModal').classList.add('on');}
function closeSet(){document.getElementById('setModal').classList.remove('on');}

function loadH(){const d=localStorage.getItem('sg_hist');if(d)hist=JSON.parse(d);}
function saveH(){localStorage.setItem('sg_hist',JSON.stringify(hist));}
function addH(t,s){hist.unshift({id:Date.now(),topic:t,slides:s,at:new Date().toISOString()});if(hist.length>20)hist=hist.slice(0,20);saveH();}
function openHist(){renderH();document.getElementById('histModal').classList.add('on');}
function closeHist(){document.getElementById('histModal').classList.remove('on');}
function renderH(){
    const c=document.getElementById('histList');
    if(!hist.length){c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div>å°šç„¡è¨˜éŒ„</div>';return;}
    c.innerHTML=hist.map(h=>`<div class="hist-item"><div class="hist-info"><div class="hist-title">${esc(h.topic)}</div><div class="hist-meta">ğŸ“„ ${h.slides.length}é  Â· ${new Date(h.at).toLocaleDateString('zh-TW')}</div></div><div class="hist-btns"><button class="hist-btn" onclick="viewH(${h.id})">ğŸ‘ï¸</button><button class="hist-btn" onclick="delH(${h.id})">ğŸ—‘ï¸</button></div></div>`).join('');
}
function viewH(id){const h=hist.find(x=>x.id===id);if(h){topic=h.topic;slides=h.slides;closeHist();showPreview();}}
function delH(id){if(!confirm('åˆªé™¤ï¼Ÿ'))return;hist=hist.filter(x=>x.id!==id);saveH();renderH();toast('âœ… å·²åˆªé™¤','ok');}

async function generate(){
    const apiKey=document.getElementById('apiInp').value.trim();
    topic=document.getElementById('topicInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    if(!topic){toast('âŒ è«‹è¼¸å…¥ä¸»é¡Œ','warn');return;}
    
    const btn=document.getElementById('genBtn'),prog=document.getElementById('prog'),fill=document.getElementById('progFill'),txt=document.getElementById('progTxt');
    btn.disabled=true;btn.innerHTML='<div class="spinner"></div><span>ç”¢ç”Ÿä¸­...</span>';
    prog.classList.add('on');fill.style.width='20%';txt.textContent='ğŸ“‹ ç”¢ç”Ÿå¤§ç¶±...';
    
    try{
        outline=await genOutline(apiKey);
        fill.style.width='100%';txt.textContent='âœ… å¤§ç¶±å®Œæˆ';
        setTimeout(()=>{
            btn.disabled=false;updateGenBtn();
            prog.classList.remove('on');fill.style.width='0%';
            showOutline();
        },500);
    }catch(e){
        toast('âŒ '+e.message,'err');
        btn.disabled=false;updateGenBtn();prog.classList.remove('on');
    }
}

async function genOutline(apiKey){
    const detail=document.getElementById('detailInp').value.trim();
    const count=+document.getElementById('countSlider').value;
    const audMap={elementary:'åœ‹å°ç”Ÿ',junior:'åœ‹ä¸­ç”Ÿ',senior:'é«˜ä¸­ç”Ÿ',college:'å¤§å­¸ç”Ÿ',general:'ä¸€èˆ¬å¤§çœ¾'};
    const styMap={professional:'å°ˆæ¥­æ­£å¼',creative:'å‰µæ„æ´»æ½‘',minimal:'ç°¡ç´„ç²¾ç·»',fun:'è¼•é¬†æœ‰è¶£',tech:'ç§‘æŠ€æœªä¾†',nature:'è‡ªç„¶æ¸…æ–°',elegant:'å„ªé›…é«˜ç´š',neon:'éœ“è™¹ç‚«å½©'};
    const langMap={'zh-TW':'ç¹é«”ä¸­æ–‡','zh-CN':'ç®€ä½“ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª'};
    const diffMap={basic:'åŸºç¤å…¥é–€',intermediate:'é€²éšå»¶ä¼¸',advanced:'å°ˆæ¥­æ·±å…¥'};
    
    const prompt=`ç”¢ç”Ÿç°¡å ±å¤§ç¶±ï¼š
ä¸»é¡Œï¼š${topic}
${detail?'è£œå……ï¼š'+detail:''}
å°è±¡ï¼š${audMap[aud]}
èªè¨€ï¼š${langMap[lang]}ï¼ˆè«‹ç”¨æ­¤èªè¨€æ’°å¯«æ‰€æœ‰å…§å®¹ï¼‰
é›£åº¦ï¼š${diffMap[diff]}
é¢¨æ ¼ï¼š${styMap[style]}
é æ•¸ï¼š${count}é 
${incs.includes('emoji')?'é©æ™‚åŠ emoji':''}
${incs.includes('timeline')?'åŒ…å«æ™‚é–“è»¸é é¢':''}
${incs.includes('compare')?'åŒ…å«æ¯”è¼ƒè¡¨é é¢':''}
${incs.includes('qna')?'åŒ…å«Q&Aå•ç­”é é¢':''}

æ ¼å¼ï¼š{"outline":[{"page":1,"type":"å°é¢/å…§å®¹/ç¸½çµ/æ™‚é–“è»¸/æ¯”è¼ƒ/Q&A","title":"æ¨™é¡Œ"},...]}
åªå›å‚³JSON`;

    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:4096}})
    });
    if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'APIéŒ¯èª¤');}
    const txt=(await r.json()).candidates[0].content.parts[0].text;
    const m=txt.match(/\{[\s\S]*\}/);
    if(!m)throw new Error('è§£æå¤±æ•—');
    return JSON.parse(m[0]);
}

function showOutline(){
    document.getElementById('outlineContent').innerHTML=`<div class="outline-card"><div class="outline-title">ğŸ“Š ${esc(topic)}</div><div class="outline-list">${outline.outline.map(o=>`<div class="outline-item"><span class="outline-num">${o.page}</span>${esc(o.title)}</div>`).join('')}</div></div>`;
    document.getElementById('outlineModal').classList.add('on');
}
function closeOutline(){document.getElementById('outlineModal').classList.remove('on');}
function regenOutline(){closeOutline();generate();}
async function confirmOutline(){closeOutline();await genSlides();}

async function genSlides(){
    const apiKey=document.getElementById('apiInp').value.trim();
    const count=outline.outline.length;
    
    const btn=document.getElementById('genBtn'),prog=document.getElementById('prog'),fill=document.getElementById('progFill'),txt=document.getElementById('progTxt');
    btn.disabled=true;btn.innerHTML='<div class="spinner"></div><span>ç”¢ç”Ÿä¸­...</span>';
    prog.classList.add('on');
    
    try{
        let all=[];const BS=25,TB=Math.ceil(count/BS);
        for(let b=0;b<TB;b++){
            const st=b*BS,ed=Math.min((b+1)*BS,count);
            const batch=outline.outline.slice(st,ed);
            fill.style.width=((b+0.5)/TB*80)+'%';
            txt.textContent=TB>1?`ğŸ“„ ${b+1}/${TB} æ‰¹...`:'ğŸ“„ ç”¢ç”Ÿä¸­...';
            const bs=await callAPI(apiKey,batch);
            all=all.concat(bs);
            if(b<TB-1)await sleep(1000);
        }
        fill.style.width='100%';txt.textContent=`âœ… å®Œæˆ ${all.length} é `;
        slides=all;addH(topic,all);
        
        setTimeout(()=>{
            if(output==='canva')openCanva();
            else if(output==='html')openHtml();
            else showPreview();
            btn.disabled=false;updateGenBtn();
            prog.classList.remove('on');fill.style.width='0%';
        },500);
    }catch(e){
        toast('âŒ '+e.message,'err');
        btn.disabled=false;updateGenBtn();prog.classList.remove('on');
    }
}

async function callAPI(apiKey,batch){
    const audMap={elementary:'åœ‹å°ç”Ÿ',junior:'åœ‹ä¸­ç”Ÿ',senior:'é«˜ä¸­ç”Ÿ',college:'å¤§å­¸ç”Ÿ',general:'ä¸€èˆ¬å¤§çœ¾'};
    const styMap={professional:'å°ˆæ¥­æ­£å¼',creative:'å‰µæ„æ´»æ½‘',minimal:'ç°¡ç´„ç²¾ç·»',fun:'è¼•é¬†æœ‰è¶£',tech:'ç§‘æŠ€æœªä¾†',nature:'è‡ªç„¶æ¸…æ–°',elegant:'å„ªé›…é«˜ç´š',neon:'éœ“è™¹ç‚«å½©'};
    const langMap={'zh-TW':'ç¹é«”ä¸­æ–‡','zh-CN':'ç®€ä½“ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª'};
    const diffMap={basic:'åŸºç¤å…¥é–€',intermediate:'é€²éšå»¶ä¼¸',advanced:'å°ˆæ¥­æ·±å…¥'};
    const incMap={examples:'ğŸ’¡å¯¦ä¾‹',diagrams:'ğŸ“Šåœ–è¡¨',quiz:'â“æ¸¬é©—',notes:'ğŸ“å‚™è¨»',summary:'ğŸ“Œç¸½çµ',images:'ğŸ–¼ï¸åœ–ç‰‡é—œéµå­—',emoji:'ğŸ˜ŠEmoji',timeline:'ğŸ“…æ™‚é–“è»¸',compare:'âš–ï¸æ¯”è¼ƒè¡¨',qna:'â”Q&A'};
    
    const prompt=`ç”¢ç”Ÿç°¡å ±å…§å®¹ï¼š
ä¸»é¡Œï¼š${topic}
å°è±¡ï¼š${audMap[aud]}
èªè¨€ï¼š${langMap[lang]}ï¼ˆè«‹ç”¨æ­¤èªè¨€æ’°å¯«æ‰€æœ‰å…§å®¹ï¼‰
é›£åº¦ï¼š${diffMap[diff]}
é¢¨æ ¼ï¼š${styMap[style]}
éœ€æ±‚ï¼š${incs.map(i=>incMap[i]||i).join('ã€')}
${incs.includes('emoji')?'æ¯é åŠ 1-2å€‹emoji':''}

å¤§ç¶±ï¼š
${batch.map(o=>`ç¬¬${o.page}é [${o.type}]ï¼š${o.title}`).join('\n')}

æ ¼å¼ï¼š{"slides":[{"number":1,"type":"å°é¢","title":"æ¨™é¡Œ","subtitle":"å‰¯æ¨™é¡Œ","content":["é‡é»1","é‡é»2"],"notes":"å‚™è¨»","imageKeyword":"åœ–ç‰‡é—œéµå­—"}]}
åªå›å‚³JSON`;

    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:8192}})
    });
    if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'APIéŒ¯èª¤');}
    const txt=(await r.json()).candidates[0].content.parts[0].text;
    const m=txt.match(/\{[\s\S]*\}/);
    if(!m)throw new Error('è§£æå¤±æ•—');
    return JSON.parse(m[0]).slides;
}

function showPreview(){
    document.getElementById('slidesList').innerHTML=slides.map((s,i)=>`
        <div class="slide-card">
            <div class="slide-head">
                <span class="slide-num">ğŸ“„ ${s.number}</span>
                <div style="display:flex;align-items:center;gap:6px">
                    <span class="slide-type">${s.type}</span>
                    <button class="slide-action" onclick="openEdit(${i})">âœï¸</button>
                </div>
            </div>
            <div class="slide-body">
                <div class="slide-title">${esc(s.title)}</div>
                ${s.subtitle?`<div style="color:var(--text-muted);margin-bottom:6px;font-size:11px">${esc(s.subtitle)}</div>`:''}
                <div class="slide-content">${Array.isArray(s.content)?'<ul>'+s.content.map(c=>`<li>${esc(c)}</li>`).join('')+'</ul>':esc(s.content||'')}</div>
                ${s.notes?`<div class="slide-notes">ğŸ’¬ ${esc(s.notes)}</div>`:''}
                ${s.imageKeyword?`<div class="slide-img">ğŸ–¼ï¸ ${esc(s.imageKeyword)}</div>`:''}
            </div>
        </div>
    `).join('');
    document.getElementById('previewModal').classList.add('on');
}
function closePreview(){document.getElementById('previewModal').classList.remove('on');}
function openCanvaFromPreview(){closePreview();openCanva();}

function openEdit(idx){
    editIdx=idx;const s=slides[idx];
    document.getElementById('editTitle').value=s.title;
    document.getElementById('editContent').value=Array.isArray(s.content)?s.content.join('\n'):s.content||'';
    document.getElementById('editNotes').value=s.notes||'';
    document.getElementById('editModal').classList.add('on');
}
function closeEdit(){document.getElementById('editModal').classList.remove('on');editIdx=-1;}
function saveEdit(){
    if(editIdx<0)return;
    slides[editIdx].title=document.getElementById('editTitle').value;
    const content=document.getElementById('editContent').value.trim();
    slides[editIdx].content=content?content.split('\n').filter(x=>x.trim()):[];
    slides[editIdx].notes=document.getElementById('editNotes').value.trim()||undefined;
    closeEdit();showPreview();toast('âœ… å·²å„²å­˜','ok');
}
async function regenSlide(){
    if(editIdx<0)return;
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    const s=slides[editIdx];
    toast('ğŸ”„ é‡æ–°ç”¢ç”Ÿ...','warn');
    try{
        const prompt=`é‡æ–°ç”¢ç”Ÿç°¡å ±é é¢ï¼š
ä¸»é¡Œï¼š${topic}ï¼Œç¬¬${s.number}é [${s.type}]ï¼ŒåŸæ¨™é¡Œï¼š${s.title}
${incs.includes('emoji')?'åŠ emoji':''}
æ ¼å¼ï¼š{"title":"æ¨™é¡Œ","content":["é‡é»"],"notes":"å‚™è¨»"}
åªå›å‚³JSON`;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.9,maxOutputTokens:1024}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(!m)throw new Error('è§£æå¤±æ•—');
        const d=JSON.parse(m[0]);
        slides[editIdx].title=d.title||s.title;
        slides[editIdx].content=d.content||s.content;
        slides[editIdx].notes=d.notes||s.notes;
        closeEdit();showPreview();toast('âœ… å·²é‡æ–°ç”¢ç”Ÿ','ok');
    }catch(e){toast('âŒ '+e.message,'err');}
}

function downloadPPTX(){
    if(!slides?.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    const theme=themes.find(t=>t.id===themeId)||themes[0];
    try{
        const pptx=new PptxGenJS();
        pptx.layout='LAYOUT_16x9';
        pptx.title=topic;
        slides.forEach(sl=>{
            const s=pptx.addSlide();
            const isCover=sl.type==='å°é¢'||sl.type==='ç¸½çµ';
            if(isCover){
                s.background={color:theme.c1};
                s.addShape('rect',{x:0,y:0,w:'100%',h:'100%',fill:{type:'solid',color:theme.c1}});
                s.addShape('rect',{x:0,y:0,w:'100%',h:'100%',fill:{type:'solid',color:theme.c2,transparency:50}});
            }else{s.background={color:'FFFFFF'};}
            if(sl.type==='å°é¢'){
                s.addText(sl.title,{x:0.5,y:2,w:9,h:1.2,fontSize:36,bold:true,color:'FFFFFF',align:'center',shadow:{type:'outer',blur:6,offset:2,angle:45,color:'000000',opacity:0.3}});
                if(sl.subtitle)s.addText(sl.subtitle,{x:0.5,y:3.3,w:9,h:0.6,fontSize:18,color:'FFFFFF',align:'center',transparency:25});
            }else if(sl.type==='ç¸½çµ'){
                s.addText(sl.title,{x:0.5,y:0.6,w:9,h:0.8,fontSize:28,bold:true,color:'FFFFFF',align:'center'});
                if(Array.isArray(sl.content))s.addText(sl.content.map(x=>'âœ“ '+x).join('\n'),{x:1,y:1.8,w:8,h:3.5,fontSize:16,color:'FFFFFF',lineSpacing:32});
            }else{
                s.addShape('rect',{x:0,y:0,w:10,h:1.1,fill:{type:'solid',color:theme.c1}});
                s.addShape('rect',{x:5,y:0,w:5,h:1.1,fill:{type:'solid',color:theme.c2,transparency:40}});
                s.addText(sl.title,{x:0.4,y:0.2,w:9,h:0.7,fontSize:22,bold:true,color:'FFFFFF'});
                if(Array.isArray(sl.content))s.addText(sl.content.map(x=>({text:x,options:{bullet:{type:'bullet',color:theme.c2}}})),{x:0.4,y:1.3,w:9,h:4,fontSize:14,color:'333333',paraSpaceAfter:12});
            }
            s.addText(String(sl.number),{x:9.2,y:5.2,w:0.5,h:0.3,fontSize:11,color:'94A3B8',align:'right'});
            if(sl.notes)s.addNotes(sl.notes);
        });
        pptx.writeFile({fileName:`${topic}.pptx`});
        toast('âœ… PPTX å·²ä¸‹è¼‰','ok');
        closePreview();
    }catch(e){toast('âŒ '+e.message,'err');}
}

// åŒ¯å‡º Markdown
function exportMarkdown(){
    if(!slides?.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    let md=`# ${topic}\n\n`;
    md+=`> ğŸ¯ å°è±¡ï¼š${aud} | ğŸ¨ é¢¨æ ¼ï¼š${style} | ğŸ“„ ${slides.length} é \n\n---\n\n`;
    
    slides.forEach(s=>{
        if(s.type==='å°é¢'){
            md+=`## ğŸ¬ ${s.title}\n\n`;
            if(s.subtitle)md+=`*${s.subtitle}*\n\n`;
        }else if(s.type==='ç¸½çµ'){
            md+=`## ğŸ“Œ ${s.title}\n\n`;
            if(Array.isArray(s.content))md+=s.content.map(c=>`- âœ“ ${c}`).join('\n')+'\n\n';
        }else{
            md+=`## ${s.number}. ${s.title}\n\n`;
            if(s.subtitle)md+=`*${s.subtitle}*\n\n`;
            if(Array.isArray(s.content))md+=s.content.map(c=>`- ${c}`).join('\n')+'\n\n';
            else if(s.content)md+=s.content+'\n\n';
        }
        if(s.notes)md+=`> ğŸ’¬ ${s.notes}\n\n`;
        if(s.imageKeyword)md+=`> ğŸ–¼ï¸ åœ–ç‰‡å»ºè­°ï¼š${s.imageKeyword}\n\n`;
        md+='---\n\n';
    });
    
    // ä¸‹è¼‰
    const blob=new Blob([md],{type:'text/markdown'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`${topic}.md`;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('âœ… Markdown å·²ä¸‹è¼‰','ok');
}

// Canva - ä¿®æ­£æ ¼å¼ï¼šæ¨™é¡Œç”¨å¤§å­—ï¼Œå…§å®¹ç”¨å°å­—
function openCanva(){copyIdx=0;copied=new Array(slides.length).fill(false);renderCopyDots();renderCopySlide();document.getElementById('canvaModal').classList.add('on');}
function closeCanva(){document.getElementById('canvaModal').classList.remove('on');}
function renderCopySlide(){
    const s=slides[copyIdx];
    document.getElementById('copyPage').textContent=`ğŸ“„ ç¬¬ ${s.number} é `;
    document.getElementById('copyProg').textContent=`${copyIdx+1}/${slides.length}`;
    document.getElementById('copyType').textContent=s.type;
    document.getElementById('copyTitle').textContent=s.title;
    
    let content='';
    if(s.subtitle)content+=s.subtitle+'\n\n';
    if(Array.isArray(s.content))content+=s.content.map(c=>'â€¢ '+c).join('\n');
    else if(s.content)content+=s.content;
    document.getElementById('copyContent').textContent=content;
    
    const notesEl=document.getElementById('copyNotes');
    if(s.notes){notesEl.style.display='block';notesEl.textContent='ğŸ’¬ '+s.notes;}else{notesEl.style.display='none';}
    const imgEl=document.getElementById('copyImg');
    if(s.imageKeyword){imgEl.style.display='block';imgEl.textContent='ğŸ–¼ï¸ '+s.imageKeyword;}else{imgEl.style.display='none';}
    
    document.getElementById('prevBtn').disabled=copyIdx===0;
    document.getElementById('nextBtn').disabled=copyIdx===slides.length-1;
    const copyBtn=document.getElementById('copyBtn');
    if(copied[copyIdx]){copyBtn.classList.add('done');copyBtn.innerHTML='âœ… å·²è¤‡è£½';}
    else{copyBtn.classList.remove('done');copyBtn.innerHTML='ğŸ“‹ è¤‡è£½é€™ä¸€é ';}
    updateCopyDots();
}
function renderCopyDots(){document.getElementById('copyDots').innerHTML=slides.map((_,i)=>`<div class="copy-dot" data-i="${i}"></div>`).join('');document.querySelectorAll('.copy-dot').forEach(d=>d.onclick=()=>{copyIdx=+d.dataset.i;renderCopySlide();});}
function updateCopyDots(){document.querySelectorAll('.copy-dot').forEach((d,i)=>{d.classList.toggle('on',i===copyIdx);d.classList.toggle('done',copied[i]);});}

// åªè¤‡è£½æ¨™é¡Œï¼ˆè²¼åˆ° Canva å¾Œè¨­ 56ptï¼‰
async function copyTitle(){
    const s=slides[copyIdx];
    let txt=s.title;
    if(s.subtitle)txt+='\n'+s.subtitle;
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast(`âœ… æ¨™é¡Œå·²è¤‡è£½ â†’ è²¼åˆ° Canva è¨­ 56pt`,'ok');
    document.getElementById('copyTitleBtn').textContent='âœ… å·²è¤‡è£½';
    setTimeout(()=>{document.getElementById('copyTitleBtn').textContent='ğŸ“‹ æ¨™é¡Œ (56pt)';},2000);
}

// åªè¤‡è£½å…§å®¹ï¼ˆè²¼åˆ° Canva å¾Œè¨­ 24ptï¼‰
async function copyContent(){
    const s=slides[copyIdx];
    const txt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast(`âœ… å…§å®¹å·²è¤‡è£½ â†’ è²¼åˆ° Canva è¨­ 24pt`,'ok');
    document.getElementById('copyContentBtn').textContent='âœ… å·²è¤‡è£½';
    setTimeout(()=>{document.getElementById('copyContentBtn').textContent='ğŸ“‹ å…§å®¹ (24pt)';},2000);
}

// æ•´é è¤‡è£½
async function copySlide(){
    const s=slides[copyIdx];
    const titleTxt=s.title+(s.subtitle?'\n'+s.subtitle:'');
    const contentTxt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
    const txt=titleTxt+'\n\n'+contentTxt;
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    copied[copyIdx]=true;
    toast(`âœ… ç¬¬ ${s.number} é æ•´é è¤‡è£½`,'ok');
    renderCopySlide();
    if(copyIdx<slides.length-1)setTimeout(()=>{copyIdx++;renderCopySlide();},800);
}
function prevSlide(){if(copyIdx>0){copyIdx--;renderCopySlide();}}
function nextSlide(){if(copyIdx<slides.length-1){copyIdx++;renderCopySlide();}}
async function copyAll(){
    const txt=slides.map(s=>{
        const titleTxt=s.title+(s.subtitle?'\n'+s.subtitle:'');
        const contentTxt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
        return `â•â•â• ç¬¬ ${s.number} é  â•â•â•\n\n${titleTxt}\n\n${contentTxt}`;
    }).join('\n\n\n');
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast('âœ… å…¨éƒ¨å·²è¤‡è£½','ok');
    copied=copied.map(()=>true);
    updateCopyDots();
}

// HTML æ’­æ”¾
function openHtml(){
    ssIdx=0;ssItemIdx=-1;
    slideAnims=slides.map(s=>{
        const items=Array.isArray(s.content)?s.content.length:s.content?1:0;
        return{title:Math.floor(Math.random()*20),subtitle:Math.floor(Math.random()*20),items:Array(items).fill(0).map(()=>Math.floor(Math.random()*20))};
    });
    renderSS();
    document.getElementById('htmlModal').classList.add('on');
}
function closeHtml(){document.getElementById('htmlModal').classList.remove('on');}

function renderSS(){
    const theme=themes.find(t=>t.id===themeId)||themes[0];
    document.getElementById('slideshow').innerHTML=slides.map((s,i)=>{
        const anim=slideAnims[i];
        const titleAnim=animations[anim.title];
        const subAnim=animations[anim.subtitle];
        let items='';
        if(Array.isArray(s.content)){
            items=s.content.map((c,j)=>{
                const itemAnim=animations[anim.items[j]];
                return `<div class="ss-item" data-idx="${j}" style="${itemAnim.style}" data-show="${itemAnim.show}">â€¢ ${esc(c)}</div>`;
            }).join('');
        }else if(s.content){
            const itemAnim=animations[anim.items[0]];
            items=`<div class="ss-item" data-idx="0" style="${itemAnim.style}" data-show="${itemAnim.show}">${esc(s.content)}</div>`;
        }
        return `<div class="ss-slide ${i===0?'on':''}" style="background:${theme.css};color:#fff" data-i="${i}">
            <div class="ss-title" style="${titleAnim.style}" data-show="${titleAnim.show}">${esc(s.title)}</div>
            ${s.subtitle?`<div class="ss-subtitle" style="${subAnim.style}" data-show="${subAnim.show}">${esc(s.subtitle)}</div>`:''}
            <div class="ss-content">${items}</div>
            <div class="ss-num">${s.number}/${slides.length}</div>
            <div class="ss-hint">ç©ºç™½éµ = ä¸‹ä¸€æ®µ</div>
            <div class="ss-anim-name" id="animName${i}"></div>
        </div>`;
    }).join('');
    updateSS();
}

function updateSS(){
    document.querySelectorAll('.ss-slide').forEach((s,i)=>s.classList.toggle('on',i===ssIdx));
    document.getElementById('ssCounter').textContent=`${ssIdx+1}/${slides.length}`;
    ssItemIdx=-1;
}

function ssNextItem(){
    const slide=document.querySelector(`.ss-slide[data-i="${ssIdx}"]`);
    if(!slide)return;
    const title=slide.querySelector('.ss-title');
    const subtitle=slide.querySelector('.ss-subtitle');
    const items=slide.querySelectorAll('.ss-item');
    const animNameEl=document.getElementById('animName'+ssIdx);
    ssItemIdx++;
    if(ssItemIdx===0){
        if(title){title.style.cssText=title.dataset.show;animNameEl.textContent=animations[slideAnims[ssIdx].title].name;}
    }else if(ssItemIdx===1&&subtitle){
        subtitle.style.cssText=subtitle.dataset.show;animNameEl.textContent=animations[slideAnims[ssIdx].subtitle].name;
    }else{
        const itemIdx=subtitle?ssItemIdx-2:ssItemIdx-1;
        if(itemIdx<items.length){
            items[itemIdx].style.cssText=items[itemIdx].dataset.show;
            animNameEl.textContent=animations[slideAnims[ssIdx].items[itemIdx]].name;
        }else{
            if(ssIdx<slides.length-1){ssIdx++;updateSS();}
        }
    }
}

function ssPrev(){if(ssIdx>0){ssIdx--;updateSS();}}
function ssNext(){if(ssIdx<slides.length-1){ssIdx++;updateSS();}}
function ssFullscreen(){
    const el=document.getElementById('slideshow');
    if(el.requestFullscreen)el.requestFullscreen();
    else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
}

function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function toast(m,t='ok'){const el=document.createElement('div');el.className='toast '+t;el.innerHTML=m;document.getElementById('toastBox').appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),300);},2500);}

document.querySelectorAll('.modal-bg').forEach(m=>m.onclick=e=>{if(e.target===m)m.classList.remove('on');});

document.addEventListener('keydown',e=>{
    if(!document.getElementById('htmlModal').classList.contains('on'))return;
    if(e.key===' '){e.preventDefault();ssNextItem();}
    if(e.key==='ArrowRight'){e.preventDefault();ssNextItem();}
    if(e.key==='ArrowLeft'){e.preventDefault();ssPrev();}
    if(e.key==='ArrowDown'){e.preventDefault();ssNext();}
});

document.getElementById('slideshow')?.addEventListener('click',ssNextItem);
</script>
</body>
</html>
