<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SlideGenie Pro | AI ç°¡å ±ç”¢ç”Ÿå™¨</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#030614">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root{--bg-primary:#030614;--bg-secondary:#0a1628;--bg-card:#0d1f3c;--text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#64748b;--cyan:#00f5ff;--purple:#a855f7;--pink:#ec4899;--green:#10b981;--orange:#f59e0b;--red:#ef4444;--border:rgba(0,245,255,0.15);--glow-cyan:0 0 20px rgba(0,245,255,0.4);--grad-cyan:linear-gradient(135deg,#00f5ff,#0891b2);--grad-purple:linear-gradient(135deg,#a855f7,#6366f1);--grad-green:linear-gradient(135deg,#10b981,#059669);--grad-orange:linear-gradient(135deg,#f59e0b,#ea580c);--grad-pink:linear-gradient(135deg,#ec4899,#be185d)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;min-height:100dvh;font-size:14px}
.bg-grid{position:fixed;inset:0;background-image:linear-gradient(rgba(0,245,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.03) 1px,transparent 1px);background-size:50px 50px;pointer-events:none}
.bg-glow{position:fixed;width:400px;height:400px;border-radius:50%;filter:blur(100px);opacity:0.1;pointer-events:none}.bg-glow-1{top:-150px;right:-150px;background:var(--cyan)}.bg-glow-2{bottom:-150px;left:-150px;background:var(--purple)}

.splash{position:fixed;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:all 0.8s}.splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
.splash-logo{width:100px;height:100px;position:relative;margin-bottom:24px}
.splash-logo-inner{width:100%;height:100%;background:var(--bg-card);border:2px solid var(--cyan);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:48px;animation:logoSpin 2s ease-in-out;box-shadow:0 0 30px rgba(0,245,255,0.5)}
@keyframes logoSpin{0%{transform:rotateY(0) scale(0.3);opacity:0}50%{transform:rotateY(180deg) scale(1.1)}100%{transform:rotateY(360deg) scale(1)}}
.splash-ring{position:absolute;border:2px solid transparent;border-radius:50%;animation:ring linear infinite}.splash-ring:nth-child(1){width:130px;height:130px;top:-15px;left:-15px;border-top-color:var(--cyan);animation-duration:3s}.splash-ring:nth-child(2){width:150px;height:150px;top:-25px;left:-25px;border-top-color:var(--purple);animation-duration:4s;animation-direction:reverse}
@keyframes ring{to{transform:rotate(360deg)}}
.splash-text{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;background:var(--grad-cyan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;animation:fadeUp 0.6s ease forwards 0.8s}
.splash-sub{font-size:11px;color:var(--text-muted);margin-top:6px;opacity:0;animation:fadeUp 0.6s ease forwards 1.2s}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}from{opacity:0;transform:translateY(12px)}}
.splash-dots{display:flex;gap:8px;margin-top:32px;opacity:0;animation:fadeUp 0.6s ease forwards 1.6s}
.splash-dots span{width:8px;height:8px;background:var(--cyan);border-radius:50%;animation:pulse 1.2s ease-in-out infinite}.splash-dots span:nth-child(2){animation-delay:0.2s;background:var(--purple)}.splash-dots span:nth-child(3){animation-delay:0.4s;background:var(--pink)}
@keyframes pulse{0%,80%,100%{transform:scale(0.6)}40%{transform:scale(1.2)}}

.app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh;min-height:100dvh;opacity:0;transition:opacity 0.6s}.app.show{opacity:1}
.header{padding:10px 12px;background:rgba(10,22,40,0.9);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:8px}
.logo-icon{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--cyan);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:var(--glow-cyan)}
.logo-text{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;background:var(--grad-cyan);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-btns{display:flex;gap:6px}
.h-btn{width:36px;height:36px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--cyan);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}.h-btn:active{transform:scale(0.95)}

.main{flex:1;padding:12px;padding-bottom:130px;overflow-y:auto}
.sec{margin-bottom:14px}
.sec-title{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;display:flex;align-items:center;gap:6px;letter-spacing:1.5px;text-transform:uppercase}
.sec-title::before{content:'';width:2px;height:10px;background:var(--grad-cyan);border-radius:2px}
.card{background:rgba(13,31,60,0.5);backdrop-filter:blur(8px);border-radius:12px;padding:12px;border:1px solid var(--border)}
.inp{width:100%;padding:10px 12px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit;outline:none}.inp:focus{border-color:var(--cyan)}
.inp::placeholder{color:var(--text-muted)}
textarea.inp{min-height:60px;resize:none;line-height:1.4}
.inp-label{font-size:10px;color:var(--text-secondary);margin:10px 0 5px;display:block}

/* API Key å€å¡Š */
.api-sec{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:14px}
.api-label{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;letter-spacing:1px}
.api-row{display:flex;gap:6px}
.api-inp{flex:1;padding:10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:12px;font-family:monospace}
.api-btn{padding:10px 14px;background:var(--grad-cyan);border:none;border-radius:8px;color:#030614;font-size:10px;font-weight:700;font-family:'Orbitron',sans-serif;cursor:pointer;white-space:nowrap}
.api-btn:disabled{opacity:0.5}
.api-stat{margin-top:8px;padding:8px 10px;border-radius:8px;font-size:11px;display:none}
.api-stat.on{display:flex;align-items:center;gap:6px}
.api-stat.ok{background:rgba(34,197,94,0.1);color:#22c55e;border:1px solid rgba(34,197,94,0.3)}
.api-stat.err{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
.api-stat.wait{background:rgba(0,245,255,0.1);color:var(--cyan);border:1px solid rgba(0,245,255,0.3)}
.api-hint{font-size:10px;color:var(--text-muted);margin-top:6px}.api-hint a{color:var(--cyan)}

.tool-btn{padding:6px 10px;background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,0.3);border-radius:8px;color:var(--purple);font-size:10px;cursor:pointer;transition:all 0.2s}
.tool-btn:hover,.tool-btn:active{background:rgba(168,85,247,0.3);border-color:var(--purple)}
.tool-btn.recording{background:rgba(239,68,68,0.3);border-color:var(--red);color:var(--red);animation:pulse 1s infinite}

.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:6px 10px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:16px;color:var(--text-secondary);font-size:11px;cursor:pointer}
.chip.on{border-color:var(--cyan);color:#fff;background:var(--grad-cyan);box-shadow:var(--glow-cyan)}

.slider-row{display:flex;align-items:center;gap:12px}
.slider{flex:1;-webkit-appearance:none;height:5px;background:rgba(0,245,255,0.1);border-radius:3px}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--grad-cyan);border-radius:50%;box-shadow:var(--glow-cyan)}
.slider-val{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:600;color:var(--cyan);min-width:40px;text-align:center}
.slider-info{font-size:10px;color:var(--text-muted);margin-top:6px;text-align:center}

.style-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.style-card{padding:8px 4px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:8px;text-align:center;cursor:pointer}
.style-card.on{border-color:var(--cyan);background:rgba(0,245,255,0.08);box-shadow:var(--glow-cyan)}
.style-icon{font-size:20px;margin-bottom:2px}
.style-name{font-size:9px}

.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.theme-card{aspect-ratio:16/10;border-radius:8px;cursor:pointer;border:2px solid transparent;position:relative;overflow:hidden}
.theme-card.on{border-color:var(--cyan);box-shadow:var(--glow-cyan)}
.theme-card::after{content:attr(data-name);position:absolute;bottom:0;left:0;right:0;padding:3px;background:rgba(0,0,0,0.6);font-size:8px;text-align:center;color:#fff}

.output-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.out-card{padding:12px 8px;background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;text-align:center;cursor:pointer}
.out-card.on{border-color:var(--cyan);box-shadow:var(--glow-cyan)}
.out-card[data-v="canva"].on{border-color:var(--purple);box-shadow:0 0 20px rgba(168,85,247,0.4)}
.out-card[data-v="html"].on{border-color:var(--green);box-shadow:0 0 20px rgba(16,185,129,0.4)}
.out-icon{font-size:24px;margin-bottom:4px}
.out-name{font-size:11px;font-weight:600}
.out-desc{font-size:9px;color:var(--text-muted);margin-top:2px}

.gen-sec{padding:12px;background:rgba(10,22,40,0.95);backdrop-filter:blur(16px);border-top:1px solid var(--border);position:fixed;bottom:0;left:0;right:0}
.gen-btn{width:100%;padding:14px;background:var(--grad-cyan);border:none;border-radius:10px;color:#030614;font-size:14px;font-weight:700;font-family:'Orbitron',sans-serif;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:var(--glow-cyan)}
.gen-btn:active{transform:scale(0.98)}
.gen-btn:disabled{opacity:0.5}
.gen-btn.canva{background:var(--grad-purple);box-shadow:0 0 20px rgba(168,85,247,0.4)}
.gen-btn.html{background:var(--grad-green);box-shadow:0 0 20px rgba(16,185,129,0.4)}
.spinner{width:18px;height:18px;border:2px solid rgba(3,6,20,0.3);border-top-color:#030614;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.prog{margin-top:10px;display:none}.prog.on{display:block}
.prog-bar{height:4px;background:rgba(0,245,255,0.1);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:var(--grad-cyan);width:0%;transition:width 0.3s}
.prog-txt{font-size:11px;color:var(--cyan);margin-top:6px;text-align:center}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(3,6,20,0.92);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:flex-end;opacity:0;visibility:hidden;transition:all 0.3s}.modal-bg.on{opacity:1;visibility:visible}
.modal{width:100%;max-height:90vh;max-height:90dvh;background:var(--bg-secondary);border-radius:16px 16px 0 0;border:1px solid var(--border);border-bottom:none;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.35s}.modal-bg.on .modal{transform:translateY(0)}
.modal-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(13,31,60,0.4)}
.modal-title{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--cyan);letter-spacing:1px}
.modal-x{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-size:14px;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:14px}
.modal-foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;background:rgba(13,31,60,0.4);flex-wrap:wrap}
.m-btn{flex:1;padding:12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:5px;min-width:80px}
.m-btn-sec{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)}
.m-btn-pri{background:var(--grad-cyan);border:none;color:#030614}
.m-btn-orange{background:var(--grad-orange);border:none;color:#fff}
.m-btn-green{background:var(--grad-green);border:none;color:#fff}
.m-btn-purple{background:var(--grad-purple);border:none;color:#fff}
.m-btn-cyan{background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;color:#fff}

/* è¨­å®š */
.set-sec{margin-bottom:20px}
.set-label{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);margin-bottom:8px;letter-spacing:1px}
.model-custom{margin-top:10px}
.model-custom-row{display:flex;gap:6px;margin-top:6px}
.model-custom-inp{flex:1;padding:8px 10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:11px;font-family:monospace}
.model-custom-btn{padding:8px 12px;background:var(--grad-purple);border:none;border-radius:6px;color:#fff;font-size:10px;font-weight:600;cursor:pointer}
.model-hint{font-size:9px;color:var(--text-muted);margin-top:6px}

/* é è¦½ */
.slides-list{display:flex;flex-direction:column;gap:10px}
.slide-card{background:rgba(13,31,60,0.5);border-radius:10px;border:1px solid var(--border);overflow:hidden}
.slide-head{padding:8px 12px;background:rgba(3,6,20,0.4);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.slide-num{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--cyan)}
.slide-type{font-size:9px;color:var(--text-muted);padding:2px 8px;background:rgba(0,245,255,0.1);border-radius:10px}
.slide-actions{display:flex;gap:4px}
.slide-action{width:26px;height:26px;background:var(--bg-card);border:1px solid var(--border);border-radius:5px;color:var(--text-secondary);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.slide-body{padding:12px}
.slide-title{font-size:14px;font-weight:600;margin-bottom:8px}
.slide-content{font-size:12px;color:var(--text-secondary);line-height:1.5}
.slide-content ul{margin:6px 0;padding-left:16px}
.slide-content li{margin-bottom:4px}
.slide-content li::marker{color:var(--cyan)}
.slide-notes{margin-top:10px;padding-top:10px;border-top:1px dashed var(--border);font-size:10px;color:var(--text-muted);font-style:italic}
.slide-img{margin-top:8px;padding:6px 10px;background:rgba(168,85,247,0.1);border-radius:6px;font-size:10px;color:var(--purple)}

/* å¤§ç¶± */
.outline-card{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.outline-title{font-size:13px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.outline-list{font-size:12px;color:var(--text-secondary);line-height:1.6}
.outline-item{padding:5px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.outline-item:last-child{border-bottom:none}
.outline-num{font-family:'Orbitron',sans-serif;font-size:9px;color:var(--cyan);min-width:20px}

/* Canva */
.canva-modal .modal{background:var(--bg-primary)}
.copy-card{background:rgba(13,31,60,0.6);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.copy-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.copy-page{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--purple)}
.copy-progress{font-size:11px;color:var(--text-muted)}
.copy-type{display:inline-block;padding:3px 10px;background:rgba(168,85,247,0.2);color:var(--purple);border-radius:10px;font-size:10px;margin-bottom:10px}
.copy-title{font-size:15px;font-weight:600;margin-bottom:10px;line-height:1.3}
.copy-content{font-size:12px;color:var(--text-secondary);line-height:1.5;white-space:pre-wrap}
.copy-notes{margin-top:10px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;color:var(--text-muted)}
.copy-img{margin-top:8px;padding:6px 10px;background:rgba(168,85,247,0.15);border-radius:6px;font-size:10px;color:var(--purple)}
.copy-btn{width:100%;padding:14px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;border:none;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:8px}
.copy-btn:active{transform:scale(0.97)}
.copy-btn.copy{background:var(--grad-purple);color:#fff}
.copy-btn.copy.done{background:var(--grad-green)}
.copy-nav{display:flex;gap:8px}
.copy-nav .copy-btn{flex:1;padding:12px;margin:0}
.copy-btn.nav{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)}
.copy-dots{display:flex;justify-content:center;gap:5px;margin:12px 0;flex-wrap:wrap}
.copy-dot{width:7px;height:7px;border-radius:50%;background:rgba(168,85,247,0.3);cursor:pointer}
.copy-dot.on{background:var(--purple);box-shadow:0 0 6px var(--purple)}
.copy-dot.done{background:var(--green)}
.copy-actions{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.copy-all-btn{width:100%;padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:12px;cursor:pointer;margin-bottom:8px}
.canva-link{display:block;width:100%;padding:12px;background:var(--grad-purple);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:600;text-align:center;text-decoration:none}

/* HTML æ’­æ”¾ */
.html-modal .modal-body{padding:0}
.slideshow-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden}
.slideshow{position:absolute;inset:0;overflow:hidden}
.ss-slide{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6%;opacity:0;pointer-events:none}
.ss-slide.on{opacity:1;pointer-events:auto}
.ss-title{font-size:clamp(40px,9vw,96px);font-weight:700;text-align:center;margin-bottom:3%}
.ss-subtitle{font-size:clamp(24px,4.4vw,48px);opacity:0.75;margin-bottom:3%;text-align:center}
.ss-content{width:100%;max-width:85%}
.ss-with-image{display:flex;gap:30px;width:98%;max-width:1600px;margin-top:20px;align-items:flex-start}
.ss-image-left{flex:0 0 65%}
.ss-image-left img{width:100%;max-height:85vh;object-fit:contain;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.5)}
.ss-content-right{flex:1;text-align:left}
.ss-text-item{font-size:clamp(18px,3.5vw,36px);padding:12px 0;opacity:1;line-height:1.5;border-bottom:1px solid rgba(255,255,255,0.15)}
.ss-text-item:last-child{border-bottom:none}
.ss-item{font-size:clamp(12px,2.2vw,22px);padding:10px 0;opacity:0;border-bottom:1px solid rgba(255,255,255,0.1)}
.ss-item:last-child{border-bottom:none}
.ss-num{position:absolute;bottom:2%;right:3%;font-size:clamp(9px,1.3vw,12px);opacity:0.4}
.ss-hint{position:absolute;bottom:2%;left:50%;transform:translateX(-50%);font-size:clamp(8px,1vw,10px);opacity:0.2}
.ss-anim-name{position:absolute;top:2%;right:3%;font-size:9px;opacity:0.3;font-family:'Orbitron',sans-serif}
.ss-controls{display:flex;justify-content:center;align-items:center;gap:8px;padding:12px;flex-wrap:wrap}
.ss-btn{padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;cursor:pointer}
.ss-btn.pri{background:var(--grad-green);border:none;color:#030614;font-weight:600}
.ss-counter{padding:8px 14px;font-family:'Orbitron',sans-serif;font-size:11px;color:var(--green)}
.ss-next-hint{text-align:center;padding:4px;font-size:10px;color:var(--text-muted)}
.slideshow:fullscreen,.slideshow:-webkit-full-screen{width:100vw!important;height:100vh!important}

/* è¨ˆæ™‚å™¨ */
.ss-timer{position:absolute;top:10px;right:10px;padding:8px 14px;background:rgba(0,0,0,0.7);border-radius:8px;font-family:'Orbitron',sans-serif;font-size:18px;color:var(--cyan);display:none;z-index:10}
.ss-timer.on{display:block}
.ss-timer.warn{color:var(--orange);animation:timerPulse 1s infinite}
.ss-timer.danger{color:var(--red);animation:timerPulse 0.5s infinite}
.ss-timer-fs{position:absolute;top:20px;right:20px;padding:12px 20px;background:rgba(0,0,0,0.8);border-radius:10px;font-family:'Orbitron',sans-serif;font-size:24px;color:#00f5ff;display:none;z-index:100}
.ss-timer-fs.on{display:block}
.ss-timer-fs.warn{color:#f59e0b;animation:timerPulse 1s infinite}
.ss-timer-fs.danger{color:#ef4444;animation:timerPulse 0.5s infinite}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* è¨­å®šæ–°å…ƒç´  */
.color-picker{width:40px;height:30px;border:none;border-radius:6px;cursor:pointer;background:transparent}
.timer-inp{width:60px;padding:8px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--cyan);font-family:'Orbitron',sans-serif;font-size:14px;text-align:center}

/* æ·ºè‰²ä¸»é¡Œ */
body.light{--bg-primary:#f8fafc;--bg-secondary:#e2e8f0;--bg-card:#ffffff;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--border:rgba(0,0,0,0.1)}
body.light .splash{background:#f8fafc}
body.light .header{background:rgba(255,255,255,0.9)}
body.light .card{background:rgba(255,255,255,0.8)}
body.light .gen-sec{background:rgba(255,255,255,0.95)}
body.light .modal{background:#f8fafc}

/* æ¸¬é©— Modal */
.quiz-q{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px}
.quiz-q-title{font-weight:600;margin-bottom:10px;color:var(--cyan)}
.quiz-opts{display:flex;flex-direction:column;gap:8px}
.quiz-opt{padding:10px 14px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.2s}
.quiz-opt:hover{border-color:var(--cyan)}
.quiz-opt.correct{background:rgba(16,185,129,0.2);border-color:var(--green);color:var(--green)}
.quiz-opt.wrong{background:rgba(239,68,68,0.2);border-color:var(--red);color:var(--red)}
.quiz-score{text-align:center;font-family:'Orbitron',sans-serif;font-size:32px;color:var(--cyan);margin:20px 0}

/* PDF å·¥å…· */
.pdf-tools-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.pdf-tool-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:all 0.2s}
.pdf-tool-card:hover{border-color:var(--cyan);transform:translateY(-2px)}
.pdf-tool-icon{font-size:32px;margin-bottom:8px}
.pdf-tool-name{font-weight:600;color:var(--text-primary);margin-bottom:4px}
.pdf-tool-desc{font-size:11px;color:var(--text-muted)}
.pdf-tool-status{margin-top:16px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:12px;color:var(--text-secondary);display:none}
.pdf-tool-status.on{display:block}
.pdf-tool-result{margin-top:12px}
.pdf-info{background:rgba(6,182,212,0.1);border:1px solid var(--cyan);border-radius:8px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--cyan)}

/* æå–åœ–ç‰‡çµæœ */
.extracted-images-header{margin-bottom:16px}
.extracted-images-header h3{font-size:14px;color:var(--cyan);margin-bottom:12px}
.extracted-actions{display:flex;gap:8px;flex-wrap:wrap}
.extracted-images-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;max-height:400px;overflow-y:auto;padding:4px}
.extracted-img-card{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:6px;text-align:center}
.extracted-img-card img{width:100%;height:60px;object-fit:contain;cursor:pointer;border-radius:4px;background:#000}
.extracted-img-card img:hover{opacity:0.8}
.extracted-img-info{font-size:9px;color:var(--text-muted);margin-top:4px}
.extracted-img-check{display:flex;align-items:center;justify-content:center;gap:4px;font-size:10px;color:var(--text-secondary);margin-top:2px}
.extracted-img-check input{width:12px;height:12px}

/* ç·¨è¼¯ */
.edit-field{margin-bottom:14px}
.edit-label{font-size:10px;color:var(--text-secondary);margin-bottom:5px;display:block}
.edit-inp{width:100%;padding:10px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px;font-family:inherit}
textarea.edit-inp{min-height:100px;resize:none;line-height:1.4}

/* æ­·å² */
.hist-list{display:flex;flex-direction:column;gap:8px}
.hist-item{background:rgba(13,31,60,0.5);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;justify-content:space-between;align-items:center}
.hist-info{flex:1}
.hist-title{font-size:13px;font-weight:500;margin-bottom:3px}
.hist-meta{font-size:10px;color:var(--text-muted)}
.hist-btns{display:flex;gap:6px}
.hist-btn{width:32px;height:32px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;font-size:13px}
.empty{text-align:center;padding:30px;color:var(--text-muted)}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3}

/* å·¥å…·æŒ‰éˆ• */
.tool-btn{padding:8px 12px;background:rgba(0,245,255,0.1);border:1px solid var(--border);border-radius:8px;color:var(--cyan);font-size:11px;cursor:pointer;transition:all 0.2s}
.tool-btn:hover{background:rgba(0,245,255,0.2);border-color:var(--cyan)}
.tool-btn:active{transform:scale(0.95)}
.tool-btn.recording{background:rgba(239,68,68,0.2);border-color:#ef4444;color:#ef4444;animation:pulse-rec 1s infinite}
@keyframes pulse-rec{0%,100%{opacity:1}50%{opacity:0.5}}

/* ç¶²å€/æ•¸æ“š Modal å…§å®¹ */
.input-modal-content{padding:16px}
.input-modal-content textarea{width:100%;min-height:120px;padding:12px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px;font-family:inherit;resize:none}
.input-modal-content p{font-size:11px;color:var(--text-muted);margin-top:8px}
.data-example{background:rgba(0,245,255,0.05);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:10px;font-size:11px;color:var(--text-secondary);font-family:monospace;white-space:pre-wrap}

/* åœ–ç‰‡é è¦½ */
.img-preview{max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;border:1px solid var(--border)}
.file-info{padding:10px;background:rgba(0,245,255,0.05);border-radius:8px;margin-top:10px;font-size:11px;color:var(--text-secondary)}

.toast-box{position:fixed;top:60px;left:12px;right:12px;z-index:2000;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{padding:12px 14px;background:rgba(13,31,60,0.95);backdrop-filter:blur(8px);border-radius:10px;display:flex;align-items:center;gap:8px;font-size:12px;animation:toastIn 0.3s;pointer-events:auto;border:1px solid var(--border)}
.toast.ok{border-left:3px solid #22c55e}
.toast.err{border-left:3px solid #ef4444}
.toast.warn{border-left:3px solid #f59e0b}
@keyframes toastIn{from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1}}

/* è©•åˆ†çµæœ */

/* AI åŠ©æ•™èŠå¤© */
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.chat-welcome{text-align:center;color:var(--text-muted);font-size:12px;padding:20px;line-height:1.8}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.6}
.chat-msg.user{align-self:flex-end;background:var(--grad-cyan);color:#030614}
.chat-msg.ai{align-self:flex-start;background:rgba(13,31,60,0.8);color:var(--text-primary);border:1px solid var(--border)}
.chat-msg.loading{opacity:0.7}
.chat-msg.error{color:var(--red)}
.chat-quick{display:flex;gap:6px;padding:10px;overflow-x:auto;border-top:1px solid var(--border)}
.chat-quick button{padding:6px 12px;background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,0.3);border-radius:16px;color:var(--purple);font-size:10px;white-space:nowrap;cursor:pointer}
.chat-input-area{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:rgba(13,31,60,0.4)}
.chat-input-area input{flex:1;padding:10px 14px;background:rgba(3,6,20,0.5);border:1px solid var(--border);border-radius:20px;color:var(--text-primary);font-size:13px}
.chat-input-area button{padding:10px 18px;background:var(--grad-cyan);border:none;border-radius:20px;color:#030614;font-weight:600;font-size:12px;cursor:pointer}

/* QR Code */
.qr-image{width:200px;height:200px;margin:20px auto;display:block;border-radius:12px;background:#fff;padding:10px}
.qr-info{text-align:center;margin:16px 0}
.qr-topic{font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:4px}
.qr-meta{font-size:12px;color:var(--text-muted)}
.qr-btns{display:flex;gap:10px;justify-content:center;margin-top:16px}

/* å­¸ç¿’ç›®æ¨™ */

@media(min-width:640px){
.main{max-width:520px;margin:0 auto}
.gen-sec{max-width:520px;left:50%;transform:translateX(-50%);border-radius:16px 16px 0 0}
.modal{max-width:560px;margin:0 auto;border-radius:16px;max-height:85vh;border:1px solid var(--border)}
.modal-bg{align-items:center;padding:16px}
.html-modal .modal{max-width:850px}
.html-modal.mobile-fs{background:#000;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999}
.html-modal.mobile-fs .modal{width:100vw;height:100vh;max-width:100vw;max-height:100vh;border-radius:0;margin:0;padding:0}
.html-modal.mobile-fs .modal-head{display:none}
.html-modal.mobile-fs .modal-body{height:100vh;padding:0;overflow:hidden}
.html-modal.mobile-fs .slideshow-wrap{height:100vh;width:100vw;aspect-ratio:auto}
.html-modal.mobile-fs .slideshow{height:100%;width:100%}
.html-modal.mobile-fs .ss-slide{height:100vh;padding:15px;box-sizing:border-box}
.html-modal.mobile-fs .ss-title{font-size:clamp(24px,6vw,48px)!important;margin-bottom:10px}
.html-modal.mobile-fs .ss-text-item{font-size:clamp(14px,3.5vw,24px)!important;padding:8px 0}
.html-modal.mobile-fs .ss-item{font-size:clamp(14px,3.5vw,24px)!important}
.html-modal.mobile-fs .ss-with-image{flex-direction:column;gap:15px;width:100%;max-width:100%}
.html-modal.mobile-fs .ss-image-left{flex:none;width:100%;max-height:45vh}
.html-modal.mobile-fs .ss-image-left img{max-height:45vh;width:auto;max-width:100%}
.html-modal.mobile-fs .ss-content-right{width:100%;max-height:35vh;overflow-y:auto}
.html-modal.mobile-fs .ss-controls{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);padding:10px;z-index:100;display:flex;justify-content:center;gap:10px}
.html-modal.mobile-fs .ss-controls button{padding:12px 16px;font-size:16px}
.html-modal.mobile-fs .ss-num{font-size:14px;bottom:60px}
.html-modal.mobile-fs .ss-hint{display:none}
.html-modal.mobile-fs .ss-timer{top:10px;right:10px;font-size:16px}
.html-modal.mobile-fs+.modal-foot{display:none}

/* æ‰‹æ©Ÿæ©«æ”¾æ™‚ï¼šå·¦åœ–å³æ–‡ */
@media screen and (orientation:landscape) and (max-height:500px){
.html-modal.mobile-fs .ss-slide{padding:10px 15px}
.html-modal.mobile-fs .ss-title{font-size:clamp(18px,4vw,32px)!important;margin-bottom:5px}
.html-modal.mobile-fs .ss-with-image{flex-direction:row!important;gap:20px;align-items:flex-start}
.html-modal.mobile-fs .ss-image-left{flex:0 0 50%;max-height:75vh;width:auto}
.html-modal.mobile-fs .ss-image-left img{max-height:70vh;max-width:100%;width:auto}
.html-modal.mobile-fs .ss-content-right{flex:1;max-height:70vh;overflow-y:auto}
.html-modal.mobile-fs .ss-text-item{font-size:clamp(12px,2.5vw,18px)!important;padding:5px 0}
.html-modal.mobile-fs .ss-controls{padding:6px}
.html-modal.mobile-fs .ss-controls button{padding:8px 12px;font-size:14px}
.html-modal.mobile-fs .ss-num{bottom:50px;font-size:12px}
}
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow bg-glow-1"></div>
<div class="bg-glow bg-glow-2"></div>

<div class="splash" id="splash">
    <div class="splash-logo">
        <div class="splash-ring"></div>
        <div class="splash-ring"></div>
        <div class="splash-logo-inner">ğŸ“Š</div>
    </div>
    <div class="splash-text">SLIDEGENIE PRO</div>
    <div class="splash-sub">âœ¨ AI ç°¡å ±ç”¢ç”Ÿå™¨ âœ¨</div>
    <div class="splash-dots"><span></span><span></span><span></span></div>
</div>

<div class="app" id="app">
    <header class="header">
        <div class="logo"><div class="logo-icon">ğŸ“Š</div><div class="logo-text">SLIDEGENIE</div></div>
        <div class="header-btns"><button class="h-btn" onclick="openHist()">ğŸ“‹</button><button class="h-btn" onclick="openSet()">âš™ï¸</button></div>
    </header>

    <main class="main">
        <!-- API Key -->
        <div class="api-sec">
            <div class="api-label">ğŸ”‘ GEMINI API KEY</div>
            <div class="api-row">
                <input type="password" class="api-inp" id="apiInp" placeholder="è²¼ä¸Š API Key...">
                <button class="api-btn" id="verifyBtn" onclick="verifyKey()">é©—è­‰</button>
                <button class="api-btn" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)" onclick="clearKey()">âœ•</button>
            </div>
            <div class="api-stat" id="apiStat"></div>
            <p class="api-hint">ğŸ‘‰ <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> å…è²»å–å¾— Â· ğŸ”’ ä¸å„²å­˜</p>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“ ä¸»é¡Œ</div>
            <div class="card">
                <input type="text" class="inp" id="topicInp" placeholder="ä¾‹å¦‚ï¼šç‰›é “é‹å‹•å®šå¾‹">
                <label class="inp-label">ğŸ’¬ è£œå……èªªæ˜</label>
                <textarea class="inp" id="detailInp" placeholder="é‡é»ã€éœ€æ±‚..."></textarea>
                <div class="tool-btns" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px">
                    <button class="tool-btn" onclick="startVoice()">ğŸ¤ èªéŸ³</button>
                    <button class="tool-btn" onclick="document.getElementById('imgUpload').click()">ğŸ“¸ åœ–ç‰‡</button>
                    <button class="tool-btn" onclick="document.getElementById('fileUpload').click()">ğŸ“„ æ–‡ä»¶</button>
                    <button class="tool-btn" onclick="openUrlModal()">ğŸ”— ç¶²å€</button>
                    <button class="tool-btn" onclick="openDataModal()">ğŸ“Š æ•¸æ“š</button>
                    <button class="tool-btn" onclick="randomTopic()">ğŸ² éš¨æ©Ÿ</button>
                    <button class="tool-btn" onclick="openPdfTools()">ğŸ“‘ PDFå·¥å…·</button>
                </div>
                <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImage(this)">
                <input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.txt,.md" style="display:none" onchange="handleFile(this)">
                <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="handlePdfUpload(this)">
                <input type="file" id="pdfMergeUpload" accept=".pdf" multiple style="display:none" onchange="handlePdfMerge(this)">
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ‘¥ å°è±¡</div>
            <div class="chips" id="audChips">
                <div class="chip" data-v="elementary">ğŸ‘¶ åœ‹å°</div>
                <div class="chip on" data-v="junior">ğŸ’ åœ‹ä¸­</div>
                <div class="chip" data-v="senior">ğŸ“š é«˜ä¸­</div>
                <div class="chip" data-v="college">ğŸ“ å¤§å­¸</div>
                <div class="chip" data-v="general">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§çœ¾</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸŒ èªè¨€</div>
            <div class="chips" id="langChips">
                <div class="chip on" data-v="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</div>
                <div class="chip" data-v="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</div>
                <div class="chip" data-v="en">ğŸ‡ºğŸ‡¸ English</div>
                <div class="chip" data-v="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ¯ é›£åº¦</div>
            <div class="chips" id="diffChips">
                <div class="chip on" data-v="basic">ğŸŒ± åŸºç¤</div>
                <div class="chip" data-v="intermediate">ğŸŒ¿ é€²éš</div>
                <div class="chip" data-v="advanced">ğŸŒ³ å°ˆæ¥­</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“„ é æ•¸</div>
            <div class="card">
                <div class="slider-row">
                    <input type="range" class="slider" id="countSlider" min="5" max="100" value="10">
                    <div class="slider-val" id="countVal">10</div>
                </div>
                <div class="slider-info" id="timeEst">â±ï¸ ç´„ 10 åˆ†é˜</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ¨ é¢¨æ ¼</div>
            <div class="style-grid" id="styleGrid">
                <div class="style-card on" data-v="professional"><div class="style-icon">ğŸ’¼</div><div class="style-name">å°ˆæ¥­</div></div>
                <div class="style-card" data-v="creative"><div class="style-icon">ğŸ¨</div><div class="style-name">å‰µæ„</div></div>
                <div class="style-card" data-v="minimal"><div class="style-icon">âœ¨</div><div class="style-name">ç°¡ç´„</div></div>
                <div class="style-card" data-v="fun"><div class="style-icon">ğŸˆ</div><div class="style-name">æ´»æ½‘</div></div>
                <div class="style-card" data-v="tech"><div class="style-icon">ğŸš€</div><div class="style-name">ç§‘æŠ€</div></div>
                <div class="style-card" data-v="nature"><div class="style-icon">ğŸŒ¿</div><div class="style-name">è‡ªç„¶</div></div>
                <div class="style-card" data-v="elegant"><div class="style-icon">ğŸ‘‘</div><div class="style-name">å„ªé›…</div></div>
                <div class="style-card" data-v="neon"><div class="style-icon">ğŸ’œ</div><div class="style-name">éœ“è™¹</div></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸŒˆ ä¸»é¡Œè‰²</div>
            <div class="card">
                <div class="theme-grid" id="themeGrid"></div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“¦ å…§å®¹</div>
            <div class="chips" id="incChips">
                <div class="chip on" data-v="examples">ğŸ’¡ å¯¦ä¾‹</div>
                <div class="chip on" data-v="diagrams">ğŸ“Š åœ–è¡¨</div>
                <div class="chip" data-v="quiz">â“ æ¸¬é©—</div>
                <div class="chip" data-v="notes">ğŸ“ å‚™è¨»</div>
                <div class="chip on" data-v="summary">ğŸ“Œ ç¸½çµ</div>
                <div class="chip on" data-v="images">ğŸ–¼ï¸ åœ–ç‰‡</div>
                <div class="chip on" data-v="emoji">ğŸ˜Š Emoji</div>
                <div class="chip" data-v="timeline">ğŸ“… æ™‚é–“è»¸</div>
                <div class="chip" data-v="compare">âš–ï¸ æ¯”è¼ƒè¡¨</div>
                <div class="chip" data-v="qna">â” Q&A</div>
            </div>
        </div>

        <div class="sec">
            <div class="sec-title">ğŸ“¤ è¼¸å‡º</div>
            <div class="output-grid" id="outGrid">
                <div class="out-card on" data-v="pptx"><div class="out-icon">ğŸ“Š</div><div class="out-name">PPTX</div><div class="out-desc">ä¸‹è¼‰</div></div>
                <div class="out-card" data-v="canva"><div class="out-icon">ğŸ¨</div><div class="out-name">Canva</div><div class="out-desc">è¤‡è£½</div></div>
                <div class="out-card" data-v="html"><div class="out-icon">ğŸŒ</div><div class="out-name">ç¶²é </div><div class="out-desc">å‹•ç•«</div></div>
            </div>
        </div>
    </main>

    <div class="gen-sec">
        <button class="gen-btn" id="genBtn" onclick="generate()"><span>âœ¨</span><span>ç”¢ç”Ÿç°¡å ±</span></button>
        <div class="prog" id="prog"><div class="prog-bar"><div class="prog-fill" id="progFill"></div></div><div class="prog-txt" id="progTxt">è™•ç†ä¸­...</div></div>
    </div>
</div>

<!-- è¨­å®š -->
<div class="modal-bg" id="setModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">âš™ï¸ è¨­å®š</div><button class="modal-x" onclick="closeSet()">âœ•</button></div>
        <div class="modal-body">
            <div class="set-sec">
                <div class="set-label">ğŸ¤– AI æ¨¡å‹</div>
                <div class="chips" id="modelChips">
                    <div class="chip on" data-v="gemini-2.0-flash">2.0 Flash</div>
                    <div class="chip" data-v="gemini-2.5-flash">2.5 Flash</div>
                    <div class="chip" data-v="gemini-2.5-flash-lite">2.5 Lite</div>
                </div>
                <div class="model-custom">
                    <div class="set-label" style="margin-top:12px">ğŸ”§ è‡ªè¨‚æ¨¡å‹</div>
                    <div class="model-custom-row">
                        <input type="text" class="model-custom-inp" id="customModelInp" placeholder="gemini-3.0-pro">
                        <button class="model-custom-btn" onclick="useCustomModel()">å¥—ç”¨</button>
                    </div>
                    <p class="model-hint" id="currentModelHint"></p>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">ğŸ¨ è‡ªè¨‚é…è‰²</div>
                <div style="display:flex;gap:10px;align-items:center">
                    <label style="font-size:11px;color:var(--text-secondary)">ä¸»è‰²</label>
                    <input type="color" id="customColor1" value="#667eea" class="color-picker">
                    <label style="font-size:11px;color:var(--text-secondary)">æ¬¡è‰²</label>
                    <input type="color" id="customColor2" value="#764ba2" class="color-picker">
                    <button class="tool-btn" onclick="applyCustomColors()">å¥—ç”¨</button>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">ğŸŒ™ ä»‹é¢ä¸»é¡Œ</div>
                <div class="chips" id="themeMode">
                    <div class="chip on" data-v="dark" onclick="setThemeMode('dark')">ğŸŒ™ æ·±è‰²</div>
                    <div class="chip" data-v="light" onclick="setThemeMode('light')">â˜€ï¸ æ·ºè‰²</div>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">â±ï¸ æ’­æ”¾å€’æ•¸è¨ˆæ™‚</div>
                <div style="display:flex;gap:10px;align-items:center">
                    <input type="number" id="timerMinutes" value="5" min="1" max="60" class="timer-inp">
                    <span style="font-size:12px;color:var(--text-secondary)">åˆ†é˜</span>
                    <div class="chips">
                        <div class="chip" onclick="document.getElementById('timerMinutes').value=3">3åˆ†</div>
                        <div class="chip" onclick="document.getElementById('timerMinutes').value=5">5åˆ†</div>
                        <div class="chip" onclick="document.getElementById('timerMinutes').value=10">10åˆ†</div>
                    </div>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">ğŸ¬ å‹•ç•«ä¸»é¡ŒåŒ…</div>
                <div class="chips" id="animTheme">
                    <div class="chip on" data-v="random" onclick="setAnimTheme('random')">ğŸ² éš¨æ©Ÿ</div>
                    <div class="chip" data-v="tech" onclick="setAnimTheme('tech')">ğŸ’» ç§‘æŠ€</div>
                    <div class="chip" data-v="cute" onclick="setAnimTheme('cute')">ğŸ€ å¯æ„›</div>
                    <div class="chip" data-v="formal" onclick="setAnimTheme('formal')">ğŸ“Š æ­£å¼</div>
                </div>
            </div>
            <div class="set-sec">
                <div class="set-label">â„¹ï¸ é—œæ–¼</div>
                <div class="card">
                    <p style="font-size:12px;line-height:1.5;color:var(--text-secondary)">
                        <strong style="color:var(--cyan)">âœ¨ SlideGenie Pro</strong><br>
                        AI ç°¡å ±ç”¢ç”Ÿå™¨ Â· Gemini API
                    </p>
                    <p style="font-size:10px;margin-top:8px;color:var(--text-muted)">
                        v10.0 | Made with â¤ï¸
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-foot"><button class="m-btn m-btn-pri" onclick="closeSet()" style="flex:1">âœ“ é—œé–‰</button></div>
    </div>
</div>

<!-- æ­·å² -->
<div class="modal-bg" id="histModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“‹ æ­·å²</div><button class="modal-x" onclick="closeHist()">âœ•</button></div>
        <div class="modal-body"><div class="hist-list" id="histList"></div></div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeHist()">âœ• é—œé–‰</button>
            <button class="m-btn m-btn-orange" onclick="clearAllHist()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
        </div>
    </div>
</div>

<!-- å¤§ç¶± -->
<div class="modal-bg" id="outlineModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“‹ å¤§ç¶±é è¦½</div><button class="modal-x" onclick="closeOutline()">âœ•</button></div>
        <div class="modal-body"><div id="outlineContent"></div></div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeOutline()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-orange" onclick="regenOutline()">ğŸ”„ é‡ç”¢</button>
            <button class="m-btn m-btn-pri" onclick="confirmOutline()">âœ“ ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- é è¦½ -->
<div class="modal-bg" id="previewModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“Š é è¦½</div><button class="modal-x" onclick="closePreview()">âœ•</button></div>
        <div class="modal-body"><div class="slides-list" id="slidesList"></div></div>
        <div class="modal-foot" style="flex-direction:column;gap:8px">
            <div style="display:flex;gap:6px;width:100%;justify-content:center">
                <button class="m-btn m-btn-sec" onclick="openAiChat()">ğŸ’¬ åŠ©æ•™</button>
                <button class="m-btn m-btn-sec" onclick="generateQRCode()">ğŸ“± QR</button>
                <button class="m-btn m-btn-sec" onclick="exportMarkdown()">ğŸ“ MD</button>
                <button class="m-btn m-btn-sec" onclick="exportPDF()">ğŸ“¤ PDF</button>
                <button class="m-btn m-btn-sec" onclick="copyAllText()">ğŸ“‹ è¤‡è£½</button>
            </div>
            <div style="display:flex;gap:6px;width:100%">
                <button class="m-btn m-btn-sec" onclick="closePreview()" style="flex:1">âœ•</button>
                <button class="m-btn m-btn-cyan" onclick="openHtml()" style="flex:1">ğŸŒ ç¶²é </button>
                <button class="m-btn m-btn-green" onclick="generateQuiz()" style="flex:1">ğŸ¯ æ¸¬é©—</button>
                <button class="m-btn m-btn-purple" onclick="openCanvaFromPreview()" style="flex:1">ğŸ¨ Canva</button>
                <button class="m-btn m-btn-pri" onclick="downloadPPTX()" style="flex:1">ğŸ“¥ PPTX</button>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯ -->
<div class="modal-bg" id="editModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">âœï¸ ç·¨è¼¯</div><button class="modal-x" onclick="closeEdit()">âœ•</button></div>
        <div class="modal-body">
            <div class="edit-field">
                <label class="edit-label">ğŸ“Œ æ¨™é¡Œ</label>
                <input type="text" class="edit-inp" id="editTitle">
            </div>
            <div class="edit-field">
                <label class="edit-label">ğŸ“ å…§å®¹ï¼ˆæ¯è¡Œä¸€é»ï¼‰</label>
                <textarea class="edit-inp" id="editContent"></textarea>
            </div>
            <div class="edit-field">
                <label class="edit-label">ğŸ’¬ å‚™è¨»</label>
                <textarea class="edit-inp" id="editNotes" style="min-height:50px"></textarea>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeEdit()">âœ•</button>
            <button class="m-btn m-btn-orange" onclick="regenSlide()">ğŸ”„</button>
            <button class="m-btn m-btn-pri" onclick="saveEdit()">ğŸ’¾</button>
        </div>
    </div>
</div>

<!-- Canva -->
<div class="modal-bg canva-modal" id="canvaModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ¨ Canva è¤‡è£½</div><button class="modal-x" onclick="closeCanva()">âœ•</button></div>
        <div class="modal-body">
            <div class="copy-card">
                <div class="copy-header"><div class="copy-page" id="copyPage">ğŸ“„ ç¬¬ 1 é </div><div class="copy-progress" id="copyProg">1/10</div></div>
                <div class="copy-type" id="copyType">å°é¢</div>
                <div class="copy-title" id="copyTitle">æ¨™é¡Œ</div>
                <div class="copy-content" id="copyContent">å…§å®¹</div>
                <div class="copy-notes" id="copyNotes" style="display:none"></div>
                <div class="copy-img" id="copyImg" style="display:none"></div>
            </div>
            <div class="copy-hint" style="background:rgba(168,85,247,0.15);padding:10px;border-radius:8px;margin-bottom:12px;font-size:11px;color:var(--purple);text-align:center">
                ğŸ’¡ åˆ†é–‹è¤‡è£½ï¼Œè²¼åˆ° Canva å¾Œåˆ†åˆ¥è¨­å®šå­—é«”å¤§å°
            </div>
            <div class="copy-btns-split" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                <button class="copy-btn copy" id="copyTitleBtn" onclick="copyTitle()">ğŸ“‹ æ¨™é¡Œ (56pt)</button>
                <button class="copy-btn copy" id="copyContentBtn" onclick="copyContent()">ğŸ“‹ å…§å®¹ (24pt)</button>
            </div>
            <button class="copy-btn copy" id="copyBtn" onclick="copySlide()" style="background:var(--grad-green)">ğŸ“‹ æ•´é è¤‡è£½</button>
            <div class="copy-nav">
                <button class="copy-btn nav" id="prevBtn" onclick="prevSlide()">â—€</button>
                <button class="copy-btn nav" id="nextBtn" onclick="nextSlide()">â–¶</button>
            </div>
            <div class="copy-dots" id="copyDots"></div>
            <div class="copy-actions">
                <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ è¤‡è£½å…¨éƒ¨</button>
                <a class="canva-link" href="https://www.canva.com/templates/?query=presentation" target="_blank">ğŸ¨ é–‹å•Ÿ Canva</a>
            </div>
        </div>
    </div>
</div>

<!-- HTML -->
<div class="modal-bg html-modal" id="htmlModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸŒ å‹•ç•«æ’­æ”¾</div><button class="modal-x" onclick="closeHtml()">âœ•</button></div>
        <div class="modal-body">
            <div class="slideshow-wrap">
                <div class="slideshow" id="slideshow"></div>
                <div class="ss-timer" id="ssTimer"></div>
            </div>
            <div class="ss-controls">
                <button class="ss-btn" onclick="ssPrev()">â—€</button>
                <div class="ss-counter" id="ssCounter">1/10</div>
                <button class="ss-btn" onclick="ssNext()">â–¶</button>
                <button class="ss-btn pri" onclick="ssNextItem()">â© ä¸‹ä¸€æ®µ</button>
            </div>
            <div class="ss-next-hint">ğŸ’¡ ç©ºç™½éµ = ä¸‹ä¸€æ®µå‹•ç•«</div>
            <div style="padding:10px;display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
                <button class="ss-btn" onclick="toggleTimer()" id="timerBtn">â±ï¸ é–‹å§‹è¨ˆæ™‚</button>
                <button class="ss-btn" onclick="toggleVoice()" id="voiceBtn">ğŸ”Š èªéŸ³</button>
                <button class="ss-btn" onclick="pauseVoice()" id="pauseBtn" style="display:none">â¸ï¸ æš«åœ</button>
                <button class="ss-btn" onclick="stopVoice()" id="stopBtn" style="display:none">â¹ï¸ åœæ­¢</button>
                <button class="ss-btn pri" onclick="ssFullscreen()">ğŸ“º å…¨è¢å¹•</button>
            </div>
        </div>
    </div>
</div>

<!-- ç¶²å€è¼¸å…¥ Modal -->
<div class="modal-bg" id="urlModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ”— ç¶²å€è½‰ç°¡å ±</div><button class="modal-x" onclick="closeUrlModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="input-modal-content">
                <textarea id="urlInput" placeholder="è²¼ä¸Šç¶²å€ï¼Œä¾‹å¦‚ï¼š&#10;https://zh.wikipedia.org/wiki/ç‰›é “é‹å‹•å®šå¾‹&#10;&#10;æˆ–è²¼ä¸Šç¶²é æ–‡å­—å…§å®¹..."></textarea>
                <p>ğŸ’¡ æ”¯æ´ Wikipediaã€æ–°èç¶²ç«™ã€éƒ¨è½æ ¼ç­‰ï¼ŒAI æœƒè‡ªå‹•æ“·å–é‡é»</p>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeUrlModal()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-pri" onclick="processUrl()">âœ¨ åˆ†æç”¢ç”Ÿ</button>
        </div>
    </div>
</div>

<!-- æ•¸æ“šè¼¸å…¥ Modal -->
<div class="modal-bg" id="dataModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“Š æ•¸æ“šè½‰ç°¡å ±</div><button class="modal-x" onclick="closeDataModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="input-modal-content">
                <textarea id="dataInput" placeholder="è²¼ä¸Šæ•¸æ“šï¼Œä¾‹å¦‚ï¼š&#10;2020å¹´: 100è¬&#10;2021å¹´: 150è¬&#10;2022å¹´: 200è¬&#10;2023å¹´: 280è¬"></textarea>
                <p>ğŸ’¡ æ”¯æ´å„ç¨®æ ¼å¼ï¼šè¡¨æ ¼ã€CSVã€æ•¸å­—åˆ—è¡¨ç­‰ï¼ŒAI æœƒè‡ªå‹•åˆ†æä¸¦å»ºè­°åœ–è¡¨</p>
                <div class="data-example">ç¯„ä¾‹æ ¼å¼ï¼š
é …ç›®A: 30%
é …ç›®B: 45%
é …ç›®C: 25%</div>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeDataModal()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-pri" onclick="processData()">ğŸ“Š åˆ†æç”¢ç”Ÿ</button>
        </div>
    </div>
</div>

<!-- åœ–ç‰‡åˆ†æ Modal -->
<div class="modal-bg" id="imgModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“¸ åœ–ç‰‡è½‰ç°¡å ±</div><button class="modal-x" onclick="closeImgModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="input-modal-content">
                <img id="imgPreview" class="img-preview" style="display:none">
                <div id="imgInfo" class="file-info" style="display:none"></div>
                <p style="margin-top:12px">ğŸ’¡ AI æœƒåˆ†æåœ–ç‰‡å…§å®¹ï¼Œè‡ªå‹•ç”¢ç”Ÿç›¸é—œç°¡å ±</p>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeImgModal()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-pri" onclick="processImage()">âœ¨ åˆ†æç”¢ç”Ÿ</button>
        </div>
    </div>
</div>

<!-- æ–‡ä»¶åˆ†æ Modal -->
<div class="modal-bg" id="fileModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“„ æ–‡ä»¶è½‰ç°¡å ±</div><button class="modal-x" onclick="closeFileModal()">âœ•</button></div>
        <div class="modal-body">
            <div class="input-modal-content">
                <div id="fileInfo" class="file-info"></div>
                <div id="fileContent" style="max-height:200px;overflow-y:auto;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-top:10px;font-size:12px;color:var(--text-secondary);white-space:pre-wrap"></div>
                <p style="margin-top:12px">ğŸ’¡ AI æœƒåˆ†ææ–‡ä»¶å…§å®¹ï¼Œè‡ªå‹•ç”¢ç”Ÿç°¡å ±å¤§ç¶±</p>
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeFileModal()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-pri" onclick="processFile()">âœ¨ åˆ†æç”¢ç”Ÿ</button>
        </div>
    </div>
</div>

<!-- è©•åˆ† Modal -->

<!-- AI åŠ©æ•™ Modal -->
<div class="modal-bg" id="chatModal">
    <div class="modal" style="height:85vh;max-height:85vh">
        <div class="modal-head"><div class="modal-title">ğŸ’¬ AI åŠ©æ•™</div><button class="modal-x" onclick="closeAiChat()">âœ•</button></div>
        <div class="modal-body" style="display:flex;flex-direction:column;padding:0">
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-quick">
                <button onclick="quickChat('å¹«æˆ‘è§£é‡‹é€™å€‹ä¸»é¡Œçš„é‡é»')">ğŸ“– é‡é»è§£é‡‹</button>
                <button onclick="quickChat('è£œå……ç›¸é—œçŸ¥è­˜')">ğŸ“š è£œå……çŸ¥è­˜</button>
                <button onclick="quickChat('ç”¢ç”Ÿ3é¡Œç·´ç¿’é¡Œ')">âœï¸ ç·´ç¿’é¡Œ</button>
                <button onclick="quickChat('å­¸ç”Ÿå¯èƒ½å•ä»€éº¼å•é¡Œï¼Ÿ')">â“ é æ¸¬å•é¡Œ</button>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal-bg" id="qrModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“± QR Code åˆ†äº«</div><button class="modal-x" onclick="closeQRModal()">âœ•</button></div>
        <div class="modal-body" style="text-align:center">
            <img id="qrImage" class="qr-image" src="" alt="QR Code">
            <div class="qr-info">
                <div id="qrTopic" class="qr-topic"></div>
                <div id="qrInfo" class="qr-meta"></div>
            </div>
            <div class="qr-btns">
                <button class="m-btn m-btn-sec" onclick="downloadQR()">ğŸ“¥ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="m-btn m-btn-pri" onclick="copyShareText()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
            </div>
        </div>
    </div>
</div>

<!-- å­¸ç¿’ç›®æ¨™ Modal -->

<!-- æ¸¬é©— Modal -->
<div class="modal-bg" id="quizModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ¯ äº’å‹•æ¸¬é©—</div><button class="modal-x" onclick="closeQuiz()">âœ•</button></div>
        <div class="modal-body" id="quizContent"></div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closeQuiz()">âœ• é—œé–‰</button>
            <button class="m-btn m-btn-pri" onclick="submitQuiz()">âœ“ æäº¤ç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<!-- PDF å·¥å…· Modal -->
<div class="modal-bg" id="pdfToolsModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">ğŸ“‘ PDF å·¥å…·ç®±</div><button class="modal-x" onclick="closePdfTools()">âœ•</button></div>
        <div class="modal-body">
            <div class="pdf-tools-grid">
                <div class="pdf-tool-card" onclick="document.getElementById('pdfUpload').click()">
                    <div class="pdf-tool-icon">âœ‚ï¸</div>
                    <div class="pdf-tool-name">åˆ†å‰² PDF</div>
                    <div class="pdf-tool-desc">å°‡ PDF æ‹†æˆå¤šå€‹æª”æ¡ˆ</div>
                </div>
                <div class="pdf-tool-card" onclick="document.getElementById('pdfMergeUpload').click()">
                    <div class="pdf-tool-icon">ğŸ”—</div>
                    <div class="pdf-tool-name">åˆä½µ PDF</div>
                    <div class="pdf-tool-desc">å¤šå€‹ PDF åˆæˆä¸€å€‹</div>
                </div>
                <div class="pdf-tool-card" onclick="startPdfExtract()">
                    <div class="pdf-tool-icon">ğŸ“</div>
                    <div class="pdf-tool-name">æå–æ–‡å­—</div>
                    <div class="pdf-tool-desc">PDF è½‰ç´”æ–‡å­—</div>
                </div>
                <div class="pdf-tool-card" onclick="startPdfPageExtract()">
                    <div class="pdf-tool-icon">ğŸ“„</div>
                    <div class="pdf-tool-name">æå–é é¢</div>
                    <div class="pdf-tool-desc">æ“·å–æŒ‡å®šé é¢</div>
                </div>
                <div class="pdf-tool-card" onclick="startPdfImageExtract()">
                    <div class="pdf-tool-icon">ğŸ–¼ï¸</div>
                    <div class="pdf-tool-name">æå–åœ–ç‰‡</div>
                    <div class="pdf-tool-desc">æ“·å– PDF å…§æ‰€æœ‰åœ–ç‰‡</div>
                </div>
                <div class="pdf-tool-card" onclick="startPdfToSlides()">
                    <div class="pdf-tool-icon">ğŸ¤–</div>
                    <div class="pdf-tool-name">AI åœ–ç‰‡è½‰ç°¡å ±</div>
                    <div class="pdf-tool-desc">è§£æåœ–ç‰‡å…§å®¹ç”Ÿæˆç°¡å ±</div>
                </div>
            </div>
            <div id="pdfToolStatus" class="pdf-tool-status"></div>
            <div id="pdfToolResult" class="pdf-tool-result"></div>
        </div>
    </div>
</div>

<!-- PDF åˆ†å‰²è¨­å®š Modal -->
<div class="modal-bg" id="pdfSplitModal">
    <div class="modal">
        <div class="modal-head"><div class="modal-title">âœ‚ï¸ PDF åˆ†å‰²</div><button class="modal-x" onclick="closePdfSplit()">âœ•</button></div>
        <div class="modal-body">
            <div class="pdf-info" id="pdfSplitInfo"></div>
            <div class="set-sec">
                <div class="set-label">åˆ†å‰²æ–¹å¼</div>
                <div class="chips" id="splitModeChips">
                    <div class="chip on" data-v="each" onclick="setSplitMode('each')">æ¯é ä¸€æª”</div>
                    <div class="chip" data-v="range" onclick="setSplitMode('range')">æŒ‡å®šç¯„åœ</div>
                    <div class="chip" data-v="count" onclick="setSplitMode('count')">æ¯ N é </div>
                </div>
            </div>
            <div id="splitRangeInput" style="display:none;margin-top:12px">
                <div class="set-label">é é¢ç¯„åœï¼ˆä¾‹ï¼š1-3, 5, 7-10ï¼‰</div>
                <input type="text" id="splitRange" class="edit-inp" placeholder="1-3, 5, 7-10">
            </div>
            <div id="splitCountInput" style="display:none;margin-top:12px">
                <div class="set-label">æ¯å¹¾é åˆ†å‰²ä¸€æ¬¡</div>
                <input type="number" id="splitCount" class="edit-inp" value="5" min="1" max="100">
            </div>
        </div>
        <div class="modal-foot">
            <button class="m-btn m-btn-sec" onclick="closePdfSplit()">âœ• å–æ¶ˆ</button>
            <button class="m-btn m-btn-pri" onclick="executePdfSplit()">âœ‚ï¸ é–‹å§‹åˆ†å‰²</button>
        </div>
    </div>
</div>

<div class="toast-box" id="toastBox"></div>

<script>
const animations=[
    {name:'æ·¡å…¥',style:'opacity:0',show:'opacity:1;transition:all 0.6s ease'},
    {name:'å·¦æ»‘å…¥',style:'opacity:0;transform:translateX(-80px)',show:'opacity:1;transform:translateX(0);transition:all 0.5s ease-out'},
    {name:'å³æ»‘å…¥',style:'opacity:0;transform:translateX(80px)',show:'opacity:1;transform:translateX(0);transition:all 0.5s ease-out'},
    {name:'ä¸Šæ»‘å…¥',style:'opacity:0;transform:translateY(-50px)',show:'opacity:1;transform:translateY(0);transition:all 0.5s ease-out'},
    {name:'ä¸‹æ»‘å…¥',style:'opacity:0;transform:translateY(50px)',show:'opacity:1;transform:translateY(0);transition:all 0.5s ease-out'},
    {name:'æ”¾å¤§',style:'opacity:0;transform:scale(0.3)',show:'opacity:1;transform:scale(1);transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)'},
    {name:'ç¸®å°',style:'opacity:0;transform:scale(1.5)',show:'opacity:1;transform:scale(1);transition:all 0.5s ease-out'},
    {name:'æ—‹è½‰å…¥',style:'opacity:0;transform:rotate(-180deg) scale(0.5)',show:'opacity:1;transform:rotate(0) scale(1);transition:all 0.6s ease-out'},
    {name:'ç¿»è½‰X',style:'opacity:0;transform:rotateX(90deg)',show:'opacity:1;transform:rotateX(0);transition:all 0.5s ease-out'},
    {name:'ç¿»è½‰Y',style:'opacity:0;transform:rotateY(90deg)',show:'opacity:1;transform:rotateY(0);transition:all 0.5s ease-out'},
    {name:'å½ˆè·³',style:'opacity:0;transform:translateY(-40px)',show:'opacity:1;transform:translateY(0);transition:all 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)'},
    {name:'æ–æ™ƒå…¥',style:'opacity:0;transform:translateX(-30px) rotate(-5deg)',show:'opacity:1;transform:translateX(0) rotate(0);transition:all 0.5s ease-out'},
    {name:'èºæ—‹',style:'opacity:0;transform:rotate(360deg) scale(0)',show:'opacity:1;transform:rotate(0) scale(1);transition:all 0.7s ease-out'},
    {name:'å·¦ä¸‹è§’',style:'opacity:0;transform:translate(-40px,40px)',show:'opacity:1;transform:translate(0,0);transition:all 0.5s ease-out'},
    {name:'å³ä¸Šè§’',style:'opacity:0;transform:translate(40px,-40px)',show:'opacity:1;transform:translate(0,0);transition:all 0.5s ease-out'},
    {name:'æ¨¡ç³Šå…¥',style:'opacity:0;filter:blur(15px)',show:'opacity:1;filter:blur(0);transition:all 0.6s ease-out'},
    {name:'æ–œåˆ‡å…¥',style:'opacity:0;transform:skewX(20deg) translateX(-40px)',show:'opacity:1;transform:skewX(0) translateX(0);transition:all 0.5s ease-out'},
    {name:'3Dç¿»é ',style:'opacity:0;transform:perspective(500px) rotateY(-90deg)',show:'opacity:1;transform:perspective(500px) rotateY(0);transition:all 0.6s ease-out'},
    {name:'æ©¡çš®ç­‹',style:'opacity:0;transform:scaleX(0.3)',show:'opacity:1;transform:scaleX(1);transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275)'},
    {name:'é–ƒç¾',style:'opacity:0;transform:scale(1.2)',show:'opacity:1;transform:scale(1);transition:all 0.3s ease-out'},
];

const themes=[
    {id:'ocean',name:'æµ·æ´‹è—',c1:'0c4a6e',c2:'0ea5e9',css:'linear-gradient(135deg,#0c4a6e,#0ea5e9)'},
    {id:'purple',name:'å¤¢å¹»ç´«',c1:'581c87',c2:'a855f7',css:'linear-gradient(135deg,#581c87,#a855f7)'},
    {id:'sunset',name:'å¤•é™½æ©˜',c1:'9a3412',c2:'f97316',css:'linear-gradient(135deg,#9a3412,#f97316)'},
    {id:'forest',name:'æ£®æ—ç¶ ',c1:'14532d',c2:'22c55e',css:'linear-gradient(135deg,#14532d,#22c55e)'},
    {id:'rose',name:'ç«ç‘°ç²‰',c1:'9d174d',c2:'ec4899',css:'linear-gradient(135deg,#9d174d,#ec4899)'},
    {id:'cyber',name:'è³½åšéœ“è™¹',c1:'0f172a',c2:'06b6d4',css:'linear-gradient(135deg,#0f172a,#06b6d4)'},
    {id:'gold',name:'å¥¢è¯é‡‘',c1:'451a03',c2:'f59e0b',css:'linear-gradient(135deg,#451a03,#f59e0b)'},
    {id:'mono',name:'æ¥µç°¡é»‘',c1:'18181b',c2:'52525b',css:'linear-gradient(135deg,#18181b,#52525b)'},
    {id:'sky',name:'å¤©ç©ºè—',c1:'0369a1',c2:'7dd3fc',css:'linear-gradient(180deg,#0369a1,#7dd3fc)'},
    {id:'fire',name:'çƒˆç„°ç´…',c1:'7f1d1d',c2:'ef4444',css:'linear-gradient(135deg,#7f1d1d,#ef4444)'},
    {id:'mint',name:'è–„è·ç¶ ',c1:'0f766e',c2:'2dd4bf',css:'linear-gradient(135deg,#0f766e,#2dd4bf)'},
    {id:'aurora',name:'æ¥µå…‰',c1:'4c1d95',c2:'06b6d4',css:'linear-gradient(135deg,#4c1d95,#0891b2,#06b6d4)'},
];

let model='gemini-2.0-flash',apiKeyVerified=false,hist=[],slides=null,topic='',outline=null;
let aud='junior',style='professional',themeId='ocean',output='pptx';
let lang='zh-TW',diff='basic';
let incs=['examples','diagrams','summary','images','emoji'];
let copyIdx=0,copied=[];
let ssIdx=0,ssItemIdx=-1,slideAnims=[];
let editIdx=-1;
let animTheme='random';
const animPacks={random:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19],tech:[0,5,8,9,15,16,17],cute:[4,5,10,11,18,19],formal:[0,1,2,3,4]};

document.addEventListener('DOMContentLoaded',()=>{
    loadH();renderThemes();updateModelHint();
    setupChips('#audChips',v=>aud=v);
    setupChips('#langChips',v=>lang=v);
    setupChips('#diffChips',v=>diff=v);
    setupChips('#incChips',null,true);
    setupChips('#modelChips',v=>{model=v;updateModelHint();});
    setupCards('#styleGrid',v=>style=v);
    setupCards('#outGrid',v=>{output=v;updateGenBtn();});
    const slider=document.getElementById('countSlider');
    slider.oninput=e=>{document.getElementById('countVal').textContent=e.target.value;updateTimeEst(+e.target.value);};
    setTimeout(()=>{document.getElementById('splash').classList.add('hidden');document.getElementById('app').classList.add('show');},2500);
});

function updateTimeEst(n){document.getElementById('timeEst').textContent=`â±ï¸ ç´„ ${n} åˆ†é˜`;}
function updateModelHint(){document.getElementById('currentModelHint').textContent=`ğŸ“ ç›®å‰ï¼š${model}`;}

// æ¸…é™¤ API Key
function clearKey(){
    document.getElementById('apiInp').value='';
    apiKeyVerified=false;
    document.getElementById('apiStat').className='api-stat';
    toast('ğŸ—‘ï¸ å·²æ¸…é™¤','ok');
}

// ===== å¯¦ç”¨å·¥å…·åŠŸèƒ½ =====

// ğŸ¤ èªéŸ³è¼¸å…¥
let recognition=null;
let isRecording=false;
function startVoice(){
    if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
        toast('âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥','err');return;
    }
    const btn=event.target;
    if(isRecording){
        recognition.stop();
        btn.textContent='ğŸ¤ èªéŸ³';
        btn.classList.remove('recording');
        isRecording=false;
        return;
    }
    recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
    recognition.lang='zh-TW';
    recognition.continuous=false;
    recognition.interimResults=true;
    recognition.onstart=()=>{
        btn.textContent='ğŸ”´ éŒ„éŸ³ä¸­...';
        btn.classList.add('recording');
        isRecording=true;
        toast('ğŸ¤ é–‹å§‹èªªè©±...','ok');
    };
    recognition.onresult=(e)=>{
        const t=Array.from(e.results).map(r=>r[0].transcript).join('');
        document.getElementById('topicInp').value=t;
    };
    recognition.onend=()=>{
        btn.textContent='ğŸ¤ èªéŸ³';
        btn.classList.remove('recording');
        isRecording=false;
        if(document.getElementById('topicInp').value)toast('âœ… èªéŸ³è¼¸å…¥å®Œæˆ','ok');
    };
    recognition.onerror=(e)=>{
        btn.textContent='ğŸ¤ èªéŸ³';
        btn.classList.remove('recording');
        isRecording=false;
        toast('âŒ èªéŸ³éŒ¯èª¤ï¼š'+e.error,'err');
    };
    recognition.start();
}

// ğŸ² éš¨æ©Ÿä¸»é¡Œ
const randomTopics=[
    // ç‰©ç†
    'ç‰›é “é‹å‹•å®šå¾‹','å…‰çš„åå°„èˆ‡æŠ˜å°„','é›»è·¯èˆ‡æ­å§†å®šå¾‹','èƒ½é‡å®ˆæ†å®šå¾‹','æ³¢å‹•èˆ‡è²éŸ³',
    'ç†±å‚³å°èˆ‡ç†±å°æµ','ç£å ´èˆ‡é›»ç£æ„Ÿæ‡‰','åŠ›çš„åˆ†è§£èˆ‡åˆæˆ','ç°¡è«§é‹å‹•','æµé«”åŠ›å­¸åŸºç¤',
    // åŒ–å­¸
    'åŸå­çµæ§‹èˆ‡é€±æœŸè¡¨','åŒ–å­¸éµèˆ‡åˆ†å­','é…¸é¹¼ä¸­å’Œåæ‡‰','æ°§åŒ–é‚„åŸåæ‡‰','åŒ–å­¸å¹³è¡¡',
    // ç”Ÿç‰©
    'ç´°èƒæ§‹é€ èˆ‡åŠŸèƒ½','å…‰åˆä½œç”¨','å‘¼å¸ä½œç”¨','DNAèˆ‡éºå‚³','ç”Ÿæ…‹ç³»çµ±',
    // åœ°ç§‘
    'æ¿å¡Šé‹å‹•','å¤©æ°£èˆ‡æ°£å€™','åœ°çƒçš„çµæ§‹','å¤ªé™½ç³»è¡Œæ˜Ÿ','æœˆç›¸è®ŠåŒ–',
    // æ•¸å­¸
    'ç•¢æ°å®šç†','äºŒæ¬¡æ–¹ç¨‹å¼','ä¸‰è§’å‡½æ•¸','æ©Ÿç‡èˆ‡çµ±è¨ˆ','åº§æ¨™å¹¾ä½•',
    // å…¶ä»–
    'äººå·¥æ™ºæ…§å…¥é–€','ç’°ä¿èˆ‡æ°¸çºŒç™¼å±•','å¤ªç©ºæ¢ç´¢','ç¶²è·¯å®‰å…¨','ç¨‹å¼è¨­è¨ˆåŸºç¤'
];
function randomTopic(){
    const t=randomTopics[Math.floor(Math.random()*randomTopics.length)];
    document.getElementById('topicInp').value=t;
    toast(`ğŸ² éš¨æ©Ÿä¸»é¡Œï¼š${t}`,'ok');
}

// ğŸ”— ç¶²å€è½‰ç°¡å ±
let urlContent='';
function openUrlModal(){document.getElementById('urlModal').classList.add('on');}
function closeUrlModal(){document.getElementById('urlModal').classList.remove('on');}
async function processUrl(){
    const input=document.getElementById('urlInput').value.trim();
    if(!input){toast('âŒ è«‹è¼¸å…¥ç¶²å€æˆ–å…§å®¹','warn');return;}
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');return;}
    
    toast('ğŸ”„ åˆ†æä¸­...','warn');
    try{
        const prompt=`åˆ†æä»¥ä¸‹å…§å®¹ï¼Œæå–ä¸»é¡Œå’Œé‡é»ï¼š
${input}

è«‹å›å‚³ï¼š{"topic":"ä¸»é¡Œåç¨±","details":"é‡é»æ‘˜è¦ï¼ˆ100å­—å…§ï¼‰"}
åªå›å‚³JSON`;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:1000}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(m){
            const d=JSON.parse(m[0]);
            document.getElementById('topicInp').value=d.topic||'';
            document.getElementById('detailInp').value=d.details||'';
            toast('âœ… åˆ†æå®Œæˆï¼','ok');
        }
        closeUrlModal();
    }catch(e){toast('âŒ '+e.message,'err');}
}

// ğŸ“Š æ•¸æ“šè½‰ç°¡å ±
function openDataModal(){document.getElementById('dataModal').classList.add('on');}
function closeDataModal(){document.getElementById('dataModal').classList.remove('on');}
async function processData(){
    const input=document.getElementById('dataInput').value.trim();
    if(!input){toast('âŒ è«‹è¼¸å…¥æ•¸æ“š','warn');return;}
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');return;}
    
    toast('ğŸ”„ åˆ†ææ•¸æ“š...','warn');
    try{
        const prompt=`åˆ†æä»¥ä¸‹æ•¸æ“šï¼Œå»ºè­°ç°¡å ±ä¸»é¡Œå’Œè¦–è¦ºåŒ–æ–¹å¼ï¼š
${input}

è«‹å›å‚³ï¼š{"topic":"å»ºè­°ä¸»é¡Œ","details":"æ•¸æ“šåˆ†ææ‘˜è¦ï¼ŒåŒ…å«å»ºè­°çš„åœ–è¡¨é¡å‹ï¼ˆé•·æ¢åœ–/åœ“é¤…åœ–/æŠ˜ç·šåœ–ç­‰ï¼‰"}
åªå›å‚³JSON`;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.5,maxOutputTokens:500}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(m){
            const d=JSON.parse(m[0]);
            document.getElementById('topicInp').value=d.topic||'';
            document.getElementById('detailInp').value=d.details||'';
            toast('âœ… æ•¸æ“šåˆ†æå®Œæˆï¼','ok');
        }
        closeDataModal();
    }catch(e){toast('âŒ '+e.message,'err');}
}

// ğŸ“¸ åœ–ç‰‡è½‰ç°¡å ±
let imageBase64='';
function handleImage(input){
    const file=input.files[0];
    if(!file)return;
    if(!file.type.startsWith('image/')){toast('âŒ è«‹ä¸Šå‚³åœ–ç‰‡','err');return;}
    const reader=new FileReader();
    reader.onload=(e)=>{
        imageBase64=e.target.result;
        document.getElementById('imgPreview').src=imageBase64;
        document.getElementById('imgPreview').style.display='block';
        document.getElementById('imgInfo').textContent=`ğŸ“¸ ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
        document.getElementById('imgInfo').style.display='block';
        document.getElementById('imgModal').classList.add('on');
    };
    reader.readAsDataURL(file);
    input.value='';
}
function closeImgModal(){document.getElementById('imgModal').classList.remove('on');imageBase64='';}
async function processImage(){
    if(!imageBase64){toast('âŒ è«‹å…ˆä¸Šå‚³åœ–ç‰‡','warn');return;}
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');return;}
    
    toast('ğŸ”„ åˆ†æåœ–ç‰‡...','warn');
    try{
        const base64Data=imageBase64.split(',')[1];
        const prompt=`åˆ†æé€™å¼µåœ–ç‰‡ï¼Œå»ºè­°ä¸€å€‹æ•™å­¸ç°¡å ±ä¸»é¡Œå’Œå…§å®¹é‡é»ã€‚
è«‹å›å‚³ï¼š{"topic":"ä¸»é¡Œåç¨±","details":"æ ¹æ“šåœ–ç‰‡å»ºè­°çš„æ•™å­¸å…§å®¹é‡é»"}
åªå›å‚³JSON`;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[
                {inlineData:{mimeType:'image/jpeg',data:base64Data}},
                {text:prompt}
            ]}],generationConfig:{temperature:0.5,maxOutputTokens:500}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(m){
            const d=JSON.parse(m[0]);
            document.getElementById('topicInp').value=d.topic||'';
            document.getElementById('detailInp').value=d.details||'';
            toast('âœ… åœ–ç‰‡åˆ†æå®Œæˆï¼','ok');
        }
        closeImgModal();
    }catch(e){toast('âŒ '+e.message,'err');}
}

// ğŸ“„ æ–‡ä»¶è½‰ç°¡å ±
let fileContent='';
function handleFile(input){
    const file=input.files[0];
    if(!file)return;
    const ext=file.name.split('.').pop().toLowerCase();
    document.getElementById('fileInfo').textContent=`ğŸ“„ ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
    document.getElementById('fileContent').textContent='â³ è®€å–ä¸­...';
    document.getElementById('fileModal').classList.add('on');
    
    if(ext==='txt'||ext==='md'){
        // ç´”æ–‡å­—
        const reader=new FileReader();
        reader.onload=(e)=>{
            fileContent=e.target.result;
            document.getElementById('fileContent').textContent=fileContent.substring(0,1500)+(fileContent.length>1500?'...':'');
        };
        reader.readAsText(file);
    }else if(ext==='pdf'){
        // PDF
        const reader=new FileReader();
        reader.onload=async(e)=>{
            try{
                if(typeof pdfjsLib==='undefined'){toast('âŒ PDF å‡½å¼åº«æœªè¼‰å…¥','err');return;}
                pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const pdf=await pdfjsLib.getDocument({data:e.target.result}).promise;
                let txt='';
                const maxPages=Math.min(pdf.numPages,100);
                for(let i=1;i<=maxPages;i++){
                    const page=await pdf.getPage(i);
                    const content=await page.getTextContent();
                    txt+=content.items.map(x=>x.str).join(' ')+'\n\n';
                }
                fileContent=txt.trim();
                document.getElementById('fileContent').textContent=fileContent.substring(0,1500)+(fileContent.length>1500?'...\n\n(å…± '+pdf.numPages+' é )':'');
                toast('âœ… PDF è®€å–å®Œæˆ','ok');
            }catch(err){
                console.error('PDF error:',err);
                document.getElementById('fileContent').textContent='âŒ PDF è®€å–å¤±æ•—ï¼š'+err.message;
                fileContent='';
            }
        };
        reader.readAsArrayBuffer(file);
    }else if(ext==='docx'){
        // DOCX
        const reader=new FileReader();
        reader.onload=async(e)=>{
            try{
                if(typeof mammoth==='undefined'){toast('âŒ DOCX å‡½å¼åº«æœªè¼‰å…¥','err');return;}
                const result=await mammoth.extractRawText({arrayBuffer:e.target.result});
                fileContent=result.value.trim();
                document.getElementById('fileContent').textContent=fileContent.substring(0,1500)+(fileContent.length>1500?'...':'');
                toast('âœ… DOCX è®€å–å®Œæˆ','ok');
            }catch(err){
                console.error('DOCX error:',err);
                document.getElementById('fileContent').textContent='âŒ DOCX è®€å–å¤±æ•—ï¼š'+err.message;
                fileContent='';
            }
        };
        reader.readAsArrayBuffer(file);
    }else if(ext==='doc'){
        document.getElementById('fileContent').textContent='âš ï¸ .doc èˆŠæ ¼å¼ä¸æ”¯æ´ç›´æ¥è®€å–\n\nè«‹ç”¨ Word å¦å­˜ç‚º .docx æ ¼å¼å¾Œå†ä¸Šå‚³\næˆ–å°‡å…§å®¹è¤‡è£½è²¼åˆ°ã€Œè£œå……èªªæ˜ã€æ¬„ä½';
        fileContent='';
    }else{
        document.getElementById('fileContent').textContent='âš ï¸ ä¸æ”¯æ´æ­¤æª”æ¡ˆæ ¼å¼\n\næ”¯æ´æ ¼å¼ï¼šPDF, DOCX, TXT, MD';
        fileContent='';
    }
    input.value='';
}
function closeFileModal(){document.getElementById('fileModal').classList.remove('on');fileContent='';}
async function processFile(){
    if(!fileContent||!fileContent.trim()){toast('âŒ ç„¡æ³•è®€å–æª”æ¡ˆå…§å®¹','warn');return;}
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');return;}
    
    toast('ğŸ”„ åˆ†ææ–‡ä»¶...','warn');
    try{
        const prompt=`åˆ†æä»¥ä¸‹æ–‡ä»¶å…§å®¹ï¼Œæå–ä¸»é¡Œå’Œé‡é»ï¼š
${fileContent.substring(0,4000)}

è«‹å›å‚³ JSON æ ¼å¼ï¼š{"topic":"ä¸»é¡Œåç¨±","details":"å…§å®¹æ‘˜è¦é‡é»ï¼ˆ150å­—å…§ï¼‰"}
åªå›å‚³JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—`;
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiKey,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.5,maxOutputTokens:500}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(m){
            const d=JSON.parse(m[0]);
            document.getElementById('topicInp').value=d.topic||'';
            document.getElementById('detailInp').value=d.details||'';
            toast('âœ… æ–‡ä»¶åˆ†æå®Œæˆï¼','ok');
        }
        closeFileModal();
    }catch(e){toast('âŒ '+e.message,'err');}
}

// ===== äº’å‹•å‹åŠŸèƒ½ =====

// ğŸ† ç°¡å ±è©•åˆ†
// ğŸ’¬ AI åŠ©æ•™
let chatHistory=[];
function openAiChat(){
    if(!slides||!slides.length){toast('âŒ è«‹å…ˆç”¢ç”Ÿç°¡å ±','warn');return;}
    chatHistory=[];
    document.getElementById('chatMessages').innerHTML='<div class="chat-welcome">ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯ AI åŠ©æ•™ï¼Œå¯ä»¥å¹«ä½ ï¼š<br>â€¢ è§£é‡‹ç°¡å ±å…§å®¹<br>â€¢ è£œå……ç›¸é—œçŸ¥è­˜<br>â€¢ ç”¢ç”Ÿç·´ç¿’é¡Œç›®<br>â€¢ å›ç­”å­¸ç”Ÿå¯èƒ½çš„å•é¡Œ</div>';
    document.getElementById('chatModal').classList.add('on');
}
function closeAiChat(){document.getElementById('chatModal').classList.remove('on');}
async function sendChat(){
    const input=document.getElementById('chatInput');
    const msg=input.value.trim();
    if(!msg)return;
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    
    // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
    const msgBox=document.getElementById('chatMessages');
    msgBox.innerHTML+=`<div class="chat-msg user">${esc(msg)}</div>`;
    input.value='';
    msgBox.scrollTop=msgBox.scrollHeight;
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    msgBox.innerHTML+=`<div class="chat-msg ai loading">ğŸ’­ æ€è€ƒä¸­...</div>`;
    
    try{
        const slidesSummary=slides.map(s=>`${s.title}`).join(', ');
        chatHistory.push({role:'user',parts:[{text:msg}]});
        
        const systemPrompt=`ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ AI æ•™å­¸åŠ©æ•™ã€‚ç›®å‰æ­£åœ¨å”åŠ©æ•™å¸«æº–å‚™é—œæ–¼ã€Œ${topic}ã€çš„ç°¡å ±ã€‚
ç°¡å ±åŒ…å«ä»¥ä¸‹é é¢ï¼š${slidesSummary}

è«‹æ ¹æ“šç°¡å ±å…§å®¹å›ç­”å•é¡Œï¼Œæä¾›è£œå……è³‡æ–™ã€æ•™å­¸å»ºè­°æˆ–ç·´ç¿’é¡Œç›®ã€‚
å›ç­”è¦ï¼šç°¡æ½”ã€å°ˆæ¥­ã€é©åˆæ•™å­¸ä½¿ç”¨ã€ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;
        
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                contents:[{role:'user',parts:[{text:systemPrompt}]},...chatHistory],
                generationConfig:{temperature:0.8,maxOutputTokens:1000}
            })
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const reply=(await r.json()).candidates[0].content.parts[0].text;
        chatHistory.push({role:'model',parts:[{text:reply}]});
        
        // ç§»é™¤è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºå›è¦†
        msgBox.querySelector('.loading')?.remove();
        msgBox.innerHTML+=`<div class="chat-msg ai">${reply.replace(/\n/g,'<br>')}</div>`;
        msgBox.scrollTop=msgBox.scrollHeight;
    }catch(e){
        msgBox.querySelector('.loading')?.remove();
        msgBox.innerHTML+=`<div class="chat-msg ai error">âŒ ${e.message}</div>`;
    }
}

// å¿«é€Ÿå•é¡Œ
function quickChat(q){
    document.getElementById('chatInput').value=q;
    sendChat();
}

// ğŸ“± QR Code åˆ†äº«
function generateQRCode(){
    if(!slides||!slides.length){toast('âŒ è«‹å…ˆç”¢ç”Ÿç°¡å ±','warn');return;}
    
    // ç”¢ç”Ÿç°¡å ±è³‡æ–™ URLï¼ˆä½¿ç”¨ data URIï¼‰
    const data={
        topic:topic,
        slides:slides.map(s=>({t:s.title,c:s.content}))
    };
    const json=JSON.stringify(data);
    const encoded=btoa(unescape(encodeURIComponent(json)));
    
    // ä½¿ç”¨ QR Code API
    const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('https://slidegenie.app/view?d='+encoded.substring(0,100))}`;
    
    // å› ç‚ºæ²’æœ‰å¾Œç«¯ï¼Œæ”¹ç”¨é¡¯ç¤ºç°¡å ±æ‘˜è¦çš„ QR Code
    const shareText=`ğŸ“Š ${topic}\n${slides.length} é ç°¡å ±\n\n${slides.slice(0,3).map(s=>s.title).join('\n')}`;
    const shareUrl=`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(shareText)}`;
    
    document.getElementById('qrImage').src=shareUrl;
    document.getElementById('qrTopic').textContent=topic;
    document.getElementById('qrInfo').textContent=`${slides.length} é ç°¡å ±`;
    document.getElementById('qrModal').classList.add('on');
}
function closeQRModal(){document.getElementById('qrModal').classList.remove('on');}
function downloadQR(){
    const img=document.getElementById('qrImage');
    const a=document.createElement('a');
    a.href=img.src;
    a.download=`${topic}-QRCode.png`;
    a.click();
    toast('âœ… QR Code å·²ä¸‹è¼‰','ok');
}
function copyShareText(){
    const text=`ğŸ“Š ${topic}\n\nç°¡å ±å¤§ç¶±ï¼š\n${slides.map((s,i)=>`${i+1}. ${s.title}`).join('\n')}`;
    navigator.clipboard.writeText(text).then(()=>toast('âœ… å·²è¤‡è£½åˆ†äº«æ–‡å­—','ok'));
}

// ğŸ¯ å­¸ç¿’ç›®æ¨™ç”¢ç”Ÿ

// API Key é©—è­‰
async function verifyKey(){
    const k=document.getElementById('apiInp').value.trim();
    if(!k){showApiStat('err','âŒ è«‹è¼¸å…¥ API Key');return;}
    const btn=document.getElementById('verifyBtn');
    btn.disabled=true;btn.textContent='...';
    showApiStat('wait','â³ é©—è­‰ä¸­...');
    try{
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${k}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:'hi'}]}],generationConfig:{maxOutputTokens:5}})
        });
        if(r.ok){apiKeyVerified=true;showApiStat('ok','âœ… é©—è­‰æˆåŠŸï¼å¯ä»¥é–‹å§‹ä½¿ç”¨');toast('âœ… API Key æœ‰æ•ˆ','ok');}
        else{const e=await r.json();showApiStat('err','âŒ '+(e.error?.message||'é©—è­‰å¤±æ•—'));}
    }catch(e){showApiStat('err','âŒ é€£ç·šéŒ¯èª¤');}
    btn.disabled=false;btn.textContent='é©—è­‰';
}
function showApiStat(t,m){const e=document.getElementById('apiStat');e.className='api-stat on '+t;e.innerHTML=m;}

function useCustomModel(){
    const v=document.getElementById('customModelInp').value.trim();
    if(!v){toast('âŒ è«‹è¼¸å…¥æ¨¡å‹åç¨±','warn');return;}
    model=v;
    document.querySelectorAll('#modelChips .chip').forEach(c=>c.classList.remove('on'));
    updateModelHint();
    apiKeyVerified=false;
    showApiStat('warn','âš ï¸ è«‹é‡æ–°é©—è­‰ API Key');
    toast(`âœ… å·²å¥—ç”¨ï¼š${model}`,'ok');
}

function renderThemes(){
    document.getElementById('themeGrid').innerHTML=themes.map(t=>
        `<div class="theme-card ${t.id===themeId?'on':''}" data-id="${t.id}" data-name="${t.name}" style="background:${t.css}" onclick="selectTheme('${t.id}')"></div>`
    ).join('');
}
function selectTheme(id){themeId=id;document.querySelectorAll('.theme-card').forEach(c=>c.classList.toggle('on',c.dataset.id===id));}

function setupChips(sel,cb,multi){
    document.querySelectorAll(`${sel} .chip`).forEach(c=>{
        c.onclick=()=>{
            if(multi){c.classList.toggle('on');incs=[...document.querySelectorAll(`${sel} .chip.on`)].map(x=>x.dataset.v);}
            else{document.querySelectorAll(`${sel} .chip`).forEach(x=>x.classList.remove('on'));c.classList.add('on');if(cb)cb(c.dataset.v);}
        };
    });
}
function setupCards(sel,cb){
    document.querySelectorAll(`${sel} > div`).forEach(c=>{
        c.onclick=()=>{document.querySelectorAll(`${sel} > div`).forEach(x=>x.classList.remove('on'));c.classList.add('on');cb(c.dataset.v);};
    });
}
function updateGenBtn(){
    const b=document.getElementById('genBtn');
    b.className='gen-btn'+(output==='canva'?' canva':output==='html'?' html':'');
    b.innerHTML=`<span>${output==='canva'?'ğŸ¨':output==='html'?'ğŸŒ':'âœ¨'}</span><span>ç”¢ç”Ÿç°¡å ±</span>`;
}

function openSet(){document.getElementById('setModal').classList.add('on');}
function closeSet(){document.getElementById('setModal').classList.remove('on');}

function loadH(){const d=localStorage.getItem('sg_hist');if(d)hist=JSON.parse(d);}
function saveH(){localStorage.setItem('sg_hist',JSON.stringify(hist));}
function addH(t,s){hist.unshift({id:Date.now(),topic:t,slides:s,at:new Date().toISOString()});if(hist.length>20)hist=hist.slice(0,20);saveH();}
function openHist(){renderH();document.getElementById('histModal').classList.add('on');}
function closeHist(){document.getElementById('histModal').classList.remove('on');}
function clearAllHist(){
    if(!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ'))return;
    hist=[];
    localStorage.removeItem('sg_hist');
    renderH();
    toast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ­·å²','ok');
}
function renderH(){
    const c=document.getElementById('histList');
    if(!hist.length){c.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div>å°šç„¡è¨˜éŒ„</div>';return;}
    c.innerHTML=hist.map(h=>`<div class="hist-item"><div class="hist-info"><div class="hist-title">${esc(h.topic)}</div><div class="hist-meta">ğŸ“„ ${h.slides.length}é  Â· ${new Date(h.at).toLocaleDateString('zh-TW')}</div></div><div class="hist-btns"><button class="hist-btn" onclick="viewH(${h.id})">ğŸ‘ï¸</button><button class="hist-btn" onclick="delH(${h.id})">ğŸ—‘ï¸</button></div></div>`).join('');
}
function viewH(id){const h=hist.find(x=>x.id===id);if(h){topic=h.topic;slides=h.slides;closeHist();showPreview();}}
function delH(id){if(!confirm('åˆªé™¤ï¼Ÿ'))return;hist=hist.filter(x=>x.id!==id);saveH();renderH();toast('âœ… å·²åˆªé™¤','ok');}

async function generate(){
    const apiKey=document.getElementById('apiInp').value.trim();
    topic=document.getElementById('topicInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    if(!document.getElementById('topicInp').value.trim()){toast('âŒ è«‹è¼¸å…¥ä¸»é¡Œ','warn');return;}
    
    const btn=document.getElementById('genBtn'),prog=document.getElementById('prog'),fill=document.getElementById('progFill'),txt=document.getElementById('progTxt');
    btn.disabled=true;btn.innerHTML='<div class="spinner"></div><span>ç”¢ç”Ÿä¸­...</span>';
    prog.classList.add('on');fill.style.width='20%';txt.textContent='ğŸ“‹ ç”¢ç”Ÿå¤§ç¶±...';
    
    try{
        outline=await genOutline(apiKey);
        fill.style.width='100%';txt.textContent='âœ… å¤§ç¶±å®Œæˆ';
        setTimeout(()=>{
            btn.disabled=false;updateGenBtn();
            prog.classList.remove('on');fill.style.width='0%';
            showOutline();
        },500);
    }catch(e){
        toast('âŒ '+e.message,'err');
        btn.disabled=false;updateGenBtn();prog.classList.remove('on');
    }
}

async function genOutline(apiKey){
    const detail=document.getElementById('detailInp').value.trim();
    const count=+document.getElementById('countSlider').value;
    const audMap={elementary:'åœ‹å°ç”Ÿ',junior:'åœ‹ä¸­ç”Ÿ',senior:'é«˜ä¸­ç”Ÿ',college:'å¤§å­¸ç”Ÿ',general:'ä¸€èˆ¬å¤§çœ¾'};
    const styMap={professional:'å°ˆæ¥­æ­£å¼',creative:'å‰µæ„æ´»æ½‘',minimal:'ç°¡ç´„ç²¾ç·»',fun:'è¼•é¬†æœ‰è¶£',tech:'ç§‘æŠ€æœªä¾†',nature:'è‡ªç„¶æ¸…æ–°',elegant:'å„ªé›…é«˜ç´š',neon:'éœ“è™¹ç‚«å½©'};
    const langMap={'zh-TW':'ç¹é«”ä¸­æ–‡','zh-CN':'ç®€ä½“ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª'};
    const diffMap={basic:'åŸºç¤å…¥é–€',intermediate:'é€²éšå»¶ä¼¸',advanced:'å°ˆæ¥­æ·±å…¥'};
    
    const prompt=`ç”¢ç”Ÿç°¡å ±å¤§ç¶±ï¼š
ä¸»é¡Œï¼š${document.getElementById('topicInp').value.trim()}
${detail?'è£œå……ï¼š'+detail:''}
å°è±¡ï¼š${audMap[aud]}
èªè¨€ï¼š${langMap[lang]}ï¼ˆè«‹ç”¨æ­¤èªè¨€æ’°å¯«æ‰€æœ‰å…§å®¹ï¼‰
é›£åº¦ï¼š${diffMap[diff]}
é¢¨æ ¼ï¼š${styMap[style]}
é æ•¸ï¼š${count}é 
${incs.includes('emoji')?'é©æ™‚åŠ emoji':''}
${incs.includes('timeline')?'åŒ…å«æ™‚é–“è»¸é é¢':''}
${incs.includes('compare')?'åŒ…å«æ¯”è¼ƒè¡¨é é¢':''}
${incs.includes('qna')?'åŒ…å«Q&Aå•ç­”é é¢':''}

æ ¼å¼ï¼š{"outline":[{"page":1,"type":"å°é¢/å…§å®¹/ç¸½çµ/æ™‚é–“è»¸/æ¯”è¼ƒ/Q&A","title":"æ¨™é¡Œ"},...]}
åªå›å‚³JSON`;

    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:4096}})
    });
    if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'APIéŒ¯èª¤');}
    const txt=(await r.json()).candidates[0].content.parts[0].text;
    const m=txt.match(/\{[\s\S]*\}/);
    if(!m)throw new Error('è§£æå¤±æ•—');
    return JSON.parse(m[0]);
}

function showOutline(){
    document.getElementById('outlineContent').innerHTML=`<div class="outline-card"><div class="outline-title">ğŸ“Š ${esc(topic)}</div><div class="outline-list">${outline.outline.map(o=>`<div class="outline-item"><span class="outline-num">${o.page}</span>${esc(o.title)}</div>`).join('')}</div></div>`;
    document.getElementById('outlineModal').classList.add('on');
}
function closeOutline(){document.getElementById('outlineModal').classList.remove('on');}
function regenOutline(){closeOutline();generate();}
async function confirmOutline(){closeOutline();await genSlides();}

async function genSlides(){
    const apiKey=document.getElementById('apiInp').value.trim();
    const count=outline.outline.length;
    
    const btn=document.getElementById('genBtn'),prog=document.getElementById('prog'),fill=document.getElementById('progFill'),txt=document.getElementById('progTxt');
    btn.disabled=true;btn.innerHTML='<div class="spinner"></div><span>ç”¢ç”Ÿä¸­...</span>';
    prog.classList.add('on');
    
    try{
        let all=[];const BS=25,TB=Math.ceil(count/BS);
        for(let b=0;b<TB;b++){
            const st=b*BS,ed=Math.min((b+1)*BS,count);
            const batch=outline.outline.slice(st,ed);
            fill.style.width=((b+0.5)/TB*80)+'%';
            txt.textContent=TB>1?`ğŸ“„ ${b+1}/${TB} æ‰¹...`:'ğŸ“„ ç”¢ç”Ÿä¸­...';
            const bs=await callAPI(apiKey,batch);
            all=all.concat(bs);
            if(b<TB-1)await sleep(1000);
        }
        fill.style.width='100%';txt.textContent=`âœ… å®Œæˆ ${all.length} é `;
        slides=all;addH(topic,all);
        
        setTimeout(()=>{
            if(output==='canva')openCanva();
            else if(output==='html')openHtml();
            else showPreview();
            btn.disabled=false;updateGenBtn();
            prog.classList.remove('on');fill.style.width='0%';
        },500);
    }catch(e){
        toast('âŒ '+e.message,'err');
        btn.disabled=false;updateGenBtn();prog.classList.remove('on');
    }
}

async function callAPI(apiKey,batch){
    const audMap={elementary:'åœ‹å°ç”Ÿ',junior:'åœ‹ä¸­ç”Ÿ',senior:'é«˜ä¸­ç”Ÿ',college:'å¤§å­¸ç”Ÿ',general:'ä¸€èˆ¬å¤§çœ¾'};
    const styMap={professional:'å°ˆæ¥­æ­£å¼',creative:'å‰µæ„æ´»æ½‘',minimal:'ç°¡ç´„ç²¾ç·»',fun:'è¼•é¬†æœ‰è¶£',tech:'ç§‘æŠ€æœªä¾†',nature:'è‡ªç„¶æ¸…æ–°',elegant:'å„ªé›…é«˜ç´š',neon:'éœ“è™¹ç‚«å½©'};
    const langMap={'zh-TW':'ç¹é«”ä¸­æ–‡','zh-CN':'ç®€ä½“ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª'};
    const diffMap={basic:'åŸºç¤å…¥é–€',intermediate:'é€²éšå»¶ä¼¸',advanced:'å°ˆæ¥­æ·±å…¥'};
    const incMap={examples:'ğŸ’¡å¯¦ä¾‹',diagrams:'ğŸ“Šåœ–è¡¨',quiz:'â“æ¸¬é©—',notes:'ğŸ“å‚™è¨»',summary:'ğŸ“Œç¸½çµ',images:'ğŸ–¼ï¸åœ–ç‰‡é—œéµå­—',emoji:'ğŸ˜ŠEmoji',timeline:'ğŸ“…æ™‚é–“è»¸',compare:'âš–ï¸æ¯”è¼ƒè¡¨',qna:'â”Q&A'};
    
    const prompt=`ç”¢ç”Ÿç°¡å ±å…§å®¹ï¼š
ä¸»é¡Œï¼š${document.getElementById('topicInp').value.trim()}
å°è±¡ï¼š${audMap[aud]}
èªè¨€ï¼š${langMap[lang]}ï¼ˆè«‹ç”¨æ­¤èªè¨€æ’°å¯«æ‰€æœ‰å…§å®¹ï¼‰
é›£åº¦ï¼š${diffMap[diff]}
é¢¨æ ¼ï¼š${styMap[style]}
éœ€æ±‚ï¼š${incs.map(i=>incMap[i]||i).join('ã€')}
${incs.includes('emoji')?'æ¯é åŠ 1-2å€‹emoji':''}

å¤§ç¶±ï¼š
${batch.map(o=>`ç¬¬${o.page}é [${o.type}]ï¼š${o.title}`).join('\n')}

æ ¼å¼ï¼š{"slides":[{"number":1,"type":"å°é¢","title":"æ¨™é¡Œ","subtitle":"å‰¯æ¨™é¡Œ","content":["é‡é»1","é‡é»2"],"notes":"å‚™è¨»","imageKeyword":"åœ–ç‰‡é—œéµå­—"}]}
åªå›å‚³JSON`;

    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:8192}})
    });
    if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'APIéŒ¯èª¤');}
    const txt=(await r.json()).candidates[0].content.parts[0].text;
    const m=txt.match(/\{[\s\S]*\}/);
    if(!m)throw new Error('è§£æå¤±æ•—');
    return JSON.parse(m[0]).slides;
}

function showPreview(){
    document.getElementById('slidesList').innerHTML=slides.map((s,i)=>`
        <div class="slide-card">
            <div class="slide-head">
                <span class="slide-num">ğŸ“„ ${s.number}</span>
                <div style="display:flex;align-items:center;gap:6px">
                    <span class="slide-type">${s.type}</span>
                    <button class="slide-action" onclick="openEdit(${i})">âœï¸</button>
                </div>
            </div>
            <div class="slide-body">
                <div class="slide-title">${esc(s.title)}</div>
                ${s.subtitle?`<div style="color:var(--text-muted);margin-bottom:6px;font-size:11px">${esc(s.subtitle)}</div>`:''}
                ${s.image?`<div class="slide-image"><img src="${s.image}" style="max-width:100%;max-height:120px;border-radius:6px;margin-bottom:8px"></div>`:''}
                <div class="slide-content">${Array.isArray(s.content)?'<ul>'+s.content.map(c=>`<li>${esc(c)}</li>`).join('')+'</ul>':esc(s.content||'')}</div>
                ${s.notes?`<div class="slide-notes">ğŸ’¬ ${esc(s.notes)}</div>`:''}
                ${s.imageKeyword?`<div class="slide-img">ğŸ–¼ï¸ ${esc(s.imageKeyword)}</div>`:''}
            </div>
        </div>
    `).join('');
    document.getElementById('previewModal').classList.add('on');
}
function closePreview(){document.getElementById('previewModal').classList.remove('on');}
function openCanvaFromPreview(){closePreview();openCanva();}

function openEdit(idx){
    editIdx=idx;const s=slides[idx];
    document.getElementById('editTitle').value=s.title;
    document.getElementById('editContent').value=Array.isArray(s.content)?s.content.join('\n'):s.content||'';
    document.getElementById('editNotes').value=s.notes||'';
    document.getElementById('editModal').classList.add('on');
}
function closeEdit(){document.getElementById('editModal').classList.remove('on');editIdx=-1;}
function saveEdit(){
    if(editIdx<0)return;
    slides[editIdx].title=document.getElementById('editTitle').value;
    const content=document.getElementById('editContent').value.trim();
    slides[editIdx].content=content?content.split('\n').filter(x=>x.trim()):[];
    slides[editIdx].notes=document.getElementById('editNotes').value.trim()||undefined;
    closeEdit();showPreview();toast('âœ… å·²å„²å­˜','ok');
}
async function regenSlide(){
    if(editIdx<0)return;
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    const s=slides[editIdx];
    toast('ğŸ”„ é‡æ–°ç”¢ç”Ÿ...','warn');
    try{
        const prompt=`é‡æ–°ç”¢ç”Ÿç°¡å ±é é¢ï¼š
ä¸»é¡Œï¼š${document.getElementById('topicInp').value.trim()}ï¼Œç¬¬${s.number}é [${s.type}]ï¼ŒåŸæ¨™é¡Œï¼š${s.title}
${incs.includes('emoji')?'åŠ emoji':''}
æ ¼å¼ï¼š{"title":"æ¨™é¡Œ","content":["é‡é»"],"notes":"å‚™è¨»"}
åªå›å‚³JSON`;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.9,maxOutputTokens:1024}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(!m)throw new Error('è§£æå¤±æ•—');
        const d=JSON.parse(m[0]);
        slides[editIdx].title=d.title||s.title;
        slides[editIdx].content=d.content||s.content;
        slides[editIdx].notes=d.notes||s.notes;
        closeEdit();showPreview();toast('âœ… å·²é‡æ–°ç”¢ç”Ÿ','ok');
    }catch(e){toast('âŒ '+e.message,'err');}
}

function downloadPPTX(){
    if(!slides||!slides.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    if(typeof PptxGenJS==='undefined'){toast('âŒ PPTX å‡½å¼åº«æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†','err');return;}
    toast('ğŸ“¥ ç”¢ç”Ÿ PPTX...','warn');
    const theme=themes.find(t=>t.id===themeId)||themes[0];
    try{
        const pptx=new PptxGenJS();
        pptx.layout='LAYOUT_16x9';
        pptx.title=topic||'ç°¡å ±';
        slides.forEach(sl=>{
            const s=pptx.addSlide();
            const isCover=sl.type==='å°é¢'||sl.type==='ç¸½çµ';
            if(isCover){
                s.background={color:theme.c1};
            }else{s.background={color:'FFFFFF'};}
            
            if(sl.type==='å°é¢'){
                s.addText(sl.title||'',{x:0.5,y:2,w:9,h:1.2,fontSize:36,bold:true,color:'FFFFFF',align:'center'});
                if(sl.subtitle)s.addText(sl.subtitle,{x:0.5,y:3.3,w:9,h:0.6,fontSize:18,color:'FFFFFF',align:'center'});
            }else if(sl.type==='ç¸½çµ'){
                s.addText(sl.title||'',{x:0.5,y:0.6,w:9,h:0.8,fontSize:28,bold:true,color:'FFFFFF',align:'center'});
                if(Array.isArray(sl.content)&&sl.content.length){
                    s.addText(sl.content.map(x=>'âœ“ '+x).join('\n'),{x:1,y:1.8,w:8,h:3.5,fontSize:16,color:'FFFFFF',lineSpacing:28});
                }
            }else{
                // å…§å®¹é 
                s.addShape('rect',{x:0,y:0,w:10,h:1.1,fill:{type:'solid',color:theme.c1}});
                s.addText(sl.title||'',{x:0.4,y:0.2,w:9,h:0.7,fontSize:22,bold:true,color:'FFFFFF'});
                
                // æœ‰åœ–ç‰‡çš„é é¢ï¼šå·¦åœ–å³æ–‡
                if(sl.image){
                    try{
                        s.addImage({data:sl.image,x:0.3,y:1.3,w:4,h:3.5,sizing:{type:'contain',w:4,h:3.5}});
                        if(Array.isArray(sl.content)&&sl.content.length){
                            s.addText(sl.content.map(x=>({text:'â€¢ '+x+'\n',options:{fontSize:13,color:'333333'}})),{x:4.5,y:1.3,w:5,h:3.5,valign:'top'});
                        }
                    }catch(imgErr){
                        // åœ–ç‰‡å¤±æ•—å°±åªæ”¾æ–‡å­—
                        if(Array.isArray(sl.content)&&sl.content.length){
                            s.addText(sl.content.map(x=>({text:x||'',options:{bullet:true}})),{x:0.4,y:1.3,w:9,h:4,fontSize:14,color:'333333',paraSpaceAfter:8});
                        }
                    }
                }else{
                    // ç„¡åœ–ç‰‡ï¼šæ­£å¸¸æ–‡å­—
                    if(Array.isArray(sl.content)&&sl.content.length){
                        s.addText(sl.content.map(x=>({text:x||'',options:{bullet:true}})),{x:0.4,y:1.3,w:9,h:4,fontSize:14,color:'333333',paraSpaceAfter:8});
                    }
                }
            }
            s.addText(String(sl.number||''),{x:9.2,y:5.2,w:0.5,h:0.3,fontSize:11,color:'94A3B8',align:'right'});
        });
        pptx.writeFile({fileName:(topic||'ç°¡å ±')+'.pptx'}).then(()=>{
            toast('âœ… PPTX å·²ä¸‹è¼‰','ok');
            closePreview();
        }).catch(e=>toast('âŒ ä¸‹è¼‰å¤±æ•—','err'));
    }catch(e){console.error(e);toast('âŒ PPTXéŒ¯èª¤ï¼š'+e.message,'err');}
}

// åŒ¯å‡º Markdown
function exportMarkdown(){
    if(!slides||!slides.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    let md=`# ${topic}\n\n`;
    md+=`> ğŸ¯ å°è±¡ï¼š${aud} | ğŸ¨ é¢¨æ ¼ï¼š${style} | ğŸ“„ ${slides.length} é \n\n---\n\n`;
    
    slides.forEach(s=>{
        if(s.type==='å°é¢'){
            md+=`## ğŸ¬ ${s.title}\n\n`;
            if(s.subtitle)md+=`*${s.subtitle}*\n\n`;
        }else if(s.type==='ç¸½çµ'){
            md+=`## ğŸ“Œ ${s.title}\n\n`;
            if(Array.isArray(s.content))md+=s.content.map(c=>`- âœ“ ${c}`).join('\n')+'\n\n';
        }else{
            md+=`## ${s.number}. ${s.title}\n\n`;
            if(s.subtitle)md+=`*${s.subtitle}*\n\n`;
            if(Array.isArray(s.content))md+=s.content.map(c=>`- ${c}`).join('\n')+'\n\n';
            else if(s.content)md+=s.content+'\n\n';
        }
        if(s.notes)md+=`> ğŸ’¬ ${s.notes}\n\n`;
        if(s.imageKeyword)md+=`> ğŸ–¼ï¸ åœ–ç‰‡å»ºè­°ï¼š${s.imageKeyword}\n\n`;
        md+='---\n\n';
    });
    
    // ä¸‹è¼‰
    const blob=new Blob([md],{type:'text/markdown'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`${topic}.md`;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('âœ… Markdown å·²ä¸‹è¼‰','ok');
}

// Canva - ä¿®æ­£æ ¼å¼ï¼šæ¨™é¡Œç”¨å¤§å­—ï¼Œå…§å®¹ç”¨å°å­—
function openCanva(){
    if(!slides||!slides.length){toast('âŒ è«‹å…ˆç”¢ç”Ÿç°¡å ±','warn');return;}
    copyIdx=0;
    copied=new Array(slides.length).fill(false);
    renderCopyDots();
    renderCopySlide();
    document.getElementById('canvaModal').classList.add('on');
}
function closeCanva(){document.getElementById('canvaModal').classList.remove('on');}
function renderCopySlide(){
    const s=slides[copyIdx];
    document.getElementById('copyPage').textContent=`ğŸ“„ ç¬¬ ${s.number} é `;
    document.getElementById('copyProg').textContent=`${copyIdx+1}/${slides.length}`;
    document.getElementById('copyType').textContent=s.type;
    document.getElementById('copyTitle').textContent=s.title;
    
    let content='';
    if(s.subtitle)content+=s.subtitle+'\n\n';
    if(Array.isArray(s.content))content+=s.content.map(c=>'â€¢ '+c).join('\n');
    else if(s.content)content+=s.content;
    document.getElementById('copyContent').textContent=content;
    
    const notesEl=document.getElementById('copyNotes');
    if(s.notes){notesEl.style.display='block';notesEl.textContent='ğŸ’¬ '+s.notes;}else{notesEl.style.display='none';}
    const imgEl=document.getElementById('copyImg');
    if(s.imageKeyword){imgEl.style.display='block';imgEl.textContent='ğŸ–¼ï¸ '+s.imageKeyword;}else{imgEl.style.display='none';}
    
    document.getElementById('prevBtn').disabled=copyIdx===0;
    document.getElementById('nextBtn').disabled=copyIdx===slides.length-1;
    const copyBtn=document.getElementById('copyBtn');
    if(copied[copyIdx]){copyBtn.classList.add('done');copyBtn.innerHTML='âœ… å·²è¤‡è£½';}
    else{copyBtn.classList.remove('done');copyBtn.innerHTML='ğŸ“‹ è¤‡è£½é€™ä¸€é ';}
    updateCopyDots();
}
function renderCopyDots(){document.getElementById('copyDots').innerHTML=slides.map((_,i)=>`<div class="copy-dot" data-i="${i}"></div>`).join('');document.querySelectorAll('.copy-dot').forEach(d=>d.onclick=()=>{copyIdx=+d.dataset.i;renderCopySlide();});}
function updateCopyDots(){document.querySelectorAll('.copy-dot').forEach((d,i)=>{d.classList.toggle('on',i===copyIdx);d.classList.toggle('done',copied[i]);});}

// åªè¤‡è£½æ¨™é¡Œï¼ˆè²¼åˆ° Canva å¾Œè¨­ 56ptï¼‰
async function copyTitle(){
    const s=slides[copyIdx];
    let txt=s.title;
    if(s.subtitle)txt+='\n'+s.subtitle;
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast(`âœ… æ¨™é¡Œå·²è¤‡è£½ â†’ è²¼åˆ° Canva è¨­ 56pt`,'ok');
    document.getElementById('copyTitleBtn').textContent='âœ… å·²è¤‡è£½';
    setTimeout(()=>{document.getElementById('copyTitleBtn').textContent='ğŸ“‹ æ¨™é¡Œ (56pt)';},2000);
}

// åªè¤‡è£½å…§å®¹ï¼ˆè²¼åˆ° Canva å¾Œè¨­ 24ptï¼‰
async function copyContent(){
    const s=slides[copyIdx];
    const txt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast(`âœ… å…§å®¹å·²è¤‡è£½ â†’ è²¼åˆ° Canva è¨­ 24pt`,'ok');
    document.getElementById('copyContentBtn').textContent='âœ… å·²è¤‡è£½';
    setTimeout(()=>{document.getElementById('copyContentBtn').textContent='ğŸ“‹ å…§å®¹ (24pt)';},2000);
}

// æ•´é è¤‡è£½
async function copySlide(){
    const s=slides[copyIdx];
    const titleTxt=s.title+(s.subtitle?'\n'+s.subtitle:'');
    const contentTxt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
    const txt=titleTxt+'\n\n'+contentTxt;
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    copied[copyIdx]=true;
    toast(`âœ… ç¬¬ ${s.number} é æ•´é è¤‡è£½`,'ok');
    renderCopySlide();
    if(copyIdx<slides.length-1)setTimeout(()=>{copyIdx++;renderCopySlide();},800);
}
function prevSlide(){if(copyIdx>0){copyIdx--;renderCopySlide();}}
function nextSlide(){if(copyIdx<slides.length-1){copyIdx++;renderCopySlide();}}
async function copyAll(){
    const txt=slides.map(s=>{
        const titleTxt=s.title+(s.subtitle?'\n'+s.subtitle:'');
        const contentTxt=Array.isArray(s.content)?s.content.map(c=>'â€¢ '+c).join('\n'):s.content||'';
        return `â•â•â• ç¬¬ ${s.number} é  â•â•â•\n\n${titleTxt}\n\n${contentTxt}`;
    }).join('\n\n\n');
    try{await navigator.clipboard.writeText(txt);}catch(e){const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
    toast('âœ… å…¨éƒ¨å·²è¤‡è£½','ok');
    copied=copied.map(()=>true);
    updateCopyDots();
}

// HTML æ’­æ”¾
function openHtml(){
    if(!slides||!slides.length){toast('âŒ è«‹å…ˆç”¢ç”Ÿç°¡å ±','warn');return;}
    if(!animations||!animations.length){toast('âŒ å‹•ç•«è³‡æ–™éŒ¯èª¤','err');return;}
    toast('ğŸŒ è¼‰å…¥å‹•ç•«æ’­æ”¾...','warn');
    ssIdx=0;ssItemIdx=-1;
    const pack=animPacks[animTheme]||animPacks.random;
    try{
        slideAnims=slides.map(s=>{
            const items=Array.isArray(s.content)?s.content.length:s.content?1:0;
            const rnd=()=>pack[Math.floor(Math.random()*pack.length)];
            return{title:rnd(),subtitle:rnd(),items:Array(items).fill(0).map(()=>rnd())};
        });
        renderSS();
        document.getElementById('htmlModal').classList.add('on');
        document.getElementById('ssTimer').classList.remove('on','warn','danger');
        if(timerRunning){clearInterval(timerInterval);timerRunning=false;}
    }catch(e){
        console.error('openHtml error:',e);
        toast('âŒ è¼‰å…¥å¤±æ•—ï¼š'+e.message,'err');
    }
}
function closeHtml(){
    document.getElementById('htmlModal').classList.remove('on');
    if(timerRunning){clearInterval(timerInterval);timerRunning=false;}
    if(voiceEnabled)speechSynthesis.cancel();
}

function renderSS(){
    try{
        const theme=themes.find(t=>t.id===themeId)||themes[0];
        let slidesHtml=slides.map((s,i)=>{
            const anim=slideAnims[i]||{title:0,subtitle:0,items:[]};
            const titleAnim=animations[anim.title]||animations[0];
            const subAnim=animations[anim.subtitle]||animations[0];
            
            // æœ‰åœ–ç‰‡ï¼šå·¦åœ–å³æ–‡ä½ˆå±€ï¼ˆæœ‰å‹•ç•«ï¼‰
            if(s.image && s.type!=='å°é¢' && s.type!=='ç¸½çµ'){
                let textItems='';
                if(Array.isArray(s.content)){
                    textItems=s.content.map((c,j)=>{
                        const itemAnim=animations[anim.items[j]]||animations[0];
                        return `<div class="ss-text-item" data-idx="${j}" style="${itemAnim.style}" data-show="${itemAnim.show}">â€¢ ${esc(c)}</div>`;
                    }).join('');
                }else if(s.content){
                    const itemAnim=animations[anim.items[0]]||animations[0];
                    textItems=`<div class="ss-text-item" data-idx="0" style="${itemAnim.style}" data-show="${itemAnim.show}">${esc(s.content)}</div>`;
                }
                return `<div class="ss-slide ${i===0?'on':''}" style="background:${theme.css};color:#fff" data-i="${i}">
                    <div class="ss-title" style="${titleAnim.style}" data-show="${titleAnim.show}">${esc(s.title||'')}</div>
                    <div class="ss-with-image">
                        <div class="ss-image-left"><img src="${s.image}"></div>
                        <div class="ss-content-right">${textItems}</div>
                    </div>
                    <div class="ss-num">${s.number||i+1}/${slides.length}</div>
                    <div class="ss-hint">é»æ“Š = ä¸‹ä¸€æ®µ</div>
                </div>`;
            }
            
            // ç„¡åœ–ç‰‡ï¼šåŸæœ¬ä½ˆå±€ï¼ˆæœ‰å‹•ç•«ï¼‰
            let items='';
            if(Array.isArray(s.content)){
                items=s.content.map((c,j)=>{
                    const itemAnim=animations[anim.items[j]]||animations[0];
                    return `<div class="ss-item" data-idx="${j}" style="${itemAnim.style}" data-show="${itemAnim.show}">â€¢ ${esc(c)}</div>`;
                }).join('');
            }else if(s.content){
                const itemAnim=animations[anim.items[0]]||animations[0];
                items=`<div class="ss-item" data-idx="0" style="${itemAnim.style}" data-show="${itemAnim.show}">${esc(s.content)}</div>`;
            }
            
            return `<div class="ss-slide ${i===0?'on':''}" style="background:${theme.css};color:#fff" data-i="${i}">
                <div class="ss-title" style="${titleAnim.style}" data-show="${titleAnim.show}">${esc(s.title||'')}</div>
                ${s.subtitle?`<div class="ss-subtitle" style="${subAnim.style}" data-show="${subAnim.show}">${esc(s.subtitle)}</div>`:''}
                <div class="ss-content">${items}</div>
                <div class="ss-num">${s.number||i+1}/${slides.length}</div>
                <div class="ss-hint">é»æ“Š = ä¸‹ä¸€æ®µ</div>
            </div>`;
        }).join('');
        slidesHtml+=`<div class="ss-timer-fs" id="ssTimerFS"></div>`;
        document.getElementById('slideshow').innerHTML=slidesHtml;
        updateSS();
        toast('âœ… ç°¡å ±å·²è¼‰å…¥','ok');
    }catch(e){
        console.error('renderSS error:',e);
        toast('âŒ ç°¡å ±æ¸²æŸ“å¤±æ•—','err');
    }
}

function updateSS(){
    document.querySelectorAll('.ss-slide').forEach((s,i)=>s.classList.toggle('on',i===ssIdx));
    document.getElementById('ssCounter').textContent=`${ssIdx+1}/${slides.length}`;
    ssItemIdx=-1;
    if(voiceEnabled&&slides&&slides[ssIdx])speakSlide(slides[ssIdx]);
}

function ssNextItem(){
    const slide=document.querySelector(`.ss-slide[data-i="${ssIdx}"]`);
    if(!slide)return;
    const title=slide.querySelector('.ss-title');
    const subtitle=slide.querySelector('.ss-subtitle');
    const items=slide.querySelectorAll('.ss-item, .ss-text-item');
    ssItemIdx++;
    if(ssItemIdx===0){
        if(title){title.style.cssText=title.dataset.show;}
    }else if(ssItemIdx===1&&subtitle){
        subtitle.style.cssText=subtitle.dataset.show;
    }else{
        const itemIdx=subtitle?ssItemIdx-2:ssItemIdx-1;
        if(itemIdx<items.length){
            items[itemIdx].style.cssText=items[itemIdx].dataset.show;
        }else{
            if(ssIdx<slides.length-1){ssIdx++;updateSS();}
        }
    }
}

function ssPrev(){if(ssIdx>0){ssIdx--;updateSS();}}
function ssNext(){if(ssIdx<slides.length-1){ssIdx++;updateSS();}}
function ssFullscreen(){
    const el=document.getElementById('slideshow');
    // å˜—è©¦å„ç¨®å…¨è¢å¹• API
    if(el.requestFullscreen){
        el.requestFullscreen().catch(()=>mobileFullscreen());
    }else if(el.webkitRequestFullscreen){
        el.webkitRequestFullscreen();
    }else if(el.webkitEnterFullscreen){
        el.webkitEnterFullscreen();
    }else if(document.documentElement.webkitRequestFullscreen){
        document.documentElement.webkitRequestFullscreen();
    }else{
        mobileFullscreen();
    }
}
function mobileFullscreen(){
    const modal=document.getElementById('htmlModal');
    if(modal.classList.contains('mobile-fs')){
        modal.classList.remove('mobile-fs');
        document.body.style.overflow='';
        toast('ğŸ“± é€€å‡ºå…¨è¢å¹•','ok');
    }else{
        modal.classList.add('mobile-fs');
        document.body.style.overflow='hidden';
        toast('ğŸ“± å…¨è¢å¹•æ¨¡å¼ - å·¦å³æ»‘å‹•æ›é ','ok');
        setupTouchGestures();
    }
}

// è§¸æ§æ‰‹å‹¢æ”¯æ´
let touchStartX=0,touchStartY=0;
function setupTouchGestures(){
    const slideshow=document.getElementById('slideshow');
    if(!slideshow)return;
    
    slideshow.ontouchstart=(e)=>{
        touchStartX=e.touches[0].clientX;
        touchStartY=e.touches[0].clientY;
    };
    slideshow.ontouchend=(e)=>{
        const touchEndX=e.changedTouches[0].clientX;
        const touchEndY=e.changedTouches[0].clientY;
        const diffX=touchEndX-touchStartX;
        const diffY=touchEndY-touchStartY;
        
        // æ°´å¹³æ»‘å‹•è¶…é 50px ä¸”å¤§æ–¼å‚ç›´æ»‘å‹•
        if(Math.abs(diffX)>50 && Math.abs(diffX)>Math.abs(diffY)){
            if(diffX>0){
                ssPrev(); // å³æ»‘ = ä¸Šä¸€é 
            }else{
                ssNextItem(); // å·¦æ»‘ = ä¸‹ä¸€æ®µ/ä¸‹ä¸€é 
            }
        }
        // é»æ“Šï¼ˆæ»‘å‹•å°æ–¼ 10pxï¼‰= ä¸‹ä¸€æ®µ
        else if(Math.abs(diffX)<10 && Math.abs(diffY)<10){
            ssNextItem();
        }
    };
}

function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function toast(m,t='ok'){const el=document.createElement('div');el.className='toast '+t;el.innerHTML=m;document.getElementById('toastBox').appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),300);},2500);}


document.querySelectorAll('.modal-bg').forEach(m=>m.onclick=e=>{if(e.target===m)m.classList.remove('on');});

document.addEventListener('keydown',e=>{
    if(!document.getElementById('htmlModal').classList.contains('on'))return;
    if(e.key===' '){e.preventDefault();ssNextItem();}
    if(e.key==='ArrowRight'){e.preventDefault();ssNextItem();}
    if(e.key==='ArrowLeft'){e.preventDefault();ssPrev();}
    if(e.key==='ArrowDown'){e.preventDefault();ssNext();}
});

document.getElementById('slideshow')?.addEventListener('click',ssNextItem);

// ===== v10 æ–°åŠŸèƒ½ =====

// ğŸ“¤ åŒ¯å‡º PDF
function exportPDF(){
    if(!slides||!slides.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    toast('ğŸ“¤ ç”¢ç”Ÿ PDF...','warn');
    toast('ğŸ“¤ ç”¢ç”Ÿ PDF ä¸­...','warn');
    const win=window.open('','_blank');
    const theme=themes.find(t=>t.id===themeId)||themes[0];
    let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${topic}</title>
<style>
@page{size:landscape;margin:0}
body{margin:0;font-family:'Noto Sans TC',sans-serif}
.slide{width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;page-break-after:always;padding:40px;box-sizing:border-box}
.cover{background:linear-gradient(135deg,#${theme.c1},#${theme.c2});color:#fff;text-align:center}
.cover h1{font-size:48px;margin:0}
.cover p{font-size:24px;opacity:0.8;margin-top:16px}
.content{background:#fff}
.content h2{color:#${theme.c1};font-size:32px;margin-bottom:24px;padding-bottom:12px;border-bottom:3px solid #${theme.c2}}
.content ul{font-size:20px;line-height:2}
.summary{background:linear-gradient(135deg,#${theme.c1},#${theme.c2});color:#fff}
.summary h2{font-size:36px;margin-bottom:20px}
.summary ul{font-size:18px;line-height:2;list-style:none;padding:0}
.summary li::before{content:'âœ“ '}
.num{position:absolute;bottom:20px;right:30px;font-size:14px;opacity:0.5}
</style></head><body>`;
    slides.forEach(s=>{
        if(s.type==='å°é¢'){
            html+=`<div class="slide cover"><h1>${esc(s.title)}</h1>${s.subtitle?`<p>${esc(s.subtitle)}</p>`:''}<span class="num">${s.number}</span></div>`;
        }else if(s.type==='ç¸½çµ'){
            html+=`<div class="slide summary"><h2>${esc(s.title)}</h2><ul>${Array.isArray(s.content)?s.content.map(c=>`<li>${esc(c)}</li>`).join(''):''}</ul><span class="num">${s.number}</span></div>`;
        }else{
            html+=`<div class="slide content"><h2>${esc(s.title)}</h2><ul>${Array.isArray(s.content)?s.content.map(c=>`<li>${esc(c)}</li>`).join(''):''}</ul><span class="num">${s.number}</span></div>`;
        }
    });
    html+=`</body></html>`;
    win.document.write(html);
    win.document.close();
    setTimeout(()=>{win.print();toast('âœ… è«‹é¸æ“‡ã€Œå¦å­˜ç‚º PDFã€','ok');},500);
}

// ğŸ“‹ è¤‡è£½å…¨éƒ¨æ–‡å­—
function copyAllText(){
    if(!slides||!slides.length){toast('âŒ ç„¡ç°¡å ±','err');return;}
    toast('ğŸ“‹ è¤‡è£½ä¸­...','warn');
    let txt=`ã€${topic}ã€‘\n\n`;
    slides.forEach(s=>{
        txt+=`--- ç¬¬ ${s.number} é ï¼š${s.title} ---\n`;
        if(s.subtitle)txt+=s.subtitle+'\n';
        if(Array.isArray(s.content))txt+=s.content.map(c=>'â€¢ '+c).join('\n')+'\n';
        else if(s.content)txt+=s.content+'\n';
        if(s.notes)txt+='å‚™è¨»ï¼š'+s.notes+'\n';
        txt+='\n';
    });
    navigator.clipboard.writeText(txt).then(()=>toast('âœ… å·²è¤‡è£½å…¨éƒ¨æ–‡å­—','ok')).catch(()=>toast('âŒ è¤‡è£½å¤±æ•—','err'));
}

// ğŸ¯ è‡ªå‹•ç”Ÿæˆæ¸¬é©—
let quizData=[];
async function generateQuiz(){
    if(!slides||!slides.length){toast('âŒ è«‹å…ˆç”¢ç”Ÿç°¡å ±','warn');return;}
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹è¼¸å…¥ API Key','warn');return;}
    
    toast('ğŸ¯ ç”¢ç”Ÿæ¸¬é©—ä¸­...','warn');
    try{
        const content=slides.map(s=>s.title+(Array.isArray(s.content)?': '+s.content.join(', '):'')).join('\n');
        const prompt=`æ ¹æ“šä»¥ä¸‹ç°¡å ±å…§å®¹ï¼Œç”¢ç”Ÿ5é¡Œé¸æ“‡é¡Œæ¸¬é©—ï¼š

${content}

è«‹ç”¨ JSON æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{"questions":[{"q":"é¡Œç›®","opts":["é¸é …A","é¸é …B","é¸é …C","é¸é …D"],"ans":0}]}
ans æ˜¯æ­£ç¢ºç­”æ¡ˆçš„ç´¢å¼•ï¼ˆ0-3ï¼‰
åªå›å‚³ JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—`;
        
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiKey,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.7,maxOutputTokens:2000}})
        });
        if(!r.ok)throw new Error('APIéŒ¯èª¤');
        const txt=(await r.json()).candidates[0].content.parts[0].text;
        const m=txt.match(/\{[\s\S]*\}/);
        if(m){
            const data=JSON.parse(m[0]);
            quizData=data.questions||[];
            renderQuiz();
            document.getElementById('quizModal').classList.add('on');
        }
    }catch(e){toast('âŒ '+e.message,'err');}
}
function renderQuiz(){
    document.getElementById('quizContent').innerHTML=quizData.map((q,i)=>`
        <div class="quiz-q" data-idx="${i}">
            <div class="quiz-q-title">${i+1}. ${esc(q.q)}</div>
            <div class="quiz-opts">
                ${q.opts.map((o,j)=>`<div class="quiz-opt" data-opt="${j}" onclick="selectOpt(${i},${j})">${esc(o)}</div>`).join('')}
            </div>
        </div>
    `).join('');
}
function selectOpt(qIdx,optIdx){
    document.querySelectorAll(`.quiz-q[data-idx="${qIdx}"] .quiz-opt`).forEach(o=>o.classList.remove('selected'));
    document.querySelector(`.quiz-q[data-idx="${qIdx}"] .quiz-opt[data-opt="${optIdx}"]`).classList.add('selected');
    document.querySelector(`.quiz-q[data-idx="${qIdx}"] .quiz-opt[data-opt="${optIdx}"]`).style.borderColor='var(--cyan)';
}
function submitQuiz(){
    let score=0;
    quizData.forEach((q,i)=>{
        const selected=document.querySelector(`.quiz-q[data-idx="${i}"] .quiz-opt.selected`);
        const correct=document.querySelector(`.quiz-q[data-idx="${i}"] .quiz-opt[data-opt="${q.ans}"]`);
        correct.classList.add('correct');
        if(selected){
            const selIdx=parseInt(selected.dataset.opt);
            if(selIdx===q.ans)score++;
            else selected.classList.add('wrong');
        }
    });
    document.getElementById('quizContent').innerHTML=`<div class="quiz-score">${score}/${quizData.length}</div><p style="text-align:center;color:var(--text-secondary)">ç­”å° ${score} é¡Œï¼Œå…± ${quizData.length} é¡Œ</p>`+document.getElementById('quizContent').innerHTML;
    toast(`ğŸ¯ å¾—åˆ†ï¼š${score}/${quizData.length}`,'ok');
}
function closeQuiz(){document.getElementById('quizModal').classList.remove('on');}

// ğŸ¨ è‡ªè¨‚é…è‰²
function applyCustomColors(){
    const c1=document.getElementById('customColor1').value.replace('#','');
    const c2=document.getElementById('customColor2').value.replace('#','');
    themes.push({id:'custom',name:'è‡ªè¨‚',c1:c1,c2:c2,css:'linear-gradient(135deg,#'+c1+',#'+c2+')'});
    themeId='custom';
    renderThemes();
    toast('ğŸ¨ å·²å¥—ç”¨è‡ªè¨‚é…è‰²','ok');
}

// ğŸŒ™ æ·±æ·ºä¸»é¡Œ
function setThemeMode(mode){
    document.body.classList.remove('light','dark');
    if(mode==='light')document.body.classList.add('light');
    document.querySelectorAll('#themeMode .chip').forEach(c=>c.classList.toggle('on',c.dataset.v===mode));
    localStorage.setItem('sg_theme',mode);
    toast(mode==='light'?'â˜€ï¸ æ·ºè‰²ä¸»é¡Œ':'ğŸŒ™ æ·±è‰²ä¸»é¡Œ','ok');
}

// ğŸ¬ å‹•ç•«ä¸»é¡ŒåŒ…
function setAnimTheme(t){
    animTheme=t;
    document.querySelectorAll('#animTheme .chip').forEach(c=>c.classList.toggle('on',c.dataset.v===t));
    toast('ğŸ¬ å‹•ç•«ä¸»é¡Œï¼š'+{random:'éš¨æ©Ÿ',tech:'ç§‘æŠ€',cute:'å¯æ„›',formal:'æ­£å¼'}[t],'ok');
}

// â±ï¸ å€’æ•¸è¨ˆæ™‚
let timerInterval=null;
let timerSeconds=0;
let timerRunning=false;
function toggleTimer(){
    const el=document.getElementById('ssTimer');
    const elFS=document.getElementById('ssTimerFS');
    const btn=document.getElementById('timerBtn');
    if(timerRunning){
        clearInterval(timerInterval);
        timerRunning=false;
        el.classList.remove('on');
        if(elFS)elFS.classList.remove('on');
        btn.textContent='â±ï¸ é–‹å§‹è¨ˆæ™‚';
        toast('â±ï¸ è¨ˆæ™‚å™¨å·²åœæ­¢','ok');
    }else{
        timerSeconds=parseInt(document.getElementById('timerMinutes').value||5)*60;
        timerRunning=true;
        el.classList.add('on');
        if(elFS)elFS.classList.add('on');
        btn.textContent='â±ï¸ åœæ­¢è¨ˆæ™‚';
        updateTimerDisplay();
        timerInterval=setInterval(()=>{
            timerSeconds--;
            updateTimerDisplay();
            if(timerSeconds<=0){
                clearInterval(timerInterval);
                timerRunning=false;
                el.classList.add('danger');
                if(elFS)elFS.classList.add('danger');
                btn.textContent='â±ï¸ é–‹å§‹è¨ˆæ™‚';
                toast('â° æ™‚é–“åˆ°ï¼','warn');
            }
        },1000);
        toast('â±ï¸ è¨ˆæ™‚å™¨é–‹å§‹','ok');
    }
}
function updateTimerDisplay(){
    const el=document.getElementById('ssTimer');
    const elFS=document.getElementById('ssTimerFS');
    const m=Math.floor(timerSeconds/60);
    const s=timerSeconds%60;
    const txt=m+':'+(s<10?'0':'')+s;
    el.textContent=txt;
    if(elFS)elFS.textContent=txt;
    el.classList.remove('warn','danger');
    if(elFS)elFS.classList.remove('warn','danger');
    if(timerSeconds<=60){el.classList.add('warn');if(elFS)elFS.classList.add('warn');}
    if(timerSeconds<=10){el.classList.add('danger');if(elFS)elFS.classList.add('danger');}
}

// ğŸ”Š èªéŸ³æ’­æ”¾
let voiceEnabled=false;
let voicePaused=false;
function toggleVoice(){
    voiceEnabled=!voiceEnabled;
    const voiceBtn=document.getElementById('voiceBtn');
    const pauseBtn=document.getElementById('pauseBtn');
    const stopBtn=document.getElementById('stopBtn');
    if(voiceEnabled){
        voiceBtn.textContent='ğŸ”Š èªéŸ³é–‹';
        voiceBtn.style.background='var(--grad-green)';
        voiceBtn.style.color='#030614';
        pauseBtn.style.display='inline-block';
        stopBtn.style.display='inline-block';
        toast('ğŸ”Š èªéŸ³å·²é–‹å•Ÿ','ok');
        if(slides&&slides[ssIdx])speakSlide(slides[ssIdx]);
    }else{
        voiceBtn.textContent='ğŸ”Š èªéŸ³';
        voiceBtn.style.background='';
        voiceBtn.style.color='';
        pauseBtn.style.display='none';
        stopBtn.style.display='none';
        speechSynthesis.cancel();
        toast('ğŸ”‡ èªéŸ³å·²é—œé–‰','ok');
    }
}
function pauseVoice(){
    if(!('speechSynthesis' in window))return;
    const btn=document.getElementById('pauseBtn');
    if(speechSynthesis.paused){
        speechSynthesis.resume();
        btn.textContent='â¸ï¸ æš«åœ';
        voicePaused=false;
    }else{
        speechSynthesis.pause();
        btn.textContent='â–¶ï¸ ç¹¼çºŒ';
        voicePaused=true;
    }
}
function stopVoice(){
    if(!('speechSynthesis' in window))return;
    speechSynthesis.cancel();
    document.getElementById('pauseBtn').textContent='â¸ï¸ æš«åœ';
    voicePaused=false;
    toast('â¹ï¸ èªéŸ³å·²åœæ­¢','ok');
}
function speakSlide(s){
    if(!voiceEnabled||!('speechSynthesis' in window))return;
    speechSynthesis.cancel();
    let txt=s.title;
    if(Array.isArray(s.content))txt+='. '+s.content.join('. ');
    const u=new SpeechSynthesisUtterance(txt);
    u.lang='zh-TW';
    u.rate=0.9;
    speechSynthesis.speak(u);
    document.getElementById('pauseBtn').textContent='â¸ï¸ æš«åœ';
    voicePaused=false;
}

// ===== PDF å·¥å…·ç®± =====
let pdfDoc=null,pdfFileName='',splitMode='each';

function openPdfTools(){document.getElementById('pdfToolsModal').classList.add('on');}
function closePdfTools(){document.getElementById('pdfToolsModal').classList.remove('on');document.getElementById('pdfToolStatus').classList.remove('on');}
function closePdfSplit(){document.getElementById('pdfSplitModal').classList.remove('on');}

function setSplitMode(mode){
    splitMode=mode;
    document.querySelectorAll('#splitModeChips .chip').forEach(c=>c.classList.toggle('on',c.dataset.v===mode));
    document.getElementById('splitRangeInput').style.display=mode==='range'?'block':'none';
    document.getElementById('splitCountInput').style.display=mode==='count'?'block':'none';
}

// ä¸Šå‚³ PDF é€²è¡Œåˆ†å‰²
async function handlePdfUpload(input){
    const file=input.files[0];
    if(!file)return;
    input.value='';
    pdfFileName=file.name.replace('.pdf','');
    
    const status=document.getElementById('pdfToolStatus');
    status.classList.add('on');
    status.innerHTML='â³ è®€å– PDF ä¸­...';
    
    try{
        const arrayBuffer=await file.arrayBuffer();
        pdfDoc=await PDFLib.PDFDocument.load(arrayBuffer);
        const pageCount=pdfDoc.getPageCount();
        
        document.getElementById('pdfSplitInfo').innerHTML=`ğŸ“„ <strong>${file.name}</strong><br>å…± ${pageCount} é ï¼Œæª”æ¡ˆå¤§å° ${(file.size/1024/1024).toFixed(2)} MB`;
        status.classList.remove('on');
        closePdfTools();
        document.getElementById('pdfSplitModal').classList.add('on');
    }catch(e){
        status.innerHTML='âŒ PDF è®€å–å¤±æ•—ï¼š'+e.message;
    }
}

// åŸ·è¡Œåˆ†å‰²
async function executePdfSplit(){
    if(!pdfDoc){toast('âŒ è«‹å…ˆä¸Šå‚³ PDF','err');return;}
    toast('âœ‚ï¸ åˆ†å‰²ä¸­...','warn');
    
    try{
        const pageCount=pdfDoc.getPageCount();
        const pdfs=[];
        
        if(splitMode==='each'){
            // æ¯é ä¸€æª”
            for(let i=0;i<pageCount;i++){
                const newPdf=await PDFLib.PDFDocument.create();
                const [page]=await newPdf.copyPages(pdfDoc,[i]);
                newPdf.addPage(page);
                pdfs.push({name:`${pdfFileName}_ç¬¬${i+1}é .pdf`,doc:newPdf});
            }
        }else if(splitMode==='range'){
            // æŒ‡å®šç¯„åœ
            const ranges=document.getElementById('splitRange').value.split(',').map(r=>r.trim());
            for(const range of ranges){
                const newPdf=await PDFLib.PDFDocument.create();
                if(range.includes('-')){
                    const [start,end]=range.split('-').map(n=>parseInt(n));
                    const indices=[];
                    for(let i=start-1;i<end&&i<pageCount;i++)indices.push(i);
                    const pages=await newPdf.copyPages(pdfDoc,indices);
                    pages.forEach(p=>newPdf.addPage(p));
                    pdfs.push({name:`${pdfFileName}_${start}-${end}.pdf`,doc:newPdf});
                }else{
                    const idx=parseInt(range)-1;
                    if(idx>=0&&idx<pageCount){
                        const [page]=await newPdf.copyPages(pdfDoc,[idx]);
                        newPdf.addPage(page);
                        pdfs.push({name:`${pdfFileName}_ç¬¬${range}é .pdf`,doc:newPdf});
                    }
                }
            }
        }else if(splitMode==='count'){
            // æ¯ N é 
            const n=parseInt(document.getElementById('splitCount').value)||5;
            for(let i=0;i<pageCount;i+=n){
                const newPdf=await PDFLib.PDFDocument.create();
                const indices=[];
                for(let j=i;j<i+n&&j<pageCount;j++)indices.push(j);
                const pages=await newPdf.copyPages(pdfDoc,indices);
                pages.forEach(p=>newPdf.addPage(p));
                pdfs.push({name:`${pdfFileName}_${i+1}-${Math.min(i+n,pageCount)}.pdf`,doc:newPdf});
            }
        }
        
        // ä¸‹è¼‰æ‰€æœ‰æª”æ¡ˆ
        for(const pdf of pdfs){
            const bytes=await pdf.doc.save();
            const blob=new Blob([bytes],{type:'application/pdf'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download=pdf.name;
            document.body.appendChild(a);a.click();document.body.removeChild(a);
            URL.revokeObjectURL(url);
            await new Promise(r=>setTimeout(r,300));
        }
        
        toast(`âœ… å·²åˆ†å‰²æˆ ${pdfs.length} å€‹æª”æ¡ˆ`,'ok');
        closePdfSplit();
    }catch(e){
        console.error(e);
        toast('âŒ åˆ†å‰²å¤±æ•—ï¼š'+e.message,'err');
    }
}

// åˆä½µ PDF
async function handlePdfMerge(input){
    const files=Array.from(input.files);
    if(files.length<2){toast('âŒ è«‹é¸æ“‡è‡³å°‘ 2 å€‹ PDF','warn');return;}
    input.value='';
    
    const status=document.getElementById('pdfToolStatus');
    status.classList.add('on');
    status.innerHTML=`â³ åˆä½µ ${files.length} å€‹ PDF ä¸­...`;
    
    try{
        const mergedPdf=await PDFLib.PDFDocument.create();
        
        for(let i=0;i<files.length;i++){
            status.innerHTML=`â³ è™•ç†ç¬¬ ${i+1}/${files.length} å€‹æª”æ¡ˆ...`;
            const arrayBuffer=await files[i].arrayBuffer();
            const pdf=await PDFLib.PDFDocument.load(arrayBuffer);
            const pages=await mergedPdf.copyPages(pdf,pdf.getPageIndices());
            pages.forEach(p=>mergedPdf.addPage(p));
        }
        
        const bytes=await mergedPdf.save();
        const blob=new Blob([bytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download='åˆä½µæª”æ¡ˆ.pdf';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        status.innerHTML=`âœ… å·²åˆä½µ ${files.length} å€‹ PDFï¼ˆå…± ${mergedPdf.getPageCount()} é ï¼‰`;
        toast('âœ… PDF åˆä½µå®Œæˆ','ok');
    }catch(e){
        status.innerHTML='âŒ åˆä½µå¤±æ•—ï¼š'+e.message;
    }
}

// æå–æ–‡å­—
function startPdfExtract(){
    closePdfTools();
    const input=document.createElement('input');
    input.type='file';input.accept='.pdf';
    input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file)return;
        toast('ğŸ“ æå–æ–‡å­—ä¸­...','warn');
        try{
            if(typeof pdfjsLib==='undefined'){toast('âŒ PDF å‡½å¼åº«æœªè¼‰å…¥','err');return;}
            pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const arrayBuffer=await file.arrayBuffer();
            const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
            let txt='';
            for(let i=1;i<=pdf.numPages;i++){
                const page=await pdf.getPage(i);
                const content=await page.getTextContent();
                txt+=`=== ç¬¬ ${i} é  ===\n`+content.items.map(x=>x.str).join(' ')+'\n\n';
            }
            // ä¸‹è¼‰æ–‡å­—æª”
            const blob=new Blob([txt],{type:'text/plain'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download=file.name.replace('.pdf','.txt');
            document.body.appendChild(a);a.click();document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toast(`âœ… å·²æå– ${pdf.numPages} é æ–‡å­—`,'ok');
        }catch(err){toast('âŒ '+err.message,'err');}
    };
    input.click();
}

// æå–é é¢
function startPdfPageExtract(){
    closePdfTools();
    const input=document.createElement('input');
    input.type='file';input.accept='.pdf';
    input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file)return;
        const range=prompt(`è¼¸å…¥è¦æå–çš„é é¢ï¼ˆä¾‹ï¼š1-3, 5, 7-10ï¼‰\næª”æ¡ˆï¼š${file.name}`);
        if(!range)return;
        toast('ğŸ“„ æå–é é¢ä¸­...','warn');
        try{
            const arrayBuffer=await file.arrayBuffer();
            const srcPdf=await PDFLib.PDFDocument.load(arrayBuffer);
            const newPdf=await PDFLib.PDFDocument.create();
            const pageCount=srcPdf.getPageCount();
            
            const ranges=range.split(',').map(r=>r.trim());
            const indices=[];
            for(const r of ranges){
                if(r.includes('-')){
                    const [start,end]=r.split('-').map(n=>parseInt(n));
                    for(let i=start-1;i<end&&i<pageCount;i++)if(i>=0)indices.push(i);
                }else{
                    const idx=parseInt(r)-1;
                    if(idx>=0&&idx<pageCount)indices.push(idx);
                }
            }
            
            const pages=await newPdf.copyPages(srcPdf,indices);
            pages.forEach(p=>newPdf.addPage(p));
            
            const bytes=await newPdf.save();
            const blob=new Blob([bytes],{type:'application/pdf'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download=file.name.replace('.pdf','_æå–.pdf');
            document.body.appendChild(a);a.click();document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toast(`âœ… å·²æå– ${indices.length} é `,'ok');
        }catch(err){toast('âŒ '+err.message,'err');}
    };
    input.click();
}

// ğŸ–¼ï¸ æå– PDF åœ–ç‰‡
let extractedImages=[];
async function startPdfImageExtract(){
    closePdfTools();
    const input=document.createElement('input');
    input.type='file';input.accept='.pdf';
    input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file)return;
        toast('ğŸ–¼ï¸ æå–åœ–ç‰‡ä¸­...','warn');
        try{
            extractedImages=await extractPdfImages(file);
            if(extractedImages.length===0){
                toast('âš ï¸ æœªæ‰¾åˆ°åœ–ç‰‡ï¼Œå˜—è©¦é é¢æˆªåœ–...','warn');
                extractedImages=await extractPdfPages(file);
            }
            if(extractedImages.length>0){
                showExtractedImages(file.name);
            }else{
                toast('âŒ ç„¡æ³•æå–åœ–ç‰‡','err');
            }
        }catch(err){
            console.error(err);
            toast('âŒ '+err.message,'err');
        }
    };
    input.click();
}

// å¾ PDF æå–åµŒå…¥åœ–ç‰‡
async function extractPdfImages(file){
    const images=[];
    try{
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const arrayBuffer=await file.arrayBuffer();
        const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
        const totalPages=Math.min(pdf.numPages,100);
        
        for(let i=1;i<=totalPages;i++){
            if(i%10===0||i===1)toast(`ğŸ–¼ï¸ æƒæç¬¬ ${i}/${totalPages} é ...`,'warn');
            const page=await pdf.getPage(i);
            const ops=await page.getOperatorList();
            
            for(let j=0;j<ops.fnArray.length;j++){
                if(ops.fnArray[j]===pdfjsLib.OPS.paintImageXObject){
                    const imgName=ops.argsArray[j][0];
                    try{
                        const img=await page.objs.get(imgName);
                        if(img&&img.data){
                            const canvas=document.createElement('canvas');
                            canvas.width=img.width;
                            canvas.height=img.height;
                            const ctx=canvas.getContext('2d');
                            const imgData=ctx.createImageData(img.width,img.height);
                            
                            if(img.data.length===img.width*img.height*4){
                                imgData.data.set(img.data);
                            }else if(img.data.length===img.width*img.height*3){
                                for(let k=0;k<img.width*img.height;k++){
                                    imgData.data[k*4]=img.data[k*3];
                                    imgData.data[k*4+1]=img.data[k*3+1];
                                    imgData.data[k*4+2]=img.data[k*3+2];
                                    imgData.data[k*4+3]=255;
                                }
                            }
                            ctx.putImageData(imgData,0,0);
                            
                            if(img.width>50&&img.height>50){
                                images.push({
                                    page:i,
                                    dataUrl:canvas.toDataURL('image/png'),
                                    width:img.width,
                                    height:img.height
                                });
                            }
                        }
                    }catch(imgErr){}
                }
            }
        }
    }catch(err){console.error('extractPdfImages:',err);}
    return images;
}

// å°‡ PDF é é¢è½‰æˆåœ–ç‰‡ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
async function extractPdfPages(file){
    const images=[];
    try{
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const arrayBuffer=await file.arrayBuffer();
        const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
        const totalPages=Math.min(pdf.numPages,100);
        
        for(let i=1;i<=totalPages;i++){
            if(i%5===0||i===1)toast(`ğŸ“„ è½‰æ›ç¬¬ ${i}/${totalPages} é ...`,'warn');
            const page=await pdf.getPage(i);
            const viewport=page.getViewport({scale:1.5});
            const canvas=document.createElement('canvas');
            canvas.width=viewport.width;
            canvas.height=viewport.height;
            const ctx=canvas.getContext('2d');
            
            await page.render({canvasContext:ctx,viewport:viewport}).promise;
            images.push({
                page:i,
                dataUrl:canvas.toDataURL('image/jpeg',0.8),
                width:viewport.width,
                height:viewport.height
            });
        }
    }catch(err){console.error('extractPdfPages:',err);}
    return images;
}

// é¡¯ç¤ºæå–çš„åœ–ç‰‡
function showExtractedImages(fileName){
    let html=`<div class="extracted-images-header">
        <h3>ğŸ–¼ï¸ å¾ ${fileName} æå–äº† ${extractedImages.length} å¼µåœ–ç‰‡</h3>
        <div class="extracted-actions">
            <button class="m-btn m-btn-sec" onclick="toggleSelectAll()">â˜‘ï¸ å…¨é¸/å–æ¶ˆ</button>
            <button class="m-btn m-btn-sec" onclick="downloadAllImages()">ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨</button>
            <button class="m-btn m-btn-pri" onclick="startAiAnalyze()">ğŸ¤– AI è½‰ç°¡å ±</button>
        </div>
    </div>
    <div class="extracted-images-grid">`;
    
    extractedImages.forEach((img,i)=>{
        html+=`<div class="extracted-img-card">
            <img src="${img.dataUrl}" onclick="downloadSingleImage(${i})">
            <div class="extracted-img-info">P${img.page}</div>
            <label class="extracted-img-check"><input type="checkbox" checked data-idx="${i}"></label>
        </div>`;
    });
    html+=`</div>`;
    
    document.getElementById('pdfToolResult').innerHTML=html;
    document.getElementById('pdfToolStatus').classList.remove('on');
    openPdfTools();
}

function toggleSelectAll(){
    const checkboxes=document.querySelectorAll('.extracted-img-check input');
    const allChecked=Array.from(checkboxes).every(cb=>cb.checked);
    checkboxes.forEach(cb=>cb.checked=!allChecked);
}

// ä¸‹è¼‰å–®å¼µåœ–ç‰‡
function downloadSingleImage(idx){
    const img=extractedImages[idx];
    const a=document.createElement('a');
    a.href=img.dataUrl;
    a.download=`åœ–ç‰‡_ç¬¬${img.page}é _${idx+1}.png`;
    a.click();
}

// ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡
function downloadAllImages(){
    extractedImages.forEach((img,i)=>{
        setTimeout(()=>{
            const a=document.createElement('a');
            a.href=img.dataUrl;
            a.download=`åœ–ç‰‡_ç¬¬${img.page}é _${i+1}.png`;
            a.click();
        },i*300);
    });
    toast(`ğŸ“¥ ä¸‹è¼‰ ${extractedImages.length} å¼µåœ–ç‰‡`,'ok');
}

// ğŸ¤– AI è§£æåœ–ç‰‡è½‰ç°¡å ±
async function startAiAnalyze(){
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');return;}
    
    const selected=[];
    document.querySelectorAll('.extracted-img-check input:checked').forEach(cb=>{
        selected.push(extractedImages[parseInt(cb.dataset.idx)]);
    });
    
    if(selected.length===0){toast('âŒ è«‹é¸å–è‡³å°‘ä¸€å¼µåœ–ç‰‡','warn');return;}
    
    closePdfTools();
    toast(`ğŸ¤– AI åˆ†æ ${selected.length} å¼µåœ–ç‰‡ä¸­...`,'warn');
    
    const analyses=[];
    let successCount=0;
    
    
    for(let i=0;i<selected.length;i++){
        toast(`ğŸ” åˆ†æç¬¬ ${i+1}/${selected.length} å¼µ...`,'warn');
        const img=selected[i];
        const base64=img.dataUrl.split(',')[1];
        
        let analysisResult=null;
        let retries=0;
        
        while(retries<3){
            try{
                const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiKey,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        contents:[{
                            parts:[
                                {text:'åˆ†æé€™å¼µåœ–ç‰‡ï¼Œç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚å›å‚³ JSON æ ¼å¼ï¼š{"title":"10å­—å…§æ¨™é¡Œ","points":["é‡é»1","é‡é»2","é‡é»3"],"description":"30å­—èªªæ˜"}ã€‚åªå›å‚³JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚'},
                                {inline_data:{mime_type:'image/png',data:base64}}
                            ]
                        }],
                        generationConfig:{temperature:0.4,maxOutputTokens:800}
                    })
                });
                
                const json=await r.json();
                console.log('AI response '+i+':',JSON.stringify(json).substring(0,300));
                
                if(json.candidates && json.candidates[0]){
                    const txt=json.candidates[0].content?.parts?.[0]?.text||'';
                    const cleaned=txt.replace(/```json/g,'').replace(/```/g,'').trim();
                    const m=cleaned.match(/\{[\s\S]*?\}/);
                    if(m){
                        analysisResult=JSON.parse(m[0]);
                        successCount++;
                    }
                    break;
                }else if(json.error && json.error.code===429){
                    retries++;
                    toast(`â³ é…é¡é™åˆ¶ï¼Œç­‰å¾…...`,'warn');
                    await new Promise(r=>setTimeout(r,(5+retries*5)*1000));
                }else{
                    break;
                }
            }catch(err){
                console.error('Error '+i+':',err);
                break;
            }
        }
        
        analyses.push({
            title:analysisResult?.title||`ç¬¬ ${img.page} é `,
            points:analysisResult?.points||['ï¼ˆåœ–ç‰‡å…§å®¹ï¼‰'],
            description:analysisResult?.description||'',
            image:img.dataUrl,
            page:img.page
        });
        
        if((i+1)%14===0 && i<selected.length-1){
            toast(`â³ é¿å…é…é¡é™åˆ¶ï¼Œæš«åœ 10 ç§’...`,'warn');
            await new Promise(r=>setTimeout(r,10000));
        }else{
            await new Promise(r=>setTimeout(r,500));
        }
    }
    
    generateSlidesFromImages(analyses);
    toast(`âœ… å®Œæˆï¼${successCount}/${selected.length} å¼µæˆåŠŸè§£æ`,'ok');
}

// å¾åœ–ç‰‡åˆ†æçµæœç”Ÿæˆç°¡å ±
function generateSlidesFromImages(analyses){
    const topicName=document.getElementById('topicInp').value.trim()||'PDF åœ–ç‰‡ç°¡å ±';
    topic=topicName;
    
    slides=[{
        number:1,
        type:'å°é¢',
        title:topicName,
        subtitle:`å¾ PDF æå– ${analyses.length} å¼µåœ–ç‰‡è£½ä½œ`,
        content:null
    }];
    
    analyses.forEach((a,i)=>{
        slides.push({
            number:i+2,
            type:'å…§å®¹',
            title:a.title||`åœ–ç‰‡ ${i+1}`,
            subtitle:a.description||'',
            content:a.points||[],
            image:a.image,
            imageKeyword:a.title
        });
    });
    
    slides.push({
        number:slides.length+1,
        type:'ç¸½çµ',
        title:'é‡é»å›é¡§',
        content:analyses.slice(0,5).map(a=>a.title)
    });
    
    toast(`âœ… å·²ç”Ÿæˆ ${slides.length} é ç°¡å ±ï¼ˆå«åœ–ç‰‡ï¼‰`,'ok');
    showPreview();
}

// ğŸ¤– ç›´æ¥ AI åœ–ç‰‡è½‰ç°¡å ±ï¼ˆä¸€éµï¼‰
function startPdfToSlides(){
    const apiKey=document.getElementById('apiInp').value.trim();
    if(!apiKey){toast('âŒ è«‹å…ˆè¼¸å…¥ API Key','warn');closePdfTools();return;}
    
    closePdfTools();
    const input=document.createElement('input');
    input.type='file';input.accept='.pdf';
    input.onchange=async(e)=>{
        const file=e.target.files[0];
        if(!file)return;
        
        toast('ğŸ¤– PDF è½‰ç°¡å ±ä¸­ï¼ˆæå–é é¢ï¼‰...','warn');
        try{
            // å…ˆæå–é é¢ç‚ºåœ–ç‰‡
            extractedImages=await extractPdfPages(file);
            
            if(extractedImages.length===0){
                toast('âŒ ç„¡æ³•è®€å– PDF','err');
                return;
            }
            
            // è¨­å®šä¸»é¡Œåç¨±
            const name=file.name.replace('.pdf','');
            document.getElementById('topicInp').value=name;
            
            // åˆ†ææ‰€æœ‰åœ–ç‰‡
            const totalImages=extractedImages.length;
            toast(`ğŸ¤– AI åˆ†æ ${totalImages} å¼µåœ–ç‰‡ä¸­...`,'warn');
            
            const analyses=[];
            let successCount=0;
            // ä½¿ç”¨ gemini-1.5-flash ä¾†åˆ†æåœ–ç‰‡ï¼ˆæœ€ç©©å®šï¼‰
            
            
            for(let i=0;i<totalImages;i++){
                toast(`ğŸ” åˆ†æç¬¬ ${i+1}/${totalImages} å¼µ...`,'warn');
                const img=extractedImages[i];
                const base64=img.dataUrl.split(',')[1];
                
                let analysisResult=null;
                let retries=0;
                const maxRetries=3;
                
                while(retries<maxRetries){
                    try{
                        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiKey,{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({
                                contents:[{
                                    parts:[
                                        {text:'åˆ†æé€™å¼µåœ–ç‰‡ï¼Œç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚å›å‚³ JSON æ ¼å¼ï¼š{"title":"10å­—å…§æ¨™é¡Œ","points":["é‡é»1","é‡é»2","é‡é»3"],"description":"30å­—èªªæ˜"}ã€‚åªå›å‚³JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚'},
                                        {inline_data:{mime_type:'image/jpeg',data:base64}}
                                    ]
                                }],
                                generationConfig:{temperature:0.4,maxOutputTokens:800}
                            })
                        });
                        
                        const json=await r.json();
                        console.log('API response '+i+':',JSON.stringify(json).substring(0,300));
                        
                        if(json.candidates && json.candidates[0]){
                            const txt=json.candidates[0].content?.parts?.[0]?.text||'';
                            const cleaned=txt.replace(/```json/g,'').replace(/```/g,'').trim();
                            const m=cleaned.match(/\{[\s\S]*?\}/);
                            if(m){
                                analysisResult=JSON.parse(m[0]);
                                successCount++;
                            }
                            break;
                        }else if(json.error){
                            if(json.error.code===429){
                                retries++;
                                const waitTime=Math.min(5+retries*5,20);
                                toast(`â³ é…é¡é™åˆ¶ï¼Œç­‰å¾… ${waitTime} ç§’...`,'warn');
                                await new Promise(r=>setTimeout(r,waitTime*1000));
                            }else{
                                console.error('API error:',json.error.message);
                                break;
                            }
                        }
                    }catch(err){
                        console.error('Error '+i+':',err);
                        break;
                    }
                }
                
                analyses.push({
                    title:analysisResult?.title||`ç¬¬ ${img.page} é `,
                    points:analysisResult?.points||['ï¼ˆåœ–ç‰‡å…§å®¹ï¼‰'],
                    description:analysisResult?.description||'',
                    image:img.dataUrl,
                    page:img.page
                });
                
                // æ¯15å¼µæš«åœè¼ƒé•·æ™‚é–“é¿å…é…é¡é™åˆ¶
                if((i+1)%14===0 && i<totalImages-1){
                    toast(`â³ é¿å…é…é¡é™åˆ¶ï¼Œæš«åœ 10 ç§’...`,'warn');
                    await new Promise(r=>setTimeout(r,10000));
                }else{
                    await new Promise(r=>setTimeout(r,500));
                }
            }
            
            generateSlidesFromImages(analyses);
            toast(`âœ… å®Œæˆï¼${successCount}/${totalImages} å¼µæˆåŠŸè§£æ`,'ok');
            
        }catch(err){
            console.error(err);
            toast('âŒ '+err.message,'err');
        }
    };
    input.click();
}

// è¼‰å…¥ä¸»é¡Œè¨­å®š
if(localStorage.getItem('sg_theme')==='light')setThemeMode('light');
</script>
</body>
</html>
